<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="../favicon.jpeg" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" integrity="sha512-c42qTSw/wPZ3/5LBzD+Bw5f7bSF2oxou6wEb+I/lqeaKV5FDIfMvvRp772y4jcJLKuGUOpbJMdg/BTl50fJYAw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
		
		<link href="../_app/immutable/assets/0.1aaef01e.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.08ee98e4.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/scheduler.e108d1fd.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/singletons.0f661fa2.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.515171e9.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/index.48054bed.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.5ae7a652.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/3.e9966361.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/each.e59479a4.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/stores.098d36b8.js"><title>Angelo Lloti&#39;s Blog</title><!-- HEAD_svelte-1030n7a_START --><link rel="alternate" type="application/rss+xml" title="RSS feed for Angelo Lloti's blog" href="/rss.xml"><!-- HEAD_svelte-1030n7a_END -->
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents">   <div class="h-screen w-full px-3 py-8 dark:bg-slate-900"><div class="prose prose-img:max-h-[80vh] prose-gray dark:prose-invert lg:max-w-[1000px] mx-auto prose-a:no-underline hover:prose-a:underline"><div class="flex justify-between"><h1 class="block" data-svelte-h="svelte-1tpbji4">Angelo&#39;s Blog</h1> </div> <ul class="text-slate-400"><li class="text-lg"><a href="/blog/trust-2/">Writing Sweet Rust Macros (trust pt. 2)</a> <span class="text-slate-400 text-xs align-middle">( <a href="/blog/?tag=macros">macros</a>,  <a href="/blog/?tag=rust">rust</a>,  <a href="/blog/?tag=trust">trust</a>; 2/13/2024)</span> </li><li class="text-lg"><a href="/blog/trust-1/">Exploring Terraria's Server Protocol (trust pt. 1)</a> <span class="text-slate-400 text-xs align-middle">( <a href="/blog/?tag=python">python</a>,  <a href="/blog/?tag=reverse-engineering">reverse-engineering</a>,  <a href="/blog/?tag=tcp">tcp</a>,  <a href="/blog/?tag=trust">trust</a>; 2/9/2024)</span> </li><li class="text-lg"><a href="/blog/rce/">Finding Deals on UberEats with Node.js and GitHub Actions</a> <span class="text-slate-400 text-xs align-middle">( <a href="/blog/?tag=github-actions">github-actions</a>,  <a href="/blog/?tag=javascript">javascript</a>,  <a href="/blog/?tag=puppeteer">puppeteer</a>,  <a href="/blog/?tag=scraping">scraping</a>; 2/6/2024)</span> </li><li class="text-lg"><a href="/blog/premia/">Finding Cheap Flight Tickets With Python</a> <span class="text-slate-400 text-xs align-middle">( <a href="/blog/?tag=data">data</a>,  <a href="/blog/?tag=python">python</a>,  <a href="/blog/?tag=scraping">scraping</a>; 1/31/2024)</span> </li><li class="text-lg"><a href="/blog/bdtp/">Better Done Than Perfect</a> <span class="text-slate-400 text-xs align-middle">( <a href="/blog/?tag=life">life</a>; 1/30/2024)</span> </li><li class="text-lg"><a href="/blog/me/">Who is Angelo Lloti?</a> <span class="text-slate-400 text-xs align-middle">( <a href="/blog/?tag=life">life</a>,  <a href="/blog/?tag=self">self</a>; 1/29/2024)</span> </li></ul></div></div> 
			
			<script>
				{
					__sveltekit_1oj7eta = {
						base: new URL("..", location).pathname.slice(0, -1),
						env: {}
					};

					const element = document.currentScript.parentElement;

					const data = [null,{"type":"data","data":{posts:[{id:"trust-2",content:"{\n\t\"title\": \"Writing Sweet Rust Macros (trust pt. 2)\",\n\t\"date\": 1707829348111,\n\t\"tags\": [\"trust\", \"rust\", \"macros\"]\n}\n---\n\nThere is something I haven't told you yet about trust in [part 1](/blog/trust-1). It is actually a project that I had thought of 2 years ago. Back then, I wanted to do the same thing as what I'm doing now, but I quit once I realized the actual scale of this project. As it turns out, this isn't an easy project. At the beginning, I found it strange that the Terraria server is just a headless client (meaning the server treats itself as an \"invisible\" player in the server). After really thinking about it, it makes plenty of sense. All of the game logic (mob spawning, water flowing, entity interactions) have to be fired off by some central authority — the server — and this means we need Terraria's logic, spawn rates, etc. all in our code. This is definitely a lot to implement and what halted my progress the first time. To put it short, I felt like I was about to open Pandora's box. I didn't like that feeling of uncertainty and rather than even begin to start, I gave up then and there. Alas, we are back and my mentality has greatly shifted since then.\n\n> The struggle itself towards the heights is enough to fill a man's heart. One must imagine Sisyphus happy.\n\n## Why a Macro?\n\nOk, so we have a fairly structured network protocol at this point. Each packet is structured like so.\n\n| field | type | length |\n| - | - | - |\n| len | u16 | 2 |\n| code | u8 | 1 |\n| msg | bytes | len-3 |\n\nDepending on `code`, `msg` may contain certain fields. For instance, if `code` is 3, we have a connection approval message whose fields are contained in `msg` like so.\n\n| field | type | length |\n| - | - | - |\n| id | u8 | 1 |\n| flag | bool | 1 |\n\n`id` represents the ID that the server assigns the user and `flag` seems to represent a flag called `ServerWantsToRunCheckBytesInClientLoopThread`. If this is true, the client calls `NetMessage.CheckBytes()` inside `Main.InnerClientLoop()`. Don't ask me... all I know is that this is hardcoded to be `false` every time.\n\nLet's take another example. If `code` is 5 and client-sent, the client is updating the server about a particular slot in their inventory. If `code` is 5 and broadcasted by the server, the server is notifying all players of a change in a player's inventory. *Note: internally, an inventory represents all a players items including their armor, dyes, pets, mounts, etc. Not just the items in the top left of their escape menu.*\n\n| field | type | length |\n| - | - | - |\n| id | u8 | 1 |\n| slot_id | i16 | 2 |\n| amount | i16 | 2 |\n| prefix | u8 | 1 |\n| item_id | i16 | 2 |\n\nYou get the gist? Anyway, my goal was to be able to write a Rust enum representing each packet so we can use `match`. I also want it to be aware of the code of each packet to automatically parse and encode it. In the doc comment, I put the packet's code. Also, let's not create the read method for server-only packets and write for client-only packets. In the doc comment, `->` means send-only, `\u003C-` means receive-only, and `\u003C->` means bidirectional. That would mean our macro should be able to convert this.\n\n```rs\n#[our_cool_proc_macro]\npub enum Message\u003C'a> {\n\t/// 3 ->\n\tConnectionApprove {\n\t\tpub client_id: u8,\n\t\tpub flag: bool,\n\t},\n\t/// 5 \u003C->\n\tPlayerInventorySlot {\n\t\tpub client_id: u8,\n\t\tpub slot_id: i16,\n\t\tpub amount: i16,\n\t\tpub prefix: u8,\n\t\tpub item_id: i16,\n\t},\n}\n```\n\ninto this\n\n```rs\npub struct ConnectionApprove {\n\tpub client_id: u8,\n\tpub flag: bool,\n}\n\npub struct PlayerInventorySlot {\n\tpub client_id: u8,\n\tpub slot_id: i16,\n\tpub amount: i16,\n\tpub prefix: u8,\n\tpub item_id: i16,\n}\n\n#[our_cool_proc_macro]\npub enum Message\u003C'a> {\n\tConnectionApprove(ConnectionApprove),\n\tPlayerInventorySlot(PlayerInventorySlot),\n\tUnknown(u8, &'a [u8]),\n}\n\n// let's assume the caller has already read the length of the packet and\n// is giving us everything after the length\nfn buffer_to_message(buf: &[u8]) -> Message {\n\tlet r = Reader::new(buf); // create a byte reader\n\tlet code = r.read_byte();\n\tmatch code {\n\t\t5 => Message::PlayerInventorySlot(PlayerInventorySlot {\n\t\t\tpub client_id: r.read_byte(),\n\t\t\tpub slot_id: r.read_i16(),\n\t\t\tpub amount: r.read_i16(),\n\t\t\tpub prefix: r.read_byte(),\n\t\t\tpub item_id: r.read_i16(),\n\t\t}),\n\t\t_ => Message::Unknown(code, &buf[1..])\n\t}\n}\n\nfn message_to_buffer(msg: Message) -> &[u8] {\n\tmatch Message {\n\t\tMessage::ConnectionApprove(ca) => {\n\t\t\tlet w = Writer::new(3);\n\t\t\tw.write_byte(client_id);\n\t\t\tw.write_bool(flag);\n\t\t\tw.finalize() // sets the first two bytes as the length and returns byte array\n\t\t}\n\t\tMessage::PlayerInventorySlot(slot) => {\n\t\t\tlet w = Writer::new(5);\n\t\t\tw.write_byte(slot.client_id);\n\t\t\tw.write_i16(slot.slot_id);\n\t\t\tw.write_i16(slot.amount);\n\t\t\tw.write_byte(slot.prefix);\n\t\t\tw.write_i16(slot.item_id);\n\t\t\tw.finalize()\n\t\t}\n\t\t_ => Message::Unknown(code, &buf[1..])\n\t}\n}\n```\n\nIn case you're wondering why I don't want to write the structs outside of the enum myself, it's because if I do, then this macro will be much more complicated as it won't just be completely contained within one enum.\n\n## Binary Reader and Writer\n\nFor starters, let's implement our `Reader` and `Writer`. Our reader will look like this,\n\n```rs\nimpl\u003C'a> Reader\u003C'a> {\n\tpub fn new(buf: &'a [u8]) -> Self {\n\t\tSelf { buf, cur: 0 }\n\t}\n\n\tpub fn read_bytes(&mut self, amount: usize) -> &[u8] {\n\t\tself.cur += amount;\n\t\t&self.buf[(self.cur - amount)..self.cur]\n\t}\n\n\tpub fn read_byte(&mut self, amount: usize) -> u8 {\n\t\tself.read_bytes(1)[0]\n\t}\n\n\tpub fn read_i16(&mut self) -> i16 {\n\t\ti16::from_le_bytes(self.read_bytes(2).try_into().unwrap())\n\t}\n\n\t// add methods as needed\n}\n```\n\nand our writer will look like this,\n\n```rs\nimpl Writer {\n\tpub fn new(code: u8) -> Self {\n\t\tSelf { buf: vec![0, 0, code] } // start the buffer with two empty bytes and the message code\n\t}\n\n\t// method to be called when a packet is done being constructed\n\tpub fn finalize(mut self) -> Vec\u003Cu8> {\n\t\tlet [a, b] = (self.buf.len() as u16).to_le_bytes(); // convert the length of the buffer to 2 bytes\n\t\tself.buf[0] = a; // replace the first two bytes with the length of the array\n\t\tself.buf[1] = b;\n\t\tself.buf\n\t}\n\n\tpub fn write_bytes(mut self, bytes: &[u8]) -> Self {\n\t\tself.buf.append(&mut bytes.to_vec());\n\t\tself\n\t}\n\n\tpub fn write_byte(mut self, byte: u8) -> Self {\n\t\tself.buf.push(byte);\n\t\tself\n\t}\n\n\tpub fn write_i16(self, num: i16) -> Self {\n\t\tself.write_bytes(&num.to_le_bytes())\n\t}\n\n\t// add methods as needed\n}\n```\n\nMakes sense? I'm just trying to get through this quickly since this is mostly boilerplate for the real difficulty which is writing a procedural macro.\n\nAs per The Rust Reference,\n> Procedural macros allow you to run code at compile time that operates over Rust syntax, both consuming and producing Rust syntax. You can sort of think of procedural macros as functions from an AST to another AST.\n\n## Set Up a Project for the Macro\n\nSo, we want to parse the AST and generate our own AST. Let's create a new cargo project called macros (`cargo init macros --lib`) and include in our main project (which actually hasn't been established yet) by adding `macros = { path = \"macros\" }` to `Cargo.toml`. In the `macros` project, we want to add this to `Cargo.toml`.\n\n```toml\n[dependencies]\nsyn = { version = \"2.0\", features = [\"full\"] }\nproc-macro2 = \"1.0\"\nquote = \"1.0\"\n\n[lib]\nproc-macro = true\n```\n\n[syn](https://docs.rs/syn/latest/syn/), [proc-macro2](https://docs.rs/proc-macro2/latest/proc_macro2/), and [quote](https://docs.rs/quote/latest/quote/) seem to be the essentials for creating a proc macro. We want to replace our primary enum with a new enum, more structs, and some `impl`s. To do this replacement, we use an attribute macro. To get started using an attribute macro, we write the method as follows.\n\n```rs\n#[proc_macro_attribute]\npub fn message_encoder_decoder(_: TokenStream, input: TokenStream) -> TokenStream {\n\t// draw the rest of the owl\n}\n```\n\nNow what? For simplicity's sake, I'll just be talking about the sending half of this macro. The code for the receiving half is predictably similar. Let's use syn to create a syntax tree from this token stream. To do that, we can do this.\n\n```rs\nlet input = parse_macro_input!(input as ItemEnum);\n```\n\nNow, let's start to build the that `match` statement that we had talked about earlier. To do this, let's store all the cases and finally construct the `match` inside of a `TryFrom`.\n\n```rs\nlet mut cases = Vec::new();\n\nfor variant in input.variants {\n\tlet name = variant.ident;\n\t// Skip over the Unknown variant since it's a special case\n\tif name.to_string() == \"Unknown\" {\n\t\tcontinue;\n\t}\n\n\t// Get the text contained within our /// comment (i.e. doc = \"/// 5 \u003C->\")\n\tlet doc = variant.attrs.first().unwrap().span().source_text().unwrap();\n\t// If we don't have a ->, we're not sending so skip\n\tif !doc.contains(\"->\") {\n\t\tcontinue;\n\t}\n\n\t// Get the packet code from the comment \n\tlet code: u8 = doc.split_whitespace().skip(1).next().unwrap().parse().unwrap();\n}\n```\n\nIn rust there are three kinds of enum variant fields, `Named`, `Unnamed`, and `Unit`. Named means that the variant contains named fields (i.e. `X { a: i32, b: f64 }`). Unnamed means that the variant is represented by a tuple (i.e. `Y(i32, f64, bool)`). `Unit` means the variant doesn't store any values (i.e. `None`). For now, we only have `Named` fields so let's deal with that.\n\n```rs\nfor variant in input.variants {\n\t// ...\n\n\tif let Fields::Named(field) = variant.fields {\n\t\t// Store the array of the methods we are calling\n\t\tlet mut fns = Vec::new();\n\n\t\t// Iterate over each named field\n\t\tfor field in fields.named {\n\t\t\tlet name = field.ident.as_ref().unwrap();\n\t\t\tif let Type::Path(ty) = &field.ty {\n\t\t\t\t// Remember, we made Writer chainable so we can just join these\n\t\t\t\tlet method = match ty.path.segments.first().unwrap().ident.to_string().as_str() {\n\t\t\t\t\t\"bool\" => quote! { .write_bool(data.#name) },\n\t\t\t\t\t\"u8\" => quote! { .write_byte(data.#name) },\n\t\t\t\t\t\"i16\" => quote! { .write_i16(data.#name) },\n\t\t\t\t\tty => quote! { compile_error!(\"Unknown type: {}\", #ty) },\n\t\t\t\t}\n\t\t\t\t// Add the method\n\t\t\t\tfns.push(method)\n\t\t\t}\n\t\t}\n\n\t\t// # embeds the variable and #(#fns)* repeats fns\n\t\tcases.push(quote! { Message::#name(data) => Ok(Writer::new(#code)#(#fns)*.finalize()) })\n\t}\n}\n```\n\nCool. What is `quote!` doing, you may ask. It is taking the Rust code and converting it into a token stream. We now have our cases for each server-sent packet. Let's finally wrap them up in a match statement and get this show on the road. After our for loop, we are going to have this.\n\n\n```rs\nlet sendable_from = TokenStream::from(quote! {\n\timpl\u003C'a> TryFrom\u003CMessage\u003C'a>> for Vec\u003Cu8> {\n\t\ttype Error = &'static str;\n\n\t\tfn try_from(msg: Message) -> Result\u003CSelf, Self::Error> {\n\t\t\tmatch msg {\n\t\t\t\t#(#cases),*, // Join each case by a comma\n\t\t\t\t// Our beloved special case\n\t\t\t\tMessage::Unknown(code, buf) => Ok(Writer::new(code).write_bytes(buf).finalize()),\n\t\t\t\t_ => Err(\"Unserializable message. Consider using Message::Unknown\"),\n\t\t\t}\n\t\t}\n\t}\n});\n```\n\nAt this point, we are pretty much done. We just have to take our named fields and convert them to unnamed fields with the struct defined somewhere else. The rest of the code is just this.\n\n```rs\nlet mut structs = Vec::new();\nlet mut variants = Vec::new();\n\nfor variant in input.variants {\n\tif let Fields::Named(fields) = variant.fields {\n\t\tlet fields = fields.named.iter(); // get the fields\n\t\tlet name = variant.ident; // get the name of the variant\n\t\tstructs.push(quote! {\n\t\t\t#[derive(Debug, Clone)]\n\t\t\t// construct a struct of the same name and fields\n\t\t\tpub struct #name {\n\t\t\t\t#(#fields),*\n\t\t\t}\n\t\t});\n\t\tvariants.push(quote! { #name(#name) }) // the new variant\n\t} else {\n\t\tvariants.push(quote! { #variant }) // nothing changes if it's not named\n\t}\n}\n\nTokenStream::from(quote! {\n\t#(#structs)* // iterate over all our structs\n\t#[derive(Debug, Clone)]\n\tpub enum Message\u003C'a> {\n\t\t#(#variants),* // include all our variants\n\t}\n\t#sendable_from // include our impl TryFrom\n})\n```\n\nThere is, of course, much more to this. There are more types besides u8, i16, and bool. There's also more code for handling the client-sent readable packets. All of that is pretty much just doing what we did here but slightly differently. If you are interested in the full code for the [macro](https://github.com/xDimGG/trust/blob/main/macros/src/lib.rs), the [reader](https://github.com/xDimGG/trust/blob/main/src/binary/reader.rs), and the [writer](https://github.com/xDimGG/trust/blob/main/src/binary/writer.rs), it's all in the [repository](https://github.com/xDimGG/trust).\n\n## Closing Notes\nMacro code can be hard to understand. I created this macro two years ago, and when I came back to it, I couldn't believe that I wrote it. The whole thing just seemed like gibberish. As a matter of fact, I had no intention to even touch the macro! However, when I tried compiling this project that I haven't touched in two years with a modern version of Rust, I received the following error.\n\n```\nerror[E0512]: cannot transmute between types of different sizes, or dependently-sized types\n   --> C:\\Users\\Dim\\.cargo\\registry\\src\\index.crates.io-6f17d22bba15001f\\socket2-0.3.12\\src\\sockaddr.rs:176:9\n    |\n176 |         mem::transmute::\u003CSocketAddrV4, sockaddr_in>(v4);\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = note: source type: `SocketAddrV4` (48 bits)\n    = note: target type: `SOCKADDR_IN` (128 bits)\n\nFor more information about this error, try `rustc --explain E0512`.\n```\n\nAfter a Google search, [this error](https://users.rust-lang.org/t/error-compiling-old-rust-project/83840) meant that one of my dependencies is outdated. That dependency turned out to be syn. I was on v1 and needed v2. I upgraded syn to v2, only to find out that the API has slightly changed so some lines were erroring. Because of that, I more or less had to re-understand my entire macro code again, which I really didn't want to do. Anyway, I did that and fixed it.\n\nHowever, this got me to thinking. Is there a way I could have made this code more readable? Well, not really. I think proc macros are generally quite hard to read without comments. I could and should probably add a bunch of comments to the code so that future me who was to re-visit this has at least a clue of what's going on... nahhh. Comments are for chumps.\n\nAnyway, that's all for now. Until we meet again in part 3.\n",html:"\u003Cp>There is something I haven&#39;t told you yet about trust in \u003Ca href=\"/blog/trust-1\">part 1\u003C/a>. It is actually a project that I had thought of 2 years ago. Back then, I wanted to do the same thing as what I&#39;m doing now, but I quit once I realized the actual scale of this project. As it turns out, this isn&#39;t an easy project. At the beginning, I found it strange that the Terraria server is just a headless client (meaning the server treats itself as an &quot;invisible&quot; player in the server). After really thinking about it, it makes plenty of sense. All of the game logic (mob spawning, water flowing, entity interactions) have to be fired off by some central authority — the server — and this means we need Terraria&#39;s logic, spawn rates, etc. all in our code. This is definitely a lot to implement and what halted my progress the first time. To put it short, I felt like I was about to open Pandora&#39;s box. I didn&#39;t like that feeling of uncertainty and rather than even begin to start, I gave up then and there. Alas, we are back and my mentality has greatly shifted since then.\u003C/p>\n\u003Cblockquote>\n\u003Cp>The struggle itself towards the heights is enough to fill a man&#39;s heart. One must imagine Sisyphus happy.\u003C/p>\n\u003C/blockquote>\n\u003Ch2>Why a Macro?\u003C/h2>\n\u003Cp>Ok, so we have a fairly structured network protocol at this point. Each packet is structured like so.\u003C/p>\n\u003Ctable>\n\u003Cthead>\n\u003Ctr>\n\u003Cth>field\u003C/th>\n\u003Cth>type\u003C/th>\n\u003Cth>length\u003C/th>\n\u003C/tr>\n\u003C/thead>\n\u003Ctbody>\u003Ctr>\n\u003Ctd>len\u003C/td>\n\u003Ctd>u16\u003C/td>\n\u003Ctd>2\u003C/td>\n\u003C/tr>\n\u003Ctr>\n\u003Ctd>code\u003C/td>\n\u003Ctd>u8\u003C/td>\n\u003Ctd>1\u003C/td>\n\u003C/tr>\n\u003Ctr>\n\u003Ctd>msg\u003C/td>\n\u003Ctd>bytes\u003C/td>\n\u003Ctd>len-3\u003C/td>\n\u003C/tr>\n\u003C/tbody>\u003C/table>\n\u003Cp>Depending on \u003Ccode>code\u003C/code>, \u003Ccode>msg\u003C/code> may contain certain fields. For instance, if \u003Ccode>code\u003C/code> is 3, we have a connection approval message whose fields are contained in \u003Ccode>msg\u003C/code> like so.\u003C/p>\n\u003Ctable>\n\u003Cthead>\n\u003Ctr>\n\u003Cth>field\u003C/th>\n\u003Cth>type\u003C/th>\n\u003Cth>length\u003C/th>\n\u003C/tr>\n\u003C/thead>\n\u003Ctbody>\u003Ctr>\n\u003Ctd>id\u003C/td>\n\u003Ctd>u8\u003C/td>\n\u003Ctd>1\u003C/td>\n\u003C/tr>\n\u003Ctr>\n\u003Ctd>flag\u003C/td>\n\u003Ctd>bool\u003C/td>\n\u003Ctd>1\u003C/td>\n\u003C/tr>\n\u003C/tbody>\u003C/table>\n\u003Cp>\u003Ccode>id\u003C/code> represents the ID that the server assigns the user and \u003Ccode>flag\u003C/code> seems to represent a flag called \u003Ccode>ServerWantsToRunCheckBytesInClientLoopThread\u003C/code>. If this is true, the client calls \u003Ccode>NetMessage.CheckBytes()\u003C/code> inside \u003Ccode>Main.InnerClientLoop()\u003C/code>. Don&#39;t ask me... all I know is that this is hardcoded to be \u003Ccode>false\u003C/code> every time.\u003C/p>\n\u003Cp>Let&#39;s take another example. If \u003Ccode>code\u003C/code> is 5 and client-sent, the client is updating the server about a particular slot in their inventory. If \u003Ccode>code\u003C/code> is 5 and broadcasted by the server, the server is notifying all players of a change in a player&#39;s inventory. \u003Cem>Note: internally, an inventory represents all a players items including their armor, dyes, pets, mounts, etc. Not just the items in the top left of their escape menu.\u003C/em>\u003C/p>\n\u003Ctable>\n\u003Cthead>\n\u003Ctr>\n\u003Cth>field\u003C/th>\n\u003Cth>type\u003C/th>\n\u003Cth>length\u003C/th>\n\u003C/tr>\n\u003C/thead>\n\u003Ctbody>\u003Ctr>\n\u003Ctd>id\u003C/td>\n\u003Ctd>u8\u003C/td>\n\u003Ctd>1\u003C/td>\n\u003C/tr>\n\u003Ctr>\n\u003Ctd>slot_id\u003C/td>\n\u003Ctd>i16\u003C/td>\n\u003Ctd>2\u003C/td>\n\u003C/tr>\n\u003Ctr>\n\u003Ctd>amount\u003C/td>\n\u003Ctd>i16\u003C/td>\n\u003Ctd>2\u003C/td>\n\u003C/tr>\n\u003Ctr>\n\u003Ctd>prefix\u003C/td>\n\u003Ctd>u8\u003C/td>\n\u003Ctd>1\u003C/td>\n\u003C/tr>\n\u003Ctr>\n\u003Ctd>item_id\u003C/td>\n\u003Ctd>i16\u003C/td>\n\u003Ctd>2\u003C/td>\n\u003C/tr>\n\u003C/tbody>\u003C/table>\n\u003Cp>You get the gist? Anyway, my goal was to be able to write a Rust enum representing each packet so we can use \u003Ccode>match\u003C/code>. I also want it to be aware of the code of each packet to automatically parse and encode it. In the doc comment, I put the packet&#39;s code. Also, let&#39;s not create the read method for server-only packets and write for client-only packets. In the doc comment, \u003Ccode>-&gt;\u003C/code> means send-only, \u003Ccode>&lt;-\u003C/code> means receive-only, and \u003Ccode>&lt;-&gt;\u003C/code> means bidirectional. That would mean our macro should be able to convert this.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-rs\">\u003Cspan class=\"hljs-meta\">#[our_cool_proc_macro]\u003C/span>\n\u003Cspan class=\"hljs-keyword\">pub\u003C/span> \u003Cspan class=\"hljs-keyword\">enum\u003C/span> \u003Cspan class=\"hljs-title class_\">Message\u003C/span>&lt;\u003Cspan class=\"hljs-symbol\">&#x27;a\u003C/span>&gt; {\n    \u003Cspan class=\"hljs-comment\">/// 3 -&gt;\u003C/span>\n    ConnectionApprove {\n        \u003Cspan class=\"hljs-keyword\">pub\u003C/span> client_id: \u003Cspan class=\"hljs-type\">u8\u003C/span>,\n        \u003Cspan class=\"hljs-keyword\">pub\u003C/span> flag: \u003Cspan class=\"hljs-type\">bool\u003C/span>,\n    },\n    \u003Cspan class=\"hljs-comment\">/// 5 &lt;-&gt;\u003C/span>\n    PlayerInventorySlot {\n        \u003Cspan class=\"hljs-keyword\">pub\u003C/span> client_id: \u003Cspan class=\"hljs-type\">u8\u003C/span>,\n        \u003Cspan class=\"hljs-keyword\">pub\u003C/span> slot_id: \u003Cspan class=\"hljs-type\">i16\u003C/span>,\n        \u003Cspan class=\"hljs-keyword\">pub\u003C/span> amount: \u003Cspan class=\"hljs-type\">i16\u003C/span>,\n        \u003Cspan class=\"hljs-keyword\">pub\u003C/span> prefix: \u003Cspan class=\"hljs-type\">u8\u003C/span>,\n        \u003Cspan class=\"hljs-keyword\">pub\u003C/span> item_id: \u003Cspan class=\"hljs-type\">i16\u003C/span>,\n    },\n}\n\u003C/code>\u003C/pre>\u003Cp>into this\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-rs\">\u003Cspan class=\"hljs-keyword\">pub\u003C/span> \u003Cspan class=\"hljs-keyword\">struct\u003C/span> \u003Cspan class=\"hljs-title class_\">ConnectionApprove\u003C/span> {\n    \u003Cspan class=\"hljs-keyword\">pub\u003C/span> client_id: \u003Cspan class=\"hljs-type\">u8\u003C/span>,\n    \u003Cspan class=\"hljs-keyword\">pub\u003C/span> flag: \u003Cspan class=\"hljs-type\">bool\u003C/span>,\n}\n\n\u003Cspan class=\"hljs-keyword\">pub\u003C/span> \u003Cspan class=\"hljs-keyword\">struct\u003C/span> \u003Cspan class=\"hljs-title class_\">PlayerInventorySlot\u003C/span> {\n    \u003Cspan class=\"hljs-keyword\">pub\u003C/span> client_id: \u003Cspan class=\"hljs-type\">u8\u003C/span>,\n    \u003Cspan class=\"hljs-keyword\">pub\u003C/span> slot_id: \u003Cspan class=\"hljs-type\">i16\u003C/span>,\n    \u003Cspan class=\"hljs-keyword\">pub\u003C/span> amount: \u003Cspan class=\"hljs-type\">i16\u003C/span>,\n    \u003Cspan class=\"hljs-keyword\">pub\u003C/span> prefix: \u003Cspan class=\"hljs-type\">u8\u003C/span>,\n    \u003Cspan class=\"hljs-keyword\">pub\u003C/span> item_id: \u003Cspan class=\"hljs-type\">i16\u003C/span>,\n}\n\n\u003Cspan class=\"hljs-meta\">#[our_cool_proc_macro]\u003C/span>\n\u003Cspan class=\"hljs-keyword\">pub\u003C/span> \u003Cspan class=\"hljs-keyword\">enum\u003C/span> \u003Cspan class=\"hljs-title class_\">Message\u003C/span>&lt;\u003Cspan class=\"hljs-symbol\">&#x27;a\u003C/span>&gt; {\n    \u003Cspan class=\"hljs-title function_ invoke__\">ConnectionApprove\u003C/span>(ConnectionApprove),\n    \u003Cspan class=\"hljs-title function_ invoke__\">PlayerInventorySlot\u003C/span>(PlayerInventorySlot),\n    \u003Cspan class=\"hljs-title function_ invoke__\">Unknown\u003C/span>(\u003Cspan class=\"hljs-type\">u8\u003C/span>, &amp;\u003Cspan class=\"hljs-symbol\">&#x27;a\u003C/span> [\u003Cspan class=\"hljs-type\">u8\u003C/span>]),\n}\n\n\u003Cspan class=\"hljs-comment\">// let&#x27;s assume the caller has already read the length of the packet and\u003C/span>\n\u003Cspan class=\"hljs-comment\">// is giving us everything after the length\u003C/span>\n\u003Cspan class=\"hljs-keyword\">fn\u003C/span> \u003Cspan class=\"hljs-title function_\">buffer_to_message\u003C/span>(buf: &amp;[\u003Cspan class=\"hljs-type\">u8\u003C/span>]) \u003Cspan class=\"hljs-punctuation\">-&gt;\u003C/span> Message {\n    \u003Cspan class=\"hljs-keyword\">let\u003C/span> \u003Cspan class=\"hljs-variable\">r\u003C/span> = Reader::\u003Cspan class=\"hljs-title function_ invoke__\">new\u003C/span>(buf); \u003Cspan class=\"hljs-comment\">// create a byte reader\u003C/span>\n    \u003Cspan class=\"hljs-keyword\">let\u003C/span> \u003Cspan class=\"hljs-variable\">code\u003C/span> = r.\u003Cspan class=\"hljs-title function_ invoke__\">read_byte\u003C/span>();\n    \u003Cspan class=\"hljs-keyword\">match\u003C/span> code {\n        \u003Cspan class=\"hljs-number\">5\u003C/span> =&gt; Message::\u003Cspan class=\"hljs-title function_ invoke__\">PlayerInventorySlot\u003C/span>(PlayerInventorySlot {\n            \u003Cspan class=\"hljs-keyword\">pub\u003C/span> client_id: r.\u003Cspan class=\"hljs-title function_ invoke__\">read_byte\u003C/span>(),\n            \u003Cspan class=\"hljs-keyword\">pub\u003C/span> slot_id: r.\u003Cspan class=\"hljs-title function_ invoke__\">read_i16\u003C/span>(),\n            \u003Cspan class=\"hljs-keyword\">pub\u003C/span> amount: r.\u003Cspan class=\"hljs-title function_ invoke__\">read_i16\u003C/span>(),\n            \u003Cspan class=\"hljs-keyword\">pub\u003C/span> prefix: r.\u003Cspan class=\"hljs-title function_ invoke__\">read_byte\u003C/span>(),\n            \u003Cspan class=\"hljs-keyword\">pub\u003C/span> item_id: r.\u003Cspan class=\"hljs-title function_ invoke__\">read_i16\u003C/span>(),\n        }),\n        _ =&gt; Message::\u003Cspan class=\"hljs-title function_ invoke__\">Unknown\u003C/span>(code, &amp;buf[\u003Cspan class=\"hljs-number\">1\u003C/span>..])\n    }\n}\n\n\u003Cspan class=\"hljs-keyword\">fn\u003C/span> \u003Cspan class=\"hljs-title function_\">message_to_buffer\u003C/span>(msg: Message) \u003Cspan class=\"hljs-punctuation\">-&gt;\u003C/span> &amp;[\u003Cspan class=\"hljs-type\">u8\u003C/span>] {\n    \u003Cspan class=\"hljs-keyword\">match\u003C/span> Message {\n        Message::\u003Cspan class=\"hljs-title function_ invoke__\">ConnectionApprove\u003C/span>(ca) =&gt; {\n            \u003Cspan class=\"hljs-keyword\">let\u003C/span> \u003Cspan class=\"hljs-variable\">w\u003C/span> = Writer::\u003Cspan class=\"hljs-title function_ invoke__\">new\u003C/span>(\u003Cspan class=\"hljs-number\">3\u003C/span>);\n            w.\u003Cspan class=\"hljs-title function_ invoke__\">write_byte\u003C/span>(client_id);\n            w.\u003Cspan class=\"hljs-title function_ invoke__\">write_bool\u003C/span>(flag);\n            w.\u003Cspan class=\"hljs-title function_ invoke__\">finalize\u003C/span>() \u003Cspan class=\"hljs-comment\">// sets the first two bytes as the length and returns byte array\u003C/span>\n        }\n        Message::\u003Cspan class=\"hljs-title function_ invoke__\">PlayerInventorySlot\u003C/span>(slot) =&gt; {\n            \u003Cspan class=\"hljs-keyword\">let\u003C/span> \u003Cspan class=\"hljs-variable\">w\u003C/span> = Writer::\u003Cspan class=\"hljs-title function_ invoke__\">new\u003C/span>(\u003Cspan class=\"hljs-number\">5\u003C/span>);\n            w.\u003Cspan class=\"hljs-title function_ invoke__\">write_byte\u003C/span>(slot.client_id);\n            w.\u003Cspan class=\"hljs-title function_ invoke__\">write_i16\u003C/span>(slot.slot_id);\n            w.\u003Cspan class=\"hljs-title function_ invoke__\">write_i16\u003C/span>(slot.amount);\n            w.\u003Cspan class=\"hljs-title function_ invoke__\">write_byte\u003C/span>(slot.prefix);\n            w.\u003Cspan class=\"hljs-title function_ invoke__\">write_i16\u003C/span>(slot.item_id);\n            w.\u003Cspan class=\"hljs-title function_ invoke__\">finalize\u003C/span>()\n        }\n        _ =&gt; Message::\u003Cspan class=\"hljs-title function_ invoke__\">Unknown\u003C/span>(code, &amp;buf[\u003Cspan class=\"hljs-number\">1\u003C/span>..])\n    }\n}\n\u003C/code>\u003C/pre>\u003Cp>In case you&#39;re wondering why I don&#39;t want to write the structs outside of the enum myself, it&#39;s because if I do, then this macro will be much more complicated as it won&#39;t just be completely contained within one enum.\u003C/p>\n\u003Ch2>Binary Reader and Writer\u003C/h2>\n\u003Cp>For starters, let&#39;s implement our \u003Ccode>Reader\u003C/code> and \u003Ccode>Writer\u003C/code>. Our reader will look like this,\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-rs\">\u003Cspan class=\"hljs-keyword\">impl\u003C/span>&lt;\u003Cspan class=\"hljs-symbol\">&#x27;a\u003C/span>&gt; Reader&lt;\u003Cspan class=\"hljs-symbol\">&#x27;a\u003C/span>&gt; {\n    \u003Cspan class=\"hljs-keyword\">pub\u003C/span> \u003Cspan class=\"hljs-keyword\">fn\u003C/span> \u003Cspan class=\"hljs-title function_\">new\u003C/span>(buf: &amp;\u003Cspan class=\"hljs-symbol\">&#x27;a\u003C/span> [\u003Cspan class=\"hljs-type\">u8\u003C/span>]) \u003Cspan class=\"hljs-punctuation\">-&gt;\u003C/span> \u003Cspan class=\"hljs-keyword\">Self\u003C/span> {\n        \u003Cspan class=\"hljs-keyword\">Self\u003C/span> { buf, cur: \u003Cspan class=\"hljs-number\">0\u003C/span> }\n    }\n\n    \u003Cspan class=\"hljs-keyword\">pub\u003C/span> \u003Cspan class=\"hljs-keyword\">fn\u003C/span> \u003Cspan class=\"hljs-title function_\">read_bytes\u003C/span>(&amp;\u003Cspan class=\"hljs-keyword\">mut\u003C/span> \u003Cspan class=\"hljs-keyword\">self\u003C/span>, amount: \u003Cspan class=\"hljs-type\">usize\u003C/span>) \u003Cspan class=\"hljs-punctuation\">-&gt;\u003C/span> &amp;[\u003Cspan class=\"hljs-type\">u8\u003C/span>] {\n        \u003Cspan class=\"hljs-keyword\">self\u003C/span>.cur += amount;\n        &amp;\u003Cspan class=\"hljs-keyword\">self\u003C/span>.buf[(\u003Cspan class=\"hljs-keyword\">self\u003C/span>.cur - amount)..\u003Cspan class=\"hljs-keyword\">self\u003C/span>.cur]\n    }\n\n    \u003Cspan class=\"hljs-keyword\">pub\u003C/span> \u003Cspan class=\"hljs-keyword\">fn\u003C/span> \u003Cspan class=\"hljs-title function_\">read_byte\u003C/span>(&amp;\u003Cspan class=\"hljs-keyword\">mut\u003C/span> \u003Cspan class=\"hljs-keyword\">self\u003C/span>, amount: \u003Cspan class=\"hljs-type\">usize\u003C/span>) \u003Cspan class=\"hljs-punctuation\">-&gt;\u003C/span> \u003Cspan class=\"hljs-type\">u8\u003C/span> {\n        \u003Cspan class=\"hljs-keyword\">self\u003C/span>.\u003Cspan class=\"hljs-title function_ invoke__\">read_bytes\u003C/span>(\u003Cspan class=\"hljs-number\">1\u003C/span>)[\u003Cspan class=\"hljs-number\">0\u003C/span>]\n    }\n\n    \u003Cspan class=\"hljs-keyword\">pub\u003C/span> \u003Cspan class=\"hljs-keyword\">fn\u003C/span> \u003Cspan class=\"hljs-title function_\">read_i16\u003C/span>(&amp;\u003Cspan class=\"hljs-keyword\">mut\u003C/span> \u003Cspan class=\"hljs-keyword\">self\u003C/span>) \u003Cspan class=\"hljs-punctuation\">-&gt;\u003C/span> \u003Cspan class=\"hljs-type\">i16\u003C/span> {\n        \u003Cspan class=\"hljs-type\">i16\u003C/span>::\u003Cspan class=\"hljs-title function_ invoke__\">from_le_bytes\u003C/span>(\u003Cspan class=\"hljs-keyword\">self\u003C/span>.\u003Cspan class=\"hljs-title function_ invoke__\">read_bytes\u003C/span>(\u003Cspan class=\"hljs-number\">2\u003C/span>).\u003Cspan class=\"hljs-title function_ invoke__\">try_into\u003C/span>().\u003Cspan class=\"hljs-title function_ invoke__\">unwrap\u003C/span>())\n    }\n\n    \u003Cspan class=\"hljs-comment\">// add methods as needed\u003C/span>\n}\n\u003C/code>\u003C/pre>\u003Cp>and our writer will look like this,\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-rs\">\u003Cspan class=\"hljs-keyword\">impl\u003C/span> \u003Cspan class=\"hljs-title class_\">Writer\u003C/span> {\n    \u003Cspan class=\"hljs-keyword\">pub\u003C/span> \u003Cspan class=\"hljs-keyword\">fn\u003C/span> \u003Cspan class=\"hljs-title function_\">new\u003C/span>(code: \u003Cspan class=\"hljs-type\">u8\u003C/span>) \u003Cspan class=\"hljs-punctuation\">-&gt;\u003C/span> \u003Cspan class=\"hljs-keyword\">Self\u003C/span> {\n        \u003Cspan class=\"hljs-keyword\">Self\u003C/span> { buf: \u003Cspan class=\"hljs-built_in\">vec!\u003C/span>[\u003Cspan class=\"hljs-number\">0\u003C/span>, \u003Cspan class=\"hljs-number\">0\u003C/span>, code] } \u003Cspan class=\"hljs-comment\">// start the buffer with two empty bytes and the message code\u003C/span>\n    }\n\n    \u003Cspan class=\"hljs-comment\">// method to be called when a packet is done being constructed\u003C/span>\n    \u003Cspan class=\"hljs-keyword\">pub\u003C/span> \u003Cspan class=\"hljs-keyword\">fn\u003C/span> \u003Cspan class=\"hljs-title function_\">finalize\u003C/span>(\u003Cspan class=\"hljs-keyword\">mut\u003C/span> \u003Cspan class=\"hljs-keyword\">self\u003C/span>) \u003Cspan class=\"hljs-punctuation\">-&gt;\u003C/span> \u003Cspan class=\"hljs-type\">Vec\u003C/span>&lt;\u003Cspan class=\"hljs-type\">u8\u003C/span>&gt; {\n        \u003Cspan class=\"hljs-keyword\">let\u003C/span> [a, b] = (\u003Cspan class=\"hljs-keyword\">self\u003C/span>.buf.\u003Cspan class=\"hljs-title function_ invoke__\">len\u003C/span>() \u003Cspan class=\"hljs-keyword\">as\u003C/span> \u003Cspan class=\"hljs-type\">u16\u003C/span>).\u003Cspan class=\"hljs-title function_ invoke__\">to_le_bytes\u003C/span>(); \u003Cspan class=\"hljs-comment\">// convert the length of the buffer to 2 bytes\u003C/span>\n        \u003Cspan class=\"hljs-keyword\">self\u003C/span>.buf[\u003Cspan class=\"hljs-number\">0\u003C/span>] = a; \u003Cspan class=\"hljs-comment\">// replace the first two bytes with the length of the array\u003C/span>\n        \u003Cspan class=\"hljs-keyword\">self\u003C/span>.buf[\u003Cspan class=\"hljs-number\">1\u003C/span>] = b;\n        \u003Cspan class=\"hljs-keyword\">self\u003C/span>.buf\n    }\n\n    \u003Cspan class=\"hljs-keyword\">pub\u003C/span> \u003Cspan class=\"hljs-keyword\">fn\u003C/span> \u003Cspan class=\"hljs-title function_\">write_bytes\u003C/span>(\u003Cspan class=\"hljs-keyword\">mut\u003C/span> \u003Cspan class=\"hljs-keyword\">self\u003C/span>, bytes: &amp;[\u003Cspan class=\"hljs-type\">u8\u003C/span>]) \u003Cspan class=\"hljs-punctuation\">-&gt;\u003C/span> \u003Cspan class=\"hljs-keyword\">Self\u003C/span> {\n        \u003Cspan class=\"hljs-keyword\">self\u003C/span>.buf.\u003Cspan class=\"hljs-title function_ invoke__\">append\u003C/span>(&amp;\u003Cspan class=\"hljs-keyword\">mut\u003C/span> bytes.\u003Cspan class=\"hljs-title function_ invoke__\">to_vec\u003C/span>());\n        \u003Cspan class=\"hljs-keyword\">self\u003C/span>\n    }\n\n    \u003Cspan class=\"hljs-keyword\">pub\u003C/span> \u003Cspan class=\"hljs-keyword\">fn\u003C/span> \u003Cspan class=\"hljs-title function_\">write_byte\u003C/span>(\u003Cspan class=\"hljs-keyword\">mut\u003C/span> \u003Cspan class=\"hljs-keyword\">self\u003C/span>, byte: \u003Cspan class=\"hljs-type\">u8\u003C/span>) \u003Cspan class=\"hljs-punctuation\">-&gt;\u003C/span> \u003Cspan class=\"hljs-keyword\">Self\u003C/span> {\n        \u003Cspan class=\"hljs-keyword\">self\u003C/span>.buf.\u003Cspan class=\"hljs-title function_ invoke__\">push\u003C/span>(byte);\n        \u003Cspan class=\"hljs-keyword\">self\u003C/span>\n    }\n\n    \u003Cspan class=\"hljs-keyword\">pub\u003C/span> \u003Cspan class=\"hljs-keyword\">fn\u003C/span> \u003Cspan class=\"hljs-title function_\">write_i16\u003C/span>(\u003Cspan class=\"hljs-keyword\">self\u003C/span>, num: \u003Cspan class=\"hljs-type\">i16\u003C/span>) \u003Cspan class=\"hljs-punctuation\">-&gt;\u003C/span> \u003Cspan class=\"hljs-keyword\">Self\u003C/span> {\n        \u003Cspan class=\"hljs-keyword\">self\u003C/span>.\u003Cspan class=\"hljs-title function_ invoke__\">write_bytes\u003C/span>(&amp;num.\u003Cspan class=\"hljs-title function_ invoke__\">to_le_bytes\u003C/span>())\n    }\n\n    \u003Cspan class=\"hljs-comment\">// add methods as needed\u003C/span>\n}\n\u003C/code>\u003C/pre>\u003Cp>Makes sense? I&#39;m just trying to get through this quickly since this is mostly boilerplate for the real difficulty which is writing a procedural macro.\u003C/p>\n\u003Cp>As per The Rust Reference,\u003C/p>\n\u003Cblockquote>\n\u003Cp>Procedural macros allow you to run code at compile time that operates over Rust syntax, both consuming and producing Rust syntax. You can sort of think of procedural macros as functions from an AST to another AST.\u003C/p>\n\u003C/blockquote>\n\u003Ch2>Set Up a Project for the Macro\u003C/h2>\n\u003Cp>So, we want to parse the AST and generate our own AST. Let&#39;s create a new cargo project called macros (\u003Ccode>cargo init macros --lib\u003C/code>) and include in our main project (which actually hasn&#39;t been established yet) by adding \u003Ccode>macros = { path = &quot;macros&quot; }\u003C/code> to \u003Ccode>Cargo.toml\u003C/code>. In the \u003Ccode>macros\u003C/code> project, we want to add this to \u003Ccode>Cargo.toml\u003C/code>.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-toml\">\u003Cspan class=\"hljs-section\">[dependencies]\u003C/span>\n\u003Cspan class=\"hljs-attr\">syn\u003C/span> = { version = \u003Cspan class=\"hljs-string\">&quot;2.0&quot;\u003C/span>, features = [\u003Cspan class=\"hljs-string\">&quot;full&quot;\u003C/span>] }\n\u003Cspan class=\"hljs-attr\">proc-macro2\u003C/span> = \u003Cspan class=\"hljs-string\">&quot;1.0&quot;\u003C/span>\n\u003Cspan class=\"hljs-attr\">quote\u003C/span> = \u003Cspan class=\"hljs-string\">&quot;1.0&quot;\u003C/span>\n\n\u003Cspan class=\"hljs-section\">[lib]\u003C/span>\n\u003Cspan class=\"hljs-attr\">proc-macro\u003C/span> = \u003Cspan class=\"hljs-literal\">true\u003C/span>\n\u003C/code>\u003C/pre>\u003Cp>\u003Ca href=\"https://docs.rs/syn/latest/syn/\">syn\u003C/a>, \u003Ca href=\"https://docs.rs/proc-macro2/latest/proc_macro2/\">proc-macro2\u003C/a>, and \u003Ca href=\"https://docs.rs/quote/latest/quote/\">quote\u003C/a> seem to be the essentials for creating a proc macro. We want to replace our primary enum with a new enum, more structs, and some \u003Ccode>impl\u003C/code>s. To do this replacement, we use an attribute macro. To get started using an attribute macro, we write the method as follows.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-rs\">\u003Cspan class=\"hljs-meta\">#[proc_macro_attribute]\u003C/span>\n\u003Cspan class=\"hljs-keyword\">pub\u003C/span> \u003Cspan class=\"hljs-keyword\">fn\u003C/span> \u003Cspan class=\"hljs-title function_\">message_encoder_decoder\u003C/span>(_: TokenStream, input: TokenStream) \u003Cspan class=\"hljs-punctuation\">-&gt;\u003C/span> TokenStream {\n    \u003Cspan class=\"hljs-comment\">// draw the rest of the owl\u003C/span>\n}\n\u003C/code>\u003C/pre>\u003Cp>Now what? For simplicity&#39;s sake, I&#39;ll just be talking about the sending half of this macro. The code for the receiving half is predictably similar. Let&#39;s use syn to create a syntax tree from this token stream. To do that, we can do this.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-rs\">\u003Cspan class=\"hljs-keyword\">let\u003C/span> \u003Cspan class=\"hljs-variable\">input\u003C/span> = parse_macro_input!(input \u003Cspan class=\"hljs-keyword\">as\u003C/span> ItemEnum);\n\u003C/code>\u003C/pre>\u003Cp>Now, let&#39;s start to build the that \u003Ccode>match\u003C/code> statement that we had talked about earlier. To do this, let&#39;s store all the cases and finally construct the \u003Ccode>match\u003C/code> inside of a \u003Ccode>TryFrom\u003C/code>.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-rs\">\u003Cspan class=\"hljs-keyword\">let\u003C/span> \u003Cspan class=\"hljs-keyword\">mut \u003C/span>\u003Cspan class=\"hljs-variable\">cases\u003C/span> = \u003Cspan class=\"hljs-type\">Vec\u003C/span>::\u003Cspan class=\"hljs-title function_ invoke__\">new\u003C/span>();\n\n\u003Cspan class=\"hljs-keyword\">for\u003C/span> \u003Cspan class=\"hljs-variable\">variant\u003C/span> \u003Cspan class=\"hljs-keyword\">in\u003C/span> input.variants {\n    \u003Cspan class=\"hljs-keyword\">let\u003C/span> \u003Cspan class=\"hljs-variable\">name\u003C/span> = variant.ident;\n    \u003Cspan class=\"hljs-comment\">// Skip over the Unknown variant since it&#x27;s a special case\u003C/span>\n    \u003Cspan class=\"hljs-keyword\">if\u003C/span> name.\u003Cspan class=\"hljs-title function_ invoke__\">to_string\u003C/span>() == \u003Cspan class=\"hljs-string\">&quot;Unknown&quot;\u003C/span> {\n        \u003Cspan class=\"hljs-keyword\">continue\u003C/span>;\n    }\n\n    \u003Cspan class=\"hljs-comment\">// Get the text contained within our /// comment (i.e. doc = &quot;/// 5 &lt;-&gt;&quot;)\u003C/span>\n    \u003Cspan class=\"hljs-keyword\">let\u003C/span> \u003Cspan class=\"hljs-variable\">doc\u003C/span> = variant.attrs.\u003Cspan class=\"hljs-title function_ invoke__\">first\u003C/span>().\u003Cspan class=\"hljs-title function_ invoke__\">unwrap\u003C/span>().\u003Cspan class=\"hljs-title function_ invoke__\">span\u003C/span>().\u003Cspan class=\"hljs-title function_ invoke__\">source_text\u003C/span>().\u003Cspan class=\"hljs-title function_ invoke__\">unwrap\u003C/span>();\n    \u003Cspan class=\"hljs-comment\">// If we don&#x27;t have a -&gt;, we&#x27;re not sending so skip\u003C/span>\n    \u003Cspan class=\"hljs-keyword\">if\u003C/span> !doc.\u003Cspan class=\"hljs-title function_ invoke__\">contains\u003C/span>(\u003Cspan class=\"hljs-string\">&quot;-&gt;&quot;\u003C/span>) {\n        \u003Cspan class=\"hljs-keyword\">continue\u003C/span>;\n    }\n\n    \u003Cspan class=\"hljs-comment\">// Get the packet code from the comment \u003C/span>\n    \u003Cspan class=\"hljs-keyword\">let\u003C/span> \u003Cspan class=\"hljs-variable\">code\u003C/span>: \u003Cspan class=\"hljs-type\">u8\u003C/span> = doc.\u003Cspan class=\"hljs-title function_ invoke__\">split_whitespace\u003C/span>().\u003Cspan class=\"hljs-title function_ invoke__\">skip\u003C/span>(\u003Cspan class=\"hljs-number\">1\u003C/span>).\u003Cspan class=\"hljs-title function_ invoke__\">next\u003C/span>().\u003Cspan class=\"hljs-title function_ invoke__\">unwrap\u003C/span>().\u003Cspan class=\"hljs-title function_ invoke__\">parse\u003C/span>().\u003Cspan class=\"hljs-title function_ invoke__\">unwrap\u003C/span>();\n}\n\u003C/code>\u003C/pre>\u003Cp>In rust there are three kinds of enum variant fields, \u003Ccode>Named\u003C/code>, \u003Ccode>Unnamed\u003C/code>, and \u003Ccode>Unit\u003C/code>. Named means that the variant contains named fields (i.e. \u003Ccode>X { a: i32, b: f64 }\u003C/code>). Unnamed means that the variant is represented by a tuple (i.e. \u003Ccode>Y(i32, f64, bool)\u003C/code>). \u003Ccode>Unit\u003C/code> means the variant doesn&#39;t store any values (i.e. \u003Ccode>None\u003C/code>). For now, we only have \u003Ccode>Named\u003C/code> fields so let&#39;s deal with that.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-rs\">\u003Cspan class=\"hljs-keyword\">for\u003C/span> \u003Cspan class=\"hljs-variable\">variant\u003C/span> \u003Cspan class=\"hljs-keyword\">in\u003C/span> input.variants {\n    \u003Cspan class=\"hljs-comment\">// ...\u003C/span>\n\n    \u003Cspan class=\"hljs-keyword\">if\u003C/span> \u003Cspan class=\"hljs-keyword\">let\u003C/span> \u003Cspan class=\"hljs-variable\">Fields\u003C/span>::\u003Cspan class=\"hljs-title function_ invoke__\">Named\u003C/span>(field) = variant.fields {\n        \u003Cspan class=\"hljs-comment\">// Store the array of the methods we are calling\u003C/span>\n        \u003Cspan class=\"hljs-keyword\">let\u003C/span> \u003Cspan class=\"hljs-keyword\">mut \u003C/span>\u003Cspan class=\"hljs-variable\">fns\u003C/span> = \u003Cspan class=\"hljs-type\">Vec\u003C/span>::\u003Cspan class=\"hljs-title function_ invoke__\">new\u003C/span>();\n\n        \u003Cspan class=\"hljs-comment\">// Iterate over each named field\u003C/span>\n        \u003Cspan class=\"hljs-keyword\">for\u003C/span> \u003Cspan class=\"hljs-variable\">field\u003C/span> \u003Cspan class=\"hljs-keyword\">in\u003C/span> fields.named {\n            \u003Cspan class=\"hljs-keyword\">let\u003C/span> \u003Cspan class=\"hljs-variable\">name\u003C/span> = field.ident.\u003Cspan class=\"hljs-title function_ invoke__\">as_ref\u003C/span>().\u003Cspan class=\"hljs-title function_ invoke__\">unwrap\u003C/span>();\n            \u003Cspan class=\"hljs-keyword\">if\u003C/span> \u003Cspan class=\"hljs-keyword\">let\u003C/span> \u003Cspan class=\"hljs-variable\">Type\u003C/span>::\u003Cspan class=\"hljs-title function_ invoke__\">Path\u003C/span>(ty) = &amp;field.ty {\n                \u003Cspan class=\"hljs-comment\">// Remember, we made Writer chainable so we can just join these\u003C/span>\n                \u003Cspan class=\"hljs-keyword\">let\u003C/span> \u003Cspan class=\"hljs-variable\">method\u003C/span> = \u003Cspan class=\"hljs-keyword\">match\u003C/span> ty.path.segments.\u003Cspan class=\"hljs-title function_ invoke__\">first\u003C/span>().\u003Cspan class=\"hljs-title function_ invoke__\">unwrap\u003C/span>().ident.\u003Cspan class=\"hljs-title function_ invoke__\">to_string\u003C/span>().\u003Cspan class=\"hljs-title function_ invoke__\">as_str\u003C/span>() {\n                    \u003Cspan class=\"hljs-string\">&quot;bool&quot;\u003C/span> =&gt; quote! { .\u003Cspan class=\"hljs-title function_ invoke__\">write_bool\u003C/span>(data.#name) },\n                    \u003Cspan class=\"hljs-string\">&quot;u8&quot;\u003C/span> =&gt; quote! { .\u003Cspan class=\"hljs-title function_ invoke__\">write_byte\u003C/span>(data.#name) },\n                    \u003Cspan class=\"hljs-string\">&quot;i16&quot;\u003C/span> =&gt; quote! { .\u003Cspan class=\"hljs-title function_ invoke__\">write_i16\u003C/span>(data.#name) },\n                    ty =&gt; quote! { compile_error!(\u003Cspan class=\"hljs-string\">&quot;Unknown type: {}&quot;\u003C/span>, #ty) },\n                }\n                \u003Cspan class=\"hljs-comment\">// Add the method\u003C/span>\n                fns.\u003Cspan class=\"hljs-title function_ invoke__\">push\u003C/span>(method)\n            }\n        }\n\n        \u003Cspan class=\"hljs-comment\">// # embeds the variable and #(#fns)* repeats fns\u003C/span>\n        cases.\u003Cspan class=\"hljs-title function_ invoke__\">push\u003C/span>(quote! { Message::#\u003Cspan class=\"hljs-title function_ invoke__\">name\u003C/span>(data) =&gt; \u003Cspan class=\"hljs-title function_ invoke__\">Ok\u003C/span>(Writer::\u003Cspan class=\"hljs-title function_ invoke__\">new\u003C/span>(#code)#(#fns)*.\u003Cspan class=\"hljs-title function_ invoke__\">finalize\u003C/span>()) })\n    }\n}\n\u003C/code>\u003C/pre>\u003Cp>Cool. What is \u003Ccode>quote!\u003C/code> doing, you may ask. It is taking the Rust code and converting it into a token stream. We now have our cases for each server-sent packet. Let&#39;s finally wrap them up in a match statement and get this show on the road. After our for loop, we are going to have this.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-rs\">\u003Cspan class=\"hljs-keyword\">let\u003C/span> \u003Cspan class=\"hljs-variable\">sendable_from\u003C/span> = TokenStream::\u003Cspan class=\"hljs-title function_ invoke__\">from\u003C/span>(quote! {\n    \u003Cspan class=\"hljs-keyword\">impl\u003C/span>&lt;\u003Cspan class=\"hljs-symbol\">&#x27;a\u003C/span>&gt; TryFrom&lt;Message&lt;\u003Cspan class=\"hljs-symbol\">&#x27;a\u003C/span>&gt;&gt; \u003Cspan class=\"hljs-keyword\">for\u003C/span> \u003Cspan class=\"hljs-title class_\">Vec\u003C/span>&lt;\u003Cspan class=\"hljs-type\">u8\u003C/span>&gt; {\n        \u003Cspan class=\"hljs-keyword\">type\u003C/span> \u003Cspan class=\"hljs-title class_\">Error\u003C/span> = &amp;\u003Cspan class=\"hljs-symbol\">&#x27;static\u003C/span> \u003Cspan class=\"hljs-type\">str\u003C/span>;\n\n        \u003Cspan class=\"hljs-keyword\">fn\u003C/span> \u003Cspan class=\"hljs-title function_\">try_from\u003C/span>(msg: Message) \u003Cspan class=\"hljs-punctuation\">-&gt;\u003C/span> \u003Cspan class=\"hljs-type\">Result\u003C/span>&lt;\u003Cspan class=\"hljs-keyword\">Self\u003C/span>, \u003Cspan class=\"hljs-keyword\">Self\u003C/span>::Error&gt; {\n            \u003Cspan class=\"hljs-keyword\">match\u003C/span> msg {\n                #(#cases),*, \u003Cspan class=\"hljs-comment\">// Join each case by a comma\u003C/span>\n                \u003Cspan class=\"hljs-comment\">// Our beloved special case\u003C/span>\n                Message::\u003Cspan class=\"hljs-title function_ invoke__\">Unknown\u003C/span>(code, buf) =&gt; \u003Cspan class=\"hljs-title function_ invoke__\">Ok\u003C/span>(Writer::\u003Cspan class=\"hljs-title function_ invoke__\">new\u003C/span>(code).\u003Cspan class=\"hljs-title function_ invoke__\">write_bytes\u003C/span>(buf).\u003Cspan class=\"hljs-title function_ invoke__\">finalize\u003C/span>()),\n                _ =&gt; \u003Cspan class=\"hljs-title function_ invoke__\">Err\u003C/span>(\u003Cspan class=\"hljs-string\">&quot;Unserializable message. Consider using Message::Unknown&quot;\u003C/span>),\n            }\n        }\n    }\n});\n\u003C/code>\u003C/pre>\u003Cp>At this point, we are pretty much done. We just have to take our named fields and convert them to unnamed fields with the struct defined somewhere else. The rest of the code is just this.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-rs\">\u003Cspan class=\"hljs-keyword\">let\u003C/span> \u003Cspan class=\"hljs-keyword\">mut \u003C/span>\u003Cspan class=\"hljs-variable\">structs\u003C/span> = \u003Cspan class=\"hljs-type\">Vec\u003C/span>::\u003Cspan class=\"hljs-title function_ invoke__\">new\u003C/span>();\n\u003Cspan class=\"hljs-keyword\">let\u003C/span> \u003Cspan class=\"hljs-keyword\">mut \u003C/span>\u003Cspan class=\"hljs-variable\">variants\u003C/span> = \u003Cspan class=\"hljs-type\">Vec\u003C/span>::\u003Cspan class=\"hljs-title function_ invoke__\">new\u003C/span>();\n\n\u003Cspan class=\"hljs-keyword\">for\u003C/span> \u003Cspan class=\"hljs-variable\">variant\u003C/span> \u003Cspan class=\"hljs-keyword\">in\u003C/span> input.variants {\n    \u003Cspan class=\"hljs-keyword\">if\u003C/span> \u003Cspan class=\"hljs-keyword\">let\u003C/span> \u003Cspan class=\"hljs-variable\">Fields\u003C/span>::\u003Cspan class=\"hljs-title function_ invoke__\">Named\u003C/span>(fields) = variant.fields {\n        \u003Cspan class=\"hljs-keyword\">let\u003C/span> \u003Cspan class=\"hljs-variable\">fields\u003C/span> = fields.named.\u003Cspan class=\"hljs-title function_ invoke__\">iter\u003C/span>(); \u003Cspan class=\"hljs-comment\">// get the fields\u003C/span>\n        \u003Cspan class=\"hljs-keyword\">let\u003C/span> \u003Cspan class=\"hljs-variable\">name\u003C/span> = variant.ident; \u003Cspan class=\"hljs-comment\">// get the name of the variant\u003C/span>\n        structs.\u003Cspan class=\"hljs-title function_ invoke__\">push\u003C/span>(quote! {\n            \u003Cspan class=\"hljs-meta\">#[derive(Debug, Clone)]\u003C/span>\n            \u003Cspan class=\"hljs-comment\">// construct a struct of the same name and fields\u003C/span>\n            \u003Cspan class=\"hljs-keyword\">pub\u003C/span> \u003Cspan class=\"hljs-keyword\">struct\u003C/span> #name {\n                #(#fields),*\n            }\n        });\n        variants.\u003Cspan class=\"hljs-title function_ invoke__\">push\u003C/span>(quote! { #\u003Cspan class=\"hljs-title function_ invoke__\">name\u003C/span>(#name) }) \u003Cspan class=\"hljs-comment\">// the new variant\u003C/span>\n    } \u003Cspan class=\"hljs-keyword\">else\u003C/span> {\n        variants.\u003Cspan class=\"hljs-title function_ invoke__\">push\u003C/span>(quote! { #variant }) \u003Cspan class=\"hljs-comment\">// nothing changes if it&#x27;s not named\u003C/span>\n    }\n}\n\nTokenStream::\u003Cspan class=\"hljs-title function_ invoke__\">from\u003C/span>(quote! {\n    #(#structs)* \u003Cspan class=\"hljs-comment\">// iterate over all our structs\u003C/span>\n    \u003Cspan class=\"hljs-meta\">#[derive(Debug, Clone)]\u003C/span>\n    \u003Cspan class=\"hljs-keyword\">pub\u003C/span> \u003Cspan class=\"hljs-keyword\">enum\u003C/span> \u003Cspan class=\"hljs-title class_\">Message\u003C/span>&lt;\u003Cspan class=\"hljs-symbol\">&#x27;a\u003C/span>&gt; {\n        #(#variants),* \u003Cspan class=\"hljs-comment\">// include all our variants\u003C/span>\n    }\n    #sendable_from \u003Cspan class=\"hljs-comment\">// include our impl TryFrom\u003C/span>\n})\n\u003C/code>\u003C/pre>\u003Cp>There is, of course, much more to this. There are more types besides u8, i16, and bool. There&#39;s also more code for handling the client-sent readable packets. All of that is pretty much just doing what we did here but slightly differently. If you are interested in the full code for the \u003Ca href=\"https://github.com/xDimGG/trust/blob/main/macros/src/lib.rs\">macro\u003C/a>, the \u003Ca href=\"https://github.com/xDimGG/trust/blob/main/src/binary/reader.rs\">reader\u003C/a>, and the \u003Ca href=\"https://github.com/xDimGG/trust/blob/main/src/binary/writer.rs\">writer\u003C/a>, it&#39;s all in the \u003Ca href=\"https://github.com/xDimGG/trust\">repository\u003C/a>.\u003C/p>\n\u003Ch2>Closing Notes\u003C/h2>\n\u003Cp>Macro code can be hard to understand. I created this macro two years ago, and when I came back to it, I couldn&#39;t believe that I wrote it. The whole thing just seemed like gibberish. As a matter of fact, I had no intention to even touch the macro! However, when I tried compiling this project that I haven&#39;t touched in two years with a modern version of Rust, I received the following error.\u003C/p>\n\u003Cpre>\u003Ccode>error[E0512]: cannot transmute between types of different sizes, or dependently-sized types\n   --&gt; C:\\Users\\Dim\\.cargo\\registry\\src\\index.crates.io-6f17d22bba15001f\\socket2-0.3.12\\src\\sockaddr.rs:176:9\n    |\n176 |         mem::transmute::&lt;SocketAddrV4, sockaddr_in&gt;(v4);\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = note: source type: `SocketAddrV4` (48 bits)\n    = note: target type: `SOCKADDR_IN` (128 bits)\n\nFor more information about this error, try `rustc --explain E0512`.\n\u003C/code>\u003C/pre>\u003Cp>After a Google search, \u003Ca href=\"https://users.rust-lang.org/t/error-compiling-old-rust-project/83840\">this error\u003C/a> meant that one of my dependencies is outdated. That dependency turned out to be syn. I was on v1 and needed v2. I upgraded syn to v2, only to find out that the API has slightly changed so some lines were erroring. Because of that, I more or less had to re-understand my entire macro code again, which I really didn&#39;t want to do. Anyway, I did that and fixed it.\u003C/p>\n\u003Cp>However, this got me to thinking. Is there a way I could have made this code more readable? Well, not really. I think proc macros are generally quite hard to read without comments. I could and should probably add a bunch of comments to the code so that future me who was to re-visit this has at least a clue of what&#39;s going on... nahhh. Comments are for chumps.\u003C/p>\n\u003Cp>Anyway, that&#39;s all for now. Until we meet again in part 3.\u003C/p>\n",title:"Writing Sweet Rust Macros (trust pt. 2)",date:1707829348111,tags:["macros","rust","trust"]},{id:"trust-1",content:"{\n\t\"title\": \"Exploring Terraria's Server Protocol (trust pt. 1)\",\n\t\"date\": 1707490172482,\n\t\"tags\": [\"trust\", \"python\", \"tcp\", \"reverse-engineering\"]\n}\n---\n\nGreetings, traveler. Welcome to my series on attempting to implement a game server for [Terraria](https://store.steampowered.com/app/105600/Terraria/), my personal favorite game.\n\n## Motivation\n\nI played Terraria on my X-Box 360 in 2013, on my PC in 2015, and on my phone in 2016. The numbers might not be perfectly accurate, but it's safe to say that I really like the game. I purchased it three times, after all. Since 2018, I've gradually become more interested in servers and reverse engineering.\n\n[TShock](https://github.com/Pryaxis/TShock) is a dedicated Terraria server that uses [Open Terraria API](https://github.com/SignatureBeef/Open-Terraria-API), which rewrites and hooks into the original Terraria server binary to expose the internal Terraria C# API. It works well and is not a Terraria server written from scratch, but rather an extension to the original server.\n\nAfter a bit of searching, it appears that no one has actually fully written a Terraria server from scratch. Perhaps that's for a good reason and I'm doing something stupid here. I wouldn't be surprised if someone has successfully done this before.\n\nI'm still learning Rust, and I'm quite far from basic competency, but I'd like to reverse engineer the server protocol and create a _🚀⚡blazing fast 🚀⚡_ vanilla game server in Rust that I can connect to with the native Terraria client.\n\nBasically, I'm doing this because I like Terraria. I like reverse engineering things. And I want to get better at Rust. I'm not sure how I'll manage discussing implementation details, since most of it is pretty boring. I will try my best to make the content interesting. If you want to see the code, the repository will always be [here](https://github.com/xDimGG/trust).\n\n## Choosing Our Method\n\nWe have two main ways that we can approach this.\n\n1. We can decompile the server executable that is shipped with the Steam game and figure out how it does everything.\n2. We can create a man-in-the-middle proxy server to capture the raw data being sent between client and server.\n\nBefore jumping straight to a disassembler, we should check out what language Terraria is written in. If we google \"what is terraria written in\", we can see that it's written in C#. C# can be decompiled by a variety of software, but my personal favorite is [dotPeek](https://www.jetbrains.com/decompiler/), a free .NET decompiler and assembly browser.\n\n## Decompiling Executables\n\nIf we navigate to Steam, right click on Terraria, go to Properties, go to Local Files, and click Browse, Terraria's folder will open up. There exist two files of interest: `Terraria.exe` and `TerrariaServer.exe`. Let's go ahead and open up the latter in dotPeek. Expanding the Terraria element, we see a plethora of classes and namespaces. I prefer working in VS Code so I exported the project and opened up the folder in there.\n\n![vs code screenshot](/trust-1-1.png)\n\nAt least they're human readable. In here, there are two files that concern us. `MessageBuffer.cs` and `NetMessage.cs`. `NetMessage.cs` has a `SendData` method which takes some parameters and produces a binary message to be sent over the wire. `MessageBuffer.cs` has a `GetData` which uses its internal buffer to parse a binary message.\n\nHold on. How did I pluck out these two methods out of the mess that is 100+ C# files? A lot of poking around is how. I skimmed through a few files and noticed that a lot of them were making calls to `NetMessage.SendData` whenever some the client performs an action. After opening up the file, I found a huge switch statement, so I figured that this method probably had something to do with encoding. I found `MessageBuffer.GetData` through more poking around. The name seemed important and it also had a huge switch statement. Anyway, here's a snippet of what `NetMessage.SendData` looks like:\n\n```cs\npublic static void SendData(\n\tint msgType,\n\tint remoteClient = -1,\n\tint ignoreClient = -1,\n\tNetworkText text = null,\n\tint number = 0,\n\t/* 3 more floats and 3 more ints */\n\t) {\n\t\t// ...\n\t\t// index to our own writer\n\t\tint index1 = 256;\n\t\t// if we are server and are sending to some particular client, use their writer index\n\t\tif (Main.netMode == 2 && remoteClient >= 0)\n\t\t\tindex1 = remoteClient;\n\n\t\tlock (NetMessage.buffer[index1]) {\n\t\t\tBinaryWriter writer = NetMessage.buffer[index1].writer; // get the writer for this \n\t\t\tif (writer == null) {\n\t\t\t\tNetMessage.buffer[index1].ResetWriter();\n\t\t\t\twriter = NetMessage.buffer[index1].writer;\n\t\t\t}\n\t\t\tlong position1 = writer.BaseStream.Position; // get our current position\n\t\t\twriter.BaseStream.Position += 2L; // skip the first two bytes\n\t\t\twriter.Write((byte) msgType); // write a byte containing the message type\n\t\t\tswitch (msgType) { // perform the rest of the encoding based on the message type\n\t\t\t\tcase 1:\n\t\t\t\t\twriter.Write(\"Terraria\" + (object) 279);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 2:\n\t\t\t\t\t// ... all the way up to 147 as of Terraria 1.4.4.9\n\t\t\t}\n\t\t\tint position2 = (int) writer.BaseStream.Position; // get the current length of our data\n\t\t\twriter.BaseStream.Position = position1; // set our buffer position to the start\n\t\t\twriter.Write((ushort) position2); // write our length as the first two bytes\n\t\t\twriter.BaseStream.Position = (long) position2; // move our cursor back to the end\n\t\t\t// ...\n\t\t}\n\t}\n```\n\nIf we go back to `NetMessage`, we can find the following line defining `buffer`.\n\n```cs\npublic BinaryWriter writer;\n```\n\n`BinaryWriter` is just a standard .NET class whose documentation can be found [here](https://learn.microsoft.com/en-us/dotnet/api/system.io.binarywriter.write). If we read the documentation, we see that numbers are written using [little endian byte ordering](https://betterexplained.com/articles/understanding-big-and-little-endian-byte-order/). That's enough C# for now. Let's create a man-in-the-middle proxy server.\n\n## Making an MITM Proxy to Decode Messages\n\nFor those who are not familiar, man-in-the-middle means we will have a server that sits between the client and the server and handles communication. Proxy means we're just passing the information down. What we'll have to do to get this working is start up a legitimate Terraria server on some port, say 7778, and start our proxy server on some other port, say 7777, and have the Terraria client conect to our proxy on port 7777. The proxy will receive data from the client and send it to the server and vice versa.\n\nWhile the packet is in transit, we can log it to see what kind of interesting packets are being sent. This gives us a high-level view of the protocol and will make it easier to figure out what to look for in the C# files. *Spoiler: we may also modify the packet while it is in transit to produce some interesting behavior on the client and server.*\n\nFor this part, I'll just be using Python. It's a good language for prototyping this kinda of thing. First off, let's define our ports and hosts. Everything we're doing will be on localhost so I'm just using one constant to represent both.\n\n```py\nHOST = '127.0.0.1' # localhost\nPORT = 7777  # Port to listen on (non-privileged ports are > 1023)\nREAL_PORT = 7778 # Port on which the actual Terraria server is already running\n```\n\nNow, let's create a TCP server that can handle multiple clients. Handling multiple clients won't be necessary for a while, but it's nice to have.\n\n```py\nimport socket\nfrom threading import Thread\n\ndef start_proxy(client):\n\ttry:\n\t\twith client:\n\t\t\twith socket.socket(socket.AF_INET, socket.SOCK_STREAM) as server:\n\t\t\t\tserver.connect((HOST, REAL_PORT))\n\n\t\t\t\tthreads = [ # we will define copy() in a moment\n\t\t\t\t\tThread(target=copy, args=(client, server, '[c->s]:')),\n\t\t\t\t\tThread(target=copy, args=(server, client, '[s->c]:')),\n\t\t\t\t]\n\t\t\t\tfor t in threads: t.start()\n\t\t\t\tfor t in threads: t.join()\n\n\t\tprint(f'Client has disconnected or true server stopped')\n\texcept:\n\t\tpass\n\nwith socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:\n\ts.bind((HOST, PORT))\n\ts.listen()\n\tprint(f'Proxy started on port {PORT}')\n\n\twhile True:\n\t\tconn, addr = s.accept()\n\t\tprint(f'Client {addr} has connected')\n\t\tt = Thread(target=start_proxy, args=(conn, ))\n\t\tt.start()\n```\n\nWhat is the code doing? Well, we're creating a `socket.socket` as `s`. We pass in `socket.AF_INET` since we are using IPv4 and `socket.SOCK_STREAM` since we are using TCP. Based on what I know about game servers, it is likely that Terraria uses TCP. We could make sure of it by using Wireshark, but this is most likely the case.\n\nNext, we are binding to 127.0.0.1:7777 and calling listen since we are a server. Then we enter an loop where we try to accept incoming connections. `accept` is blocking so nothing happens until someone connects. When someone has connected, we may start a thread for them and pass the connection as an argument. We don't join this thread since we want to be ready for the next client.\n\nThe `start_proxy` function takes a client connection and creates the \"real\" connection with the Terraria server. Our process is now acting as a client, and we can forward messages to and from the server by using the copy() function which we are about to define. *Note: `try: ... except: pass` is used so that our process doesn't crash when someone disconnects or the real server shuts down.*\n\n```py\ndef copy(src, dst, prefix):\n\ttry:\n\t\twhile True:\n\t\t\t# try getting the bytes representing the length of the packet\n\t\t\tdata_size = src.recv(2)\n\t\t\tif not data_size:\n\t\t\t\tbreak\n\n\t\t\t# parse the bytes to an int using LE ordering\n\t\t\t# minus 2 since we're excluding the first two bytes we read\n\t\t\tsize = int.from_bytes(data_size, 'little') - 2\n\t\t\t# try getting the rest of the packet\n\t\t\tdata = src.recv(size)\n\t\t\tif not data:\n\t\t\t\tbreak\n\n\t\t\t# data[0] is our message code\n\t\t\t# data[1:] is the encoded message\n\t\t\tprint(f'{prefix} ({data[0]}) {data[1:].hex()}')\n\t\t\t# forward the message to the receiver\n\t\t\tdst.sendall(data_size + data)\n\texcept:\n\t\tpass\n```\n\nWith that in place and running, we can now start a real Terraria server on port 7778 and connect with the Terraria client to port 7777. The game looks and plays as it normally does, but in the background we are now logging all of the packets being transmitted. Here's what the console looks like:\n\n```\nProxy started on port 7777\nClient ('127.0.0.1', 51183) has connected\n[c->s]: (1) 0b5465727261726961323739\n[s->c]: (37) \n[c->s]: (38) 0870617373776f7264\n[s->c]: (3) 0100\n[c->s]: (4) 0103890364696d00000000fbfbfaf57f5e421c32e5cfd6eadbf6b2bbb8e0abfd001000\n[c->s]: (68) 2430336439363837622d623631372d346435642d396161322d623739316461356332346233\n[c->s]: (16) 0190019001\n[c->s]: (42) 0114001400\n...\n```\n\nSo, the client starts by send a type 1 message with some data after it. Let's recall the C# we looked at earlier.\n\n```cs\ncase 1:\n\twriter.Write(\"Terraria\" + (object) 279);\n\tbreak;\n```\n\nIt seems that the message contains Terraria279. I'm guessing `0b` is the length of the string and `5465727261726961323739` is the string (after being hex encoded). `Terraria279` is 11 digits long and 11 in hex is B so that checks out. Using [this site](https://www.rapidtables.com/convert/number/hex-to-ascii.html), you can convert the hex string to ASCII and see the result. Go on, give it a shot.\n\nOkay, so the client first tells the server what version they're running and if it's compatible, the server responds with a type 37 message. Let's look at the logic for when the server reads a type 1 message from the client. *Remember, message decoding is done by `MessageBuffer.GetData`.*\n\n```cs\ncase 1:\n\t// If we are not a server, ignore this packet.\n\tif (Main.netMode != 2) break;\n\t// Check if this player is IP banned\n\tif (Main.dedServ && Netplay.IsBanned(Netplay.Clients[this.whoAmI].Socket.GetRemoteAddress())) {\n\t\t// Send the player a localization key informing them they are banned\n\t\tNetMessage.TrySendData(2, this.whoAmI, text: Lang.mp[3].ToNetworkText());\n\t\tbreak;\n\t}\n\t// If this client is not on the state 0\n\tif (Netplay.Clients[this.whoAmI].State != 0) break;\n\tif (this.reader.ReadString() == \"Terraria\" + (object) 279) {\n\t\t// If there is no server password, send the client packet 3 and set their state to 1\n\t\tif (string.IsNullOrEmpty(Netplay.ServerPassword)) {\n\t\t\tNetplay.Clients[this.whoAmI].State = 1;\n\t\t\tNetMessage.TrySendData(3, this.whoAmI);\n\t\t\tbreak;\n\t\t}\n\t\t// If there is a password, set the client's state to -1 and send them packet 37\n\t\tNetplay.Clients[this.whoAmI].State = -1;\n\t\tNetMessage.TrySendData(37, this.whoAmI);\n\t\tbreak;\n\t}\n\t// If the version doesn't match, send them this string\n\tNetMessage.TrySendData(2, this.whoAmI, text: Lang.mp[4].ToNetworkText());\n\tbreak;\n```\n\nSomething I haven't mentioned quite yet is that the Terraria server and client code is merged into one. The server is the same as the client but with `Main.dedServer = true`. This differentiation is made throughout the network code by checking if `Main.netMode` is 2. As far as I can tell 1 means client and 2 means server. There is also sometimes 0, which I believe represents a client that is not actively in a world? I'm not exactly sure and it doesn't seem to matter to us.\n\nI have set a password for the server, so it should be sending a type 37 packet, which it does. The client responds with 38 which presumably contains the password I inputted in Terraria. See if you can figure out what the string contains in the line `[c->s]: (38) 0870617373776f7264`.\n\nI think that's enough of explaining the protocol for now. There are so many different packets being sent, so I'll leave the explanation there for now.\n\n## Exploiting the Server\n\nEarlier, I did hint at changing the packet data while in transit. Well, an interesting one to change is the packet for putting an item in a chest. When the client puts an item in a chest, the following packet is received and handled by the server like so.\n\n```cs\ncase 32:\n\tint index28 = (int) this.reader.ReadInt16();\n\tint index29 = (int) this.reader.ReadByte();\n\tint num42 = (int) this.reader.ReadInt16();\n\tint prefixWeWant2 = (int) this.reader.ReadByte();\n\tint type6 = (int) this.reader.ReadInt16();\n\t// ... some sanity checks ...\n\tMain.chest[index28].item[index29].netDefaults(type6);\n\tMain.chest[index28].item[index29].Prefix(prefixWeWant2);\n\tMain.chest[index28].item[index29].stack = num42;\n\tRecipe.FindRecipes(true);\n\tbreak;\n```\n\nMaybe we can change the value of `stack` while in transit to put more items in the chest? Let's try it out by writing the following in our Python method from earlier.\n\n```py\nif data[0] == 32:\n\t# make data a bytearray so we can mutate it\n\tdata = bytearray(data)\n\t# note: message type byte + i16 + byte = 4 bytes\n\t# we want to overwrite bytes 4 and 5 with the new stack number\n\tdata[4:6] = int(999).to_bytes(2, 'little')\n```\n\nAnd that's it! Let's see what happens in-game.\n\n\u003Cvideo src=\"/trust-1-2.mp4\" type=\"video/mp4\" controls>\u003C/video>\n\nExiting and re-entering a chest gives us 999 of what we put in, even if the item isn't stackable. In general, the Terraria server seems to not do any anti-cheat prevention, so modifying packets works pretty often. The Terraria server does have a lot of anti-spam code to prevent clients from rapidly sending messages, projectiles, attack commands, placing blocks, and so on. I assume this is mainly to prevent other clients from crashing.\n\n## Recap\n\n- Terraria uses plain old TCP with no encryption.\n- Terraria is written in C#, for which there are many high-quality disassembly tools available.\n  - dotPeek is pretty good.\n- A Terraria server can't have more than 255 players since each player is represented by a byte identifier.\n- `Terraria.exe` and `TerrariaServer.exe` are very similar. One is just `Main.dedServer = true;` and the other is not.\n- Cheating is fine but crashing other clients is not.\n\n## Conclusion\n\nWe have a lot of work cut out for us. We have to handle [world (.wld) files](https://fileformat.fandom.com/wiki/WLD). We may even have to implement world generation! Or copy it if we're lazy. We may have to parse user files. We have a lot of different packet types to implement. Maybe even fluid simulation. Did you think this would be easy?? Anyway, thanks for reading. See you in [part 2](/blog/trust-2).\n",html:"\u003Cp>Greetings, traveler. Welcome to my series on attempting to implement a game server for \u003Ca href=\"https://store.steampowered.com/app/105600/Terraria/\">Terraria\u003C/a>, my personal favorite game.\u003C/p>\n\u003Ch2>Motivation\u003C/h2>\n\u003Cp>I played Terraria on my X-Box 360 in 2013, on my PC in 2015, and on my phone in 2016. The numbers might not be perfectly accurate, but it&#39;s safe to say that I really like the game. I purchased it three times, after all. Since 2018, I&#39;ve gradually become more interested in servers and reverse engineering.\u003C/p>\n\u003Cp>\u003Ca href=\"https://github.com/Pryaxis/TShock\">TShock\u003C/a> is a dedicated Terraria server that uses \u003Ca href=\"https://github.com/SignatureBeef/Open-Terraria-API\">Open Terraria API\u003C/a>, which rewrites and hooks into the original Terraria server binary to expose the internal Terraria C# API. It works well and is not a Terraria server written from scratch, but rather an extension to the original server.\u003C/p>\n\u003Cp>After a bit of searching, it appears that no one has actually fully written a Terraria server from scratch. Perhaps that&#39;s for a good reason and I&#39;m doing something stupid here. I wouldn&#39;t be surprised if someone has successfully done this before.\u003C/p>\n\u003Cp>I&#39;m still learning Rust, and I&#39;m quite far from basic competency, but I&#39;d like to reverse engineer the server protocol and create a \u003Cem>🚀⚡blazing fast 🚀⚡\u003C/em> vanilla game server in Rust that I can connect to with the native Terraria client.\u003C/p>\n\u003Cp>Basically, I&#39;m doing this because I like Terraria. I like reverse engineering things. And I want to get better at Rust. I&#39;m not sure how I&#39;ll manage discussing implementation details, since most of it is pretty boring. I will try my best to make the content interesting. If you want to see the code, the repository will always be \u003Ca href=\"https://github.com/xDimGG/trust\">here\u003C/a>.\u003C/p>\n\u003Ch2>Choosing Our Method\u003C/h2>\n\u003Cp>We have two main ways that we can approach this.\u003C/p>\n\u003Col>\n\u003Cli>We can decompile the server executable that is shipped with the Steam game and figure out how it does everything.\u003C/li>\n\u003Cli>We can create a man-in-the-middle proxy server to capture the raw data being sent between client and server.\u003C/li>\n\u003C/ol>\n\u003Cp>Before jumping straight to a disassembler, we should check out what language Terraria is written in. If we google &quot;what is terraria written in&quot;, we can see that it&#39;s written in C#. C# can be decompiled by a variety of software, but my personal favorite is \u003Ca href=\"https://www.jetbrains.com/decompiler/\">dotPeek\u003C/a>, a free .NET decompiler and assembly browser.\u003C/p>\n\u003Ch2>Decompiling Executables\u003C/h2>\n\u003Cp>If we navigate to Steam, right click on Terraria, go to Properties, go to Local Files, and click Browse, Terraria&#39;s folder will open up. There exist two files of interest: \u003Ccode>Terraria.exe\u003C/code> and \u003Ccode>TerrariaServer.exe\u003C/code>. Let&#39;s go ahead and open up the latter in dotPeek. Expanding the Terraria element, we see a plethora of classes and namespaces. I prefer working in VS Code so I exported the project and opened up the folder in there.\u003C/p>\n\u003Cp>\u003Cimg src=\"/trust-1-1.png\" alt=\"vs code screenshot\">\u003C/p>\n\u003Cp>At least they&#39;re human readable. In here, there are two files that concern us. \u003Ccode>MessageBuffer.cs\u003C/code> and \u003Ccode>NetMessage.cs\u003C/code>. \u003Ccode>NetMessage.cs\u003C/code> has a \u003Ccode>SendData\u003C/code> method which takes some parameters and produces a binary message to be sent over the wire. \u003Ccode>MessageBuffer.cs\u003C/code> has a \u003Ccode>GetData\u003C/code> which uses its internal buffer to parse a binary message.\u003C/p>\n\u003Cp>Hold on. How did I pluck out these two methods out of the mess that is 100+ C# files? A lot of poking around is how. I skimmed through a few files and noticed that a lot of them were making calls to \u003Ccode>NetMessage.SendData\u003C/code> whenever some the client performs an action. After opening up the file, I found a huge switch statement, so I figured that this method probably had something to do with encoding. I found \u003Ccode>MessageBuffer.GetData\u003C/code> through more poking around. The name seemed important and it also had a huge switch statement. Anyway, here&#39;s a snippet of what \u003Ccode>NetMessage.SendData\u003C/code> looks like:\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-cs\">\u003Cspan class=\"hljs-function\">\u003Cspan class=\"hljs-keyword\">public\u003C/span> \u003Cspan class=\"hljs-keyword\">static\u003C/span> \u003Cspan class=\"hljs-keyword\">void\u003C/span> \u003Cspan class=\"hljs-title\">SendData\u003C/span>(\u003Cspan class=\"hljs-params\">\n    \u003Cspan class=\"hljs-built_in\">int\u003C/span> msgType,\n    \u003Cspan class=\"hljs-built_in\">int\u003C/span> remoteClient = \u003Cspan class=\"hljs-number\">-1\u003C/span>,\n    \u003Cspan class=\"hljs-built_in\">int\u003C/span> ignoreClient = \u003Cspan class=\"hljs-number\">-1\u003C/span>,\n    NetworkText text = \u003Cspan class=\"hljs-literal\">null\u003C/span>,\n    \u003Cspan class=\"hljs-built_in\">int\u003C/span> number = \u003Cspan class=\"hljs-number\">0\u003C/span>,\n    \u003Cspan class=\"hljs-comment\">/* 3 more floats and 3 more ints */\u003C/span>\n    \u003C/span>)\u003C/span> {\n        \u003Cspan class=\"hljs-comment\">// ...\u003C/span>\n        \u003Cspan class=\"hljs-comment\">// index to our own writer\u003C/span>\n        \u003Cspan class=\"hljs-built_in\">int\u003C/span> index1 = \u003Cspan class=\"hljs-number\">256\u003C/span>;\n        \u003Cspan class=\"hljs-comment\">// if we are server and are sending to some particular client, use their writer index\u003C/span>\n        \u003Cspan class=\"hljs-keyword\">if\u003C/span> (Main.netMode == \u003Cspan class=\"hljs-number\">2\u003C/span> &amp;&amp; remoteClient &gt;= \u003Cspan class=\"hljs-number\">0\u003C/span>)\n            index1 = remoteClient;\n\n        \u003Cspan class=\"hljs-keyword\">lock\u003C/span> (NetMessage.buffer[index1]) {\n            BinaryWriter writer = NetMessage.buffer[index1].writer; \u003Cspan class=\"hljs-comment\">// get the writer for this \u003C/span>\n            \u003Cspan class=\"hljs-keyword\">if\u003C/span> (writer == \u003Cspan class=\"hljs-literal\">null\u003C/span>) {\n                NetMessage.buffer[index1].ResetWriter();\n                writer = NetMessage.buffer[index1].writer;\n            }\n            \u003Cspan class=\"hljs-built_in\">long\u003C/span> position1 = writer.BaseStream.Position; \u003Cspan class=\"hljs-comment\">// get our current position\u003C/span>\n            writer.BaseStream.Position += \u003Cspan class=\"hljs-number\">2L\u003C/span>; \u003Cspan class=\"hljs-comment\">// skip the first two bytes\u003C/span>\n            writer.Write((\u003Cspan class=\"hljs-built_in\">byte\u003C/span>) msgType); \u003Cspan class=\"hljs-comment\">// write a byte containing the message type\u003C/span>\n            \u003Cspan class=\"hljs-keyword\">switch\u003C/span> (msgType) { \u003Cspan class=\"hljs-comment\">// perform the rest of the encoding based on the message type\u003C/span>\n                \u003Cspan class=\"hljs-keyword\">case\u003C/span> \u003Cspan class=\"hljs-number\">1\u003C/span>:\n                    writer.Write(\u003Cspan class=\"hljs-string\">&quot;Terraria&quot;\u003C/span> + (\u003Cspan class=\"hljs-built_in\">object\u003C/span>) \u003Cspan class=\"hljs-number\">279\u003C/span>);\n                    \u003Cspan class=\"hljs-keyword\">break\u003C/span>;\n                \u003Cspan class=\"hljs-keyword\">case\u003C/span> \u003Cspan class=\"hljs-number\">2\u003C/span>:\n                    \u003Cspan class=\"hljs-comment\">// ... all the way up to 147 as of Terraria 1.4.4.9\u003C/span>\n            }\n            \u003Cspan class=\"hljs-built_in\">int\u003C/span> position2 = (\u003Cspan class=\"hljs-built_in\">int\u003C/span>) writer.BaseStream.Position; \u003Cspan class=\"hljs-comment\">// get the current length of our data\u003C/span>\n            writer.BaseStream.Position = position1; \u003Cspan class=\"hljs-comment\">// set our buffer position to the start\u003C/span>\n            writer.Write((\u003Cspan class=\"hljs-built_in\">ushort\u003C/span>) position2); \u003Cspan class=\"hljs-comment\">// write our length as the first two bytes\u003C/span>\n            writer.BaseStream.Position = (\u003Cspan class=\"hljs-built_in\">long\u003C/span>) position2; \u003Cspan class=\"hljs-comment\">// move our cursor back to the end\u003C/span>\n            \u003Cspan class=\"hljs-comment\">// ...\u003C/span>\n        }\n    }\n\u003C/code>\u003C/pre>\u003Cp>If we go back to \u003Ccode>NetMessage\u003C/code>, we can find the following line defining \u003Ccode>buffer\u003C/code>.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-cs\">\u003Cspan class=\"hljs-keyword\">public\u003C/span> BinaryWriter writer;\n\u003C/code>\u003C/pre>\u003Cp>\u003Ccode>BinaryWriter\u003C/code> is just a standard .NET class whose documentation can be found \u003Ca href=\"https://learn.microsoft.com/en-us/dotnet/api/system.io.binarywriter.write\">here\u003C/a>. If we read the documentation, we see that numbers are written using \u003Ca href=\"https://betterexplained.com/articles/understanding-big-and-little-endian-byte-order/\">little endian byte ordering\u003C/a>. That&#39;s enough C# for now. Let&#39;s create a man-in-the-middle proxy server.\u003C/p>\n\u003Ch2>Making an MITM Proxy to Decode Messages\u003C/h2>\n\u003Cp>For those who are not familiar, man-in-the-middle means we will have a server that sits between the client and the server and handles communication. Proxy means we&#39;re just passing the information down. What we&#39;ll have to do to get this working is start up a legitimate Terraria server on some port, say 7778, and start our proxy server on some other port, say 7777, and have the Terraria client conect to our proxy on port 7777. The proxy will receive data from the client and send it to the server and vice versa.\u003C/p>\n\u003Cp>While the packet is in transit, we can log it to see what kind of interesting packets are being sent. This gives us a high-level view of the protocol and will make it easier to figure out what to look for in the C# files. \u003Cem>Spoiler: we may also modify the packet while it is in transit to produce some interesting behavior on the client and server.\u003C/em>\u003C/p>\n\u003Cp>For this part, I&#39;ll just be using Python. It&#39;s a good language for prototyping this kinda of thing. First off, let&#39;s define our ports and hosts. Everything we&#39;re doing will be on localhost so I&#39;m just using one constant to represent both.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-py\">HOST = \u003Cspan class=\"hljs-string\">&#x27;127.0.0.1&#x27;\u003C/span> \u003Cspan class=\"hljs-comment\"># localhost\u003C/span>\nPORT = \u003Cspan class=\"hljs-number\">7777\u003C/span>  \u003Cspan class=\"hljs-comment\"># Port to listen on (non-privileged ports are &gt; 1023)\u003C/span>\nREAL_PORT = \u003Cspan class=\"hljs-number\">7778\u003C/span> \u003Cspan class=\"hljs-comment\"># Port on which the actual Terraria server is already running\u003C/span>\n\u003C/code>\u003C/pre>\u003Cp>Now, let&#39;s create a TCP server that can handle multiple clients. Handling multiple clients won&#39;t be necessary for a while, but it&#39;s nice to have.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-py\">\u003Cspan class=\"hljs-keyword\">import\u003C/span> socket\n\u003Cspan class=\"hljs-keyword\">from\u003C/span> threading \u003Cspan class=\"hljs-keyword\">import\u003C/span> Thread\n\n\u003Cspan class=\"hljs-keyword\">def\u003C/span> \u003Cspan class=\"hljs-title function_\">start_proxy\u003C/span>(\u003Cspan class=\"hljs-params\">client\u003C/span>):\n    \u003Cspan class=\"hljs-keyword\">try\u003C/span>:\n        \u003Cspan class=\"hljs-keyword\">with\u003C/span> client:\n            \u003Cspan class=\"hljs-keyword\">with\u003C/span> socket.socket(socket.AF_INET, socket.SOCK_STREAM) \u003Cspan class=\"hljs-keyword\">as\u003C/span> server:\n                server.connect((HOST, REAL_PORT))\n\n                threads = [ \u003Cspan class=\"hljs-comment\"># we will define copy() in a moment\u003C/span>\n                    Thread(target=copy, args=(client, server, \u003Cspan class=\"hljs-string\">&#x27;[c-&gt;s]:&#x27;\u003C/span>)),\n                    Thread(target=copy, args=(server, client, \u003Cspan class=\"hljs-string\">&#x27;[s-&gt;c]:&#x27;\u003C/span>)),\n                ]\n                \u003Cspan class=\"hljs-keyword\">for\u003C/span> t \u003Cspan class=\"hljs-keyword\">in\u003C/span> threads: t.start()\n                \u003Cspan class=\"hljs-keyword\">for\u003C/span> t \u003Cspan class=\"hljs-keyword\">in\u003C/span> threads: t.join()\n\n        \u003Cspan class=\"hljs-built_in\">print\u003C/span>(\u003Cspan class=\"hljs-string\">f&#x27;Client has disconnected or true server stopped&#x27;\u003C/span>)\n    \u003Cspan class=\"hljs-keyword\">except\u003C/span>:\n        \u003Cspan class=\"hljs-keyword\">pass\u003C/span>\n\n\u003Cspan class=\"hljs-keyword\">with\u003C/span> socket.socket(socket.AF_INET, socket.SOCK_STREAM) \u003Cspan class=\"hljs-keyword\">as\u003C/span> s:\n    s.bind((HOST, PORT))\n    s.listen()\n    \u003Cspan class=\"hljs-built_in\">print\u003C/span>(\u003Cspan class=\"hljs-string\">f&#x27;Proxy started on port \u003Cspan class=\"hljs-subst\">{PORT}\u003C/span>&#x27;\u003C/span>)\n\n    \u003Cspan class=\"hljs-keyword\">while\u003C/span> \u003Cspan class=\"hljs-literal\">True\u003C/span>:\n        conn, addr = s.accept()\n        \u003Cspan class=\"hljs-built_in\">print\u003C/span>(\u003Cspan class=\"hljs-string\">f&#x27;Client \u003Cspan class=\"hljs-subst\">{addr}\u003C/span> has connected&#x27;\u003C/span>)\n        t = Thread(target=start_proxy, args=(conn, ))\n        t.start()\n\u003C/code>\u003C/pre>\u003Cp>What is the code doing? Well, we&#39;re creating a \u003Ccode>socket.socket\u003C/code> as \u003Ccode>s\u003C/code>. We pass in \u003Ccode>socket.AF_INET\u003C/code> since we are using IPv4 and \u003Ccode>socket.SOCK_STREAM\u003C/code> since we are using TCP. Based on what I know about game servers, it is likely that Terraria uses TCP. We could make sure of it by using Wireshark, but this is most likely the case.\u003C/p>\n\u003Cp>Next, we are binding to 127.0.0.1:7777 and calling listen since we are a server. Then we enter an loop where we try to accept incoming connections. \u003Ccode>accept\u003C/code> is blocking so nothing happens until someone connects. When someone has connected, we may start a thread for them and pass the connection as an argument. We don&#39;t join this thread since we want to be ready for the next client.\u003C/p>\n\u003Cp>The \u003Ccode>start_proxy\u003C/code> function takes a client connection and creates the &quot;real&quot; connection with the Terraria server. Our process is now acting as a client, and we can forward messages to and from the server by using the copy() function which we are about to define. \u003Cem>Note: \u003Ccode>try: ... except: pass\u003C/code> is used so that our process doesn&#39;t crash when someone disconnects or the real server shuts down.\u003C/em>\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-py\">\u003Cspan class=\"hljs-keyword\">def\u003C/span> \u003Cspan class=\"hljs-title function_\">copy\u003C/span>(\u003Cspan class=\"hljs-params\">src, dst, prefix\u003C/span>):\n    \u003Cspan class=\"hljs-keyword\">try\u003C/span>:\n        \u003Cspan class=\"hljs-keyword\">while\u003C/span> \u003Cspan class=\"hljs-literal\">True\u003C/span>:\n            \u003Cspan class=\"hljs-comment\"># try getting the bytes representing the length of the packet\u003C/span>\n            data_size = src.recv(\u003Cspan class=\"hljs-number\">2\u003C/span>)\n            \u003Cspan class=\"hljs-keyword\">if\u003C/span> \u003Cspan class=\"hljs-keyword\">not\u003C/span> data_size:\n                \u003Cspan class=\"hljs-keyword\">break\u003C/span>\n\n            \u003Cspan class=\"hljs-comment\"># parse the bytes to an int using LE ordering\u003C/span>\n            \u003Cspan class=\"hljs-comment\"># minus 2 since we&#x27;re excluding the first two bytes we read\u003C/span>\n            size = \u003Cspan class=\"hljs-built_in\">int\u003C/span>.from_bytes(data_size, \u003Cspan class=\"hljs-string\">&#x27;little&#x27;\u003C/span>) - \u003Cspan class=\"hljs-number\">2\u003C/span>\n            \u003Cspan class=\"hljs-comment\"># try getting the rest of the packet\u003C/span>\n            data = src.recv(size)\n            \u003Cspan class=\"hljs-keyword\">if\u003C/span> \u003Cspan class=\"hljs-keyword\">not\u003C/span> data:\n                \u003Cspan class=\"hljs-keyword\">break\u003C/span>\n\n            \u003Cspan class=\"hljs-comment\"># data[0] is our message code\u003C/span>\n            \u003Cspan class=\"hljs-comment\"># data[1:] is the encoded message\u003C/span>\n            \u003Cspan class=\"hljs-built_in\">print\u003C/span>(\u003Cspan class=\"hljs-string\">f&#x27;\u003Cspan class=\"hljs-subst\">{prefix}\u003C/span> (\u003Cspan class=\"hljs-subst\">{data[\u003Cspan class=\"hljs-number\">0\u003C/span>]}\u003C/span>) \u003Cspan class=\"hljs-subst\">{data[\u003Cspan class=\"hljs-number\">1\u003C/span>:].\u003Cspan class=\"hljs-built_in\">hex\u003C/span>()}\u003C/span>&#x27;\u003C/span>)\n            \u003Cspan class=\"hljs-comment\"># forward the message to the receiver\u003C/span>\n            dst.sendall(data_size + data)\n    \u003Cspan class=\"hljs-keyword\">except\u003C/span>:\n        \u003Cspan class=\"hljs-keyword\">pass\u003C/span>\n\u003C/code>\u003C/pre>\u003Cp>With that in place and running, we can now start a real Terraria server on port 7778 and connect with the Terraria client to port 7777. The game looks and plays as it normally does, but in the background we are now logging all of the packets being transmitted. Here&#39;s what the console looks like:\u003C/p>\n\u003Cpre>\u003Ccode>Proxy started on port 7777\nClient (&#x27;127.0.0.1&#x27;, 51183) has connected\n[c-&gt;s]: (1) 0b5465727261726961323739\n[s-&gt;c]: (37) \n[c-&gt;s]: (38) 0870617373776f7264\n[s-&gt;c]: (3) 0100\n[c-&gt;s]: (4) 0103890364696d00000000fbfbfaf57f5e421c32e5cfd6eadbf6b2bbb8e0abfd001000\n[c-&gt;s]: (68) 2430336439363837622d623631372d346435642d396161322d623739316461356332346233\n[c-&gt;s]: (16) 0190019001\n[c-&gt;s]: (42) 0114001400\n...\n\u003C/code>\u003C/pre>\u003Cp>So, the client starts by send a type 1 message with some data after it. Let&#39;s recall the C# we looked at earlier.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-cs\">\u003Cspan class=\"hljs-keyword\">case\u003C/span> \u003Cspan class=\"hljs-number\">1\u003C/span>:\n    writer.Write(\u003Cspan class=\"hljs-string\">&quot;Terraria&quot;\u003C/span> + (\u003Cspan class=\"hljs-built_in\">object\u003C/span>) \u003Cspan class=\"hljs-number\">279\u003C/span>);\n    \u003Cspan class=\"hljs-keyword\">break\u003C/span>;\n\u003C/code>\u003C/pre>\u003Cp>It seems that the message contains Terraria279. I&#39;m guessing \u003Ccode>0b\u003C/code> is the length of the string and \u003Ccode>5465727261726961323739\u003C/code> is the string (after being hex encoded). \u003Ccode>Terraria279\u003C/code> is 11 digits long and 11 in hex is B so that checks out. Using \u003Ca href=\"https://www.rapidtables.com/convert/number/hex-to-ascii.html\">this site\u003C/a>, you can convert the hex string to ASCII and see the result. Go on, give it a shot.\u003C/p>\n\u003Cp>Okay, so the client first tells the server what version they&#39;re running and if it&#39;s compatible, the server responds with a type 37 message. Let&#39;s look at the logic for when the server reads a type 1 message from the client. \u003Cem>Remember, message decoding is done by \u003Ccode>MessageBuffer.GetData\u003C/code>.\u003C/em>\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-cs\">\u003Cspan class=\"hljs-keyword\">case\u003C/span> \u003Cspan class=\"hljs-number\">1\u003C/span>:\n    \u003Cspan class=\"hljs-comment\">// If we are not a server, ignore this packet.\u003C/span>\n    \u003Cspan class=\"hljs-keyword\">if\u003C/span> (Main.netMode != \u003Cspan class=\"hljs-number\">2\u003C/span>) \u003Cspan class=\"hljs-keyword\">break\u003C/span>;\n    \u003Cspan class=\"hljs-comment\">// Check if this player is IP banned\u003C/span>\n    \u003Cspan class=\"hljs-keyword\">if\u003C/span> (Main.dedServ &amp;&amp; Netplay.IsBanned(Netplay.Clients[\u003Cspan class=\"hljs-keyword\">this\u003C/span>.whoAmI].Socket.GetRemoteAddress())) {\n        \u003Cspan class=\"hljs-comment\">// Send the player a localization key informing them they are banned\u003C/span>\n        NetMessage.TrySendData(\u003Cspan class=\"hljs-number\">2\u003C/span>, \u003Cspan class=\"hljs-keyword\">this\u003C/span>.whoAmI, text: Lang.mp[\u003Cspan class=\"hljs-number\">3\u003C/span>].ToNetworkText());\n        \u003Cspan class=\"hljs-keyword\">break\u003C/span>;\n    }\n    \u003Cspan class=\"hljs-comment\">// If this client is not on the state 0\u003C/span>\n    \u003Cspan class=\"hljs-keyword\">if\u003C/span> (Netplay.Clients[\u003Cspan class=\"hljs-keyword\">this\u003C/span>.whoAmI].State != \u003Cspan class=\"hljs-number\">0\u003C/span>) \u003Cspan class=\"hljs-keyword\">break\u003C/span>;\n    \u003Cspan class=\"hljs-keyword\">if\u003C/span> (\u003Cspan class=\"hljs-keyword\">this\u003C/span>.reader.ReadString() == \u003Cspan class=\"hljs-string\">&quot;Terraria&quot;\u003C/span> + (\u003Cspan class=\"hljs-built_in\">object\u003C/span>) \u003Cspan class=\"hljs-number\">279\u003C/span>) {\n        \u003Cspan class=\"hljs-comment\">// If there is no server password, send the client packet 3 and set their state to 1\u003C/span>\n        \u003Cspan class=\"hljs-keyword\">if\u003C/span> (\u003Cspan class=\"hljs-built_in\">string\u003C/span>.IsNullOrEmpty(Netplay.ServerPassword)) {\n            Netplay.Clients[\u003Cspan class=\"hljs-keyword\">this\u003C/span>.whoAmI].State = \u003Cspan class=\"hljs-number\">1\u003C/span>;\n            NetMessage.TrySendData(\u003Cspan class=\"hljs-number\">3\u003C/span>, \u003Cspan class=\"hljs-keyword\">this\u003C/span>.whoAmI);\n            \u003Cspan class=\"hljs-keyword\">break\u003C/span>;\n        }\n        \u003Cspan class=\"hljs-comment\">// If there is a password, set the client&#x27;s state to -1 and send them packet 37\u003C/span>\n        Netplay.Clients[\u003Cspan class=\"hljs-keyword\">this\u003C/span>.whoAmI].State = \u003Cspan class=\"hljs-number\">-1\u003C/span>;\n        NetMessage.TrySendData(\u003Cspan class=\"hljs-number\">37\u003C/span>, \u003Cspan class=\"hljs-keyword\">this\u003C/span>.whoAmI);\n        \u003Cspan class=\"hljs-keyword\">break\u003C/span>;\n    }\n    \u003Cspan class=\"hljs-comment\">// If the version doesn&#x27;t match, send them this string\u003C/span>\n    NetMessage.TrySendData(\u003Cspan class=\"hljs-number\">2\u003C/span>, \u003Cspan class=\"hljs-keyword\">this\u003C/span>.whoAmI, text: Lang.mp[\u003Cspan class=\"hljs-number\">4\u003C/span>].ToNetworkText());\n    \u003Cspan class=\"hljs-keyword\">break\u003C/span>;\n\u003C/code>\u003C/pre>\u003Cp>Something I haven&#39;t mentioned quite yet is that the Terraria server and client code is merged into one. The server is the same as the client but with \u003Ccode>Main.dedServer = true\u003C/code>. This differentiation is made throughout the network code by checking if \u003Ccode>Main.netMode\u003C/code> is 2. As far as I can tell 1 means client and 2 means server. There is also sometimes 0, which I believe represents a client that is not actively in a world? I&#39;m not exactly sure and it doesn&#39;t seem to matter to us.\u003C/p>\n\u003Cp>I have set a password for the server, so it should be sending a type 37 packet, which it does. The client responds with 38 which presumably contains the password I inputted in Terraria. See if you can figure out what the string contains in the line \u003Ccode>[c-&gt;s]: (38) 0870617373776f7264\u003C/code>.\u003C/p>\n\u003Cp>I think that&#39;s enough of explaining the protocol for now. There are so many different packets being sent, so I&#39;ll leave the explanation there for now.\u003C/p>\n\u003Ch2>Exploiting the Server\u003C/h2>\n\u003Cp>Earlier, I did hint at changing the packet data while in transit. Well, an interesting one to change is the packet for putting an item in a chest. When the client puts an item in a chest, the following packet is received and handled by the server like so.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-cs\">\u003Cspan class=\"hljs-keyword\">case\u003C/span> \u003Cspan class=\"hljs-number\">32\u003C/span>:\n    \u003Cspan class=\"hljs-built_in\">int\u003C/span> index28 = (\u003Cspan class=\"hljs-built_in\">int\u003C/span>) \u003Cspan class=\"hljs-keyword\">this\u003C/span>.reader.ReadInt16();\n    \u003Cspan class=\"hljs-built_in\">int\u003C/span> index29 = (\u003Cspan class=\"hljs-built_in\">int\u003C/span>) \u003Cspan class=\"hljs-keyword\">this\u003C/span>.reader.ReadByte();\n    \u003Cspan class=\"hljs-built_in\">int\u003C/span> num42 = (\u003Cspan class=\"hljs-built_in\">int\u003C/span>) \u003Cspan class=\"hljs-keyword\">this\u003C/span>.reader.ReadInt16();\n    \u003Cspan class=\"hljs-built_in\">int\u003C/span> prefixWeWant2 = (\u003Cspan class=\"hljs-built_in\">int\u003C/span>) \u003Cspan class=\"hljs-keyword\">this\u003C/span>.reader.ReadByte();\n    \u003Cspan class=\"hljs-built_in\">int\u003C/span> type6 = (\u003Cspan class=\"hljs-built_in\">int\u003C/span>) \u003Cspan class=\"hljs-keyword\">this\u003C/span>.reader.ReadInt16();\n    \u003Cspan class=\"hljs-comment\">// ... some sanity checks ...\u003C/span>\n    Main.chest[index28].item[index29].netDefaults(type6);\n    Main.chest[index28].item[index29].Prefix(prefixWeWant2);\n    Main.chest[index28].item[index29].stack = num42;\n    Recipe.FindRecipes(\u003Cspan class=\"hljs-literal\">true\u003C/span>);\n    \u003Cspan class=\"hljs-keyword\">break\u003C/span>;\n\u003C/code>\u003C/pre>\u003Cp>Maybe we can change the value of \u003Ccode>stack\u003C/code> while in transit to put more items in the chest? Let&#39;s try it out by writing the following in our Python method from earlier.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-py\">\u003Cspan class=\"hljs-keyword\">if\u003C/span> data[\u003Cspan class=\"hljs-number\">0\u003C/span>] == \u003Cspan class=\"hljs-number\">32\u003C/span>:\n    \u003Cspan class=\"hljs-comment\"># make data a bytearray so we can mutate it\u003C/span>\n    data = \u003Cspan class=\"hljs-built_in\">bytearray\u003C/span>(data)\n    \u003Cspan class=\"hljs-comment\"># note: message type byte + i16 + byte = 4 bytes\u003C/span>\n    \u003Cspan class=\"hljs-comment\"># we want to overwrite bytes 4 and 5 with the new stack number\u003C/span>\n    data[\u003Cspan class=\"hljs-number\">4\u003C/span>:\u003Cspan class=\"hljs-number\">6\u003C/span>] = \u003Cspan class=\"hljs-built_in\">int\u003C/span>(\u003Cspan class=\"hljs-number\">999\u003C/span>).to_bytes(\u003Cspan class=\"hljs-number\">2\u003C/span>, \u003Cspan class=\"hljs-string\">&#x27;little&#x27;\u003C/span>)\n\u003C/code>\u003C/pre>\u003Cp>And that&#39;s it! Let&#39;s see what happens in-game.\u003C/p>\n\u003Cp>\u003Cvideo src=\"/trust-1-2.mp4\" type=\"video/mp4\" controls>\u003C/video>\u003C/p>\n\u003Cp>Exiting and re-entering a chest gives us 999 of what we put in, even if the item isn&#39;t stackable. In general, the Terraria server seems to not do any anti-cheat prevention, so modifying packets works pretty often. The Terraria server does have a lot of anti-spam code to prevent clients from rapidly sending messages, projectiles, attack commands, placing blocks, and so on. I assume this is mainly to prevent other clients from crashing.\u003C/p>\n\u003Ch2>Recap\u003C/h2>\n\u003Cul>\n\u003Cli>Terraria uses plain old TCP with no encryption.\u003C/li>\n\u003Cli>Terraria is written in C#, for which there are many high-quality disassembly tools available.\u003Cul>\n\u003Cli>dotPeek is pretty good.\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>A Terraria server can&#39;t have more than 255 players since each player is represented by a byte identifier.\u003C/li>\n\u003Cli>\u003Ccode>Terraria.exe\u003C/code> and \u003Ccode>TerrariaServer.exe\u003C/code> are very similar. One is just \u003Ccode>Main.dedServer = true;\u003C/code> and the other is not.\u003C/li>\n\u003Cli>Cheating is fine but crashing other clients is not.\u003C/li>\n\u003C/ul>\n\u003Ch2>Conclusion\u003C/h2>\n\u003Cp>We have a lot of work cut out for us. We have to handle \u003Ca href=\"https://fileformat.fandom.com/wiki/WLD\">world (.wld) files\u003C/a>. We may even have to implement world generation! Or copy it if we&#39;re lazy. We may have to parse user files. We have a lot of different packet types to implement. Maybe even fluid simulation. Did you think this would be easy?? Anyway, thanks for reading. See you in \u003Ca href=\"/blog/trust-2\">part 2\u003C/a>.\u003C/p>\n",title:"Exploring Terraria's Server Protocol (trust pt. 1)",date:1707490172482,tags:["python","reverse-engineering","tcp","trust"]},{id:"rce",content:"{\n\t\"title\": \"Finding Deals on UberEats with Node.js and GitHub Actions\",\n\t\"date\": 1707239672851,\n\t\"tags\": [\"scraping\", \"javascript\", \"github-actions\", \"puppeteer\"]\n}\n---\n\nHow I was able to snag up UberEats buy-one-get-one-free (BOGO) deals from UberEats in my area. [TL](https://recurse-eats.dim.codes/);[DR](https://github.com/xDimGG/recurse-ubereats/).\n\n## Background\n\nI recently started my batch at [Recurse Center](https://www.recurse.com/about). Although I have been learning a lot and having a good time with all the people here, the food in this area is awfully expensive, and on some days I don't have time to prepare lunch at home. I looked at a couple of food delivery sites like DoorDash, GrubHub, etc. As it turns out, UberEats routinely offers BOGO deals at a good number of restaurants. It was very annoying to sift through all the nearby restaurants for what offers they have, so I wanted a way to quickly view all of the items that had an offer going on.\n\n![UberEats Search](/rce_1.png)\n\n## Investigation\n\nAs it turns out, UberEats doesn't really want you scraping their site. Most API endpoints have obscure names, the URL is encoded in some strange way, and the React state is quite annoyingly obfuscated. It's okay, though. As with any sort of reverse engineering, anything is possible (unless you encounter CAPTCHA, then you go on a long walk and consider whether all this is even worth it). Let's start with something simple.\n\n### The URL\n\nFirst off, we need to find restaurants in our area, so let's navigate to UberEats and search for the current address (for Recurse Center, that's 397 Bridge St). On this page, we can see restaurants in our area. Let's try and pick apart the URL.\n\n```\nhttps://www.ubereats.com/feed\n\t?diningMode=PICKUP\n\t&pl=JTdCJTIyYWRkcmVzcyUyMiUzQSUyMjM5NyUyMEJyaWRnZSUyMFN0JTIyJTJDJTIycmVmZXJlbmNlJTIyJTNBJTIyaGVyZSUzQWFmJTNBc3RyZWV0c2VjdGlvbiUzQWRrcFQwMXY0d3p1N1VEWHp3MFBvTUElM0FDZ2NJQkNEUHQtVWpFQUVhQXpNNU53JTIyJTJDJTIycmVmZXJlbmNlVHlwZSUyMiUzQSUyMmhlcmVfcGxhY2VzJTIyJTJDJTIybGF0aXR1ZGUlMjIlM0E0MC42OTEzNiUyQyUyMmxvbmdpdHVkZSUyMiUzQS03My45ODUyJTdE\n```\n\nOf course, `diningMode` is either `PICKUP` or `DELIVERY`. Since my goal here is to save money, not spend it, we are going to be using `PICKUP` and not `DELIVERY`. As for the second parameter, `pl`, it definitely seems a bit trickier. Based on my years of professional hacking, I am going to take a guess and say that this is just Base64 encoded. You can try plugging this into an online Base64 decoder or do what I do and just use [`atob`](https://developer.mozilla.org/en-US/docs/Web/API/atob) from the Chrome console.\n\n```js\n> atob('JTdCJTIyYWRkcmVzcyUyMiUzQSUyMjM5NyUyMEJyaWRnZSUyMFN0JTIyJTJDJTIycmVmZXJlbmNlJTIyJTNBJTIyaGVyZSUzQWFmJTNBc3RyZWV0c2VjdGlvbiUzQWRrcFQwMXY0d3p1N1VEWHp3MFBvTUElM0FDZ2NJQkNEUHQtVWpFQUVhQXpNNU53JTIyJTJDJTIycmVmZXJlbmNlVHlwZSUyMiUzQSUyMmhlcmVfcGxhY2VzJTIyJTJDJTIybGF0aXR1ZGUlMjIlM0E0MC42OTEzNiUyQyUyMmxvbmdpdHVkZSUyMiUzQS03My45ODUyJTdE')\n\u003C '%7B%22address%22%3A%22397%20Bridge%20St%22%2C%22reference%22%3A%22here%3Aaf%3Astreetsection%3AdkpT01v4wzu7UDXzw0PoMA%3ACgcIBCDPt-UjEAEaAzM5Nw%22%2C%22referenceType%22%3A%22here_places%22%2C%22latitude%22%3A40.69136%2C%22longitude%22%3A-73.9852%7D'\n```\n\nWell, the resulting string just looks like it's been URI encoded so let's see what happens if we call [`decodeURIComponent`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/decodeURIComponent) on it.\n\n```js\n> decodeURIComponent('%7B%22address%22%3A%22397%20Bridge%20St%22%2C%22reference%22%3A%22here%3Aaf%3Astreetsection%3AdkpT01v4wzu7UDXzw0PoMA%3ACgcIBCDPt-UjEAEaAzM5Nw%22%2C%22referenceType%22%3A%22here_places%22%2C%22latitude%22%3A40.69136%2C%22longitude%22%3A-73.9852%7D')\n\u003C {\"address\":\"397 Bridge St\",\"reference\":\"here:af:streetsection:dkpT01v4wzu7UDXzw0PoMA:CgcIBCDPt-UjEAEaAzM5Nw\",\"referenceType\":\"here_places\",\"latitude\":40.69136,\"longitude\":-73.9852}\n```\n\nHow nice, it looks like some clean and readable JSON. Let's just restructure it so we can inspect it a bit.\n\n```json\n{\n\t\"address\": \"397 Bridge St\",\n\t\"reference\": \"here:af:streetsection:dkpT01v4wzu7UDXzw0PoMA:CgcIBCDPt-UjEAEaAzM5Nw\",\n\t\"referenceType\": \"here_places\",\n\t\"latitude\": 40.69136,\n\t\"longitude\": -73.9852\n}\n```\n\nSo now, we have our decoding function,\n```js\nconst decode = pl => JSON.parse(decodeURIComponent(atob(pl)));\n```\nand inversely, our encoding function,\n```js\nconst encode = obj => btoa(encodeURIComponent(JSON.stringify(obj)));\n```\n\nAfter some testing of swapping out the latitiude, longitude, etc., it turns out that `/feed` bases its queries on the `reference` parameter. This means we can omit all the other fields and pass an encoded object that only has a `reference` field. For example:\n\n```js\n> encode({ reference: 'here:af:streetsection:dkpT01v4wzu7UDXzw0PoMA:CgcIBCDPt-UjEAEaAzM5Nw' })\n\u003C 'JTdCJTIycmVmZXJlbmNlJTIyJTNBJTIyaGVyZSUzQWFmJTNBc3RyZWV0c2VjdGlvbiUzQWRrcFQwMXY0d3p1N1VEWHp3MFBvTUElM0FDZ2NJQkNEUHQtVWpFQUVhQXpNNU53JTIyJTdE'\n```\n\nWhen plugging this string into our `pl` parameter, the results are identical. We now have a programmatic way of generating URLs for a given location. The only problem is that I don't actually know what `here:af:streetsection:dkpT01v4wzu7UDXzw0PoMA:CgcIBCDPt-UjEAEaAzM5Nw` actually means. It's not a string I've ever seen before. Taking `here:af:streetsection:` to Google, I am led to the [HERE developer docs](https://www.here.com/docs/category/geocoding-search-v7). It seems to be some kind of string representing our address. I'm sure there's some way that by interacting with the HERE API, we can generate these strings for any given input. However, since I just want to use this scraper for only one location, I'll stick with the original URL that we had in our browser. Surprise! We did all this work just not to use any of it. It happens sometimes.\n\n### The Page\n\nLet's see if we can do this the cool way without puppeteer. I start by viewing the source of the page and searching for \"moonbowls\". The reason I'm doing this is to check if the server prerenders the results and we can access them by just fetching the page's HTML.\n\n![moonbowls search](/rce_2.png)\n\nNo results. Darn. To the Chrome DevTools network tab we go. In the network tab, we may click on the search button and enter \"moonbowls\". This will search for everything in all requests (the URL, the header, the body, etc.).\n\n![moonbowls search network tab](/rce_3.png)\n\nOne hit! The page seems to be sending a POST request to `https://www.ubereats.com/_p/api/getFeedV1?localeCode=en-US`. Let's check out the payload it's sending.\n\n![getFeedV1 payload](/rce_4.png)\n\nThat's a lot of JSON fields, but most of them are empty. All but one. `cacheKey` seems to have another Base64 encoded string. (Partially omitted for clarity.)\n\n```\n\"cacheKey\": \"JTdCJTIyYWR...45ODUyJTdE/PICKUP///0/0//JTVCJTVE/undefined//////HOME///////\"\n```\n\nThe keen among you may have realized that the Base64 string is the same as the one in our URL. This means that the `cacheKey` parameter is just our `pl` parameter concatenated with `/PICKUP///0/0//JTVCJTVE/undefined//////HOME///////`. After a quick test with another address, `JTVCJTVE` remains the same. Some of the other values in between the forward slashes are filled out and some aren't. It doesn't seem to matter for our purposes, so let's just keep `/PICKUP///0/0//JTVCJTVE/undefined//////HOME///////` as a constant.\n\n### The API Request\n\nWell, we have enough information to start making queries using an HTTP library. Here, I'll be using `node-fetch` since it's my personal favorite and Chrome DevTools lets you copy the request as a Node.js fetch call.\n\n![copy as node.js fetch](/rce_5.png)\n\n```js\nfetch(\"https://www.ubereats.com/_p/api/getFeedV1?localeCode=en-US\", {\n\t// copied straight from chrome\n}).then(res => res.json()).then(console.log);\n```\n\nRunning this results in the following.\n\n```js\n{ status: 'failure', data: { message: 'bd.error.too_many_requests' } }\n```\n\nWell, that sucks. It seems like UberEats might be doing some cookie stuff to make clients use a new cookie for each request. We can try and get around this by\n\n1. Maintaining the cookies using a cookie jar, which will update our cookie state based on set-cookie response headers.\n2. Tracking the requests and responses that the browser makes, and trying to mimic them so we can have a browser-like cookie state.\n\nI did try this route for a good while before coming to the conclusion that it was very difficult and the server always seemed to figure out I was not a real browser. Well, when the server wants you to be a browser, why not just be a browser?\n\n### Puppeteer\n\n[Puppeteer](https://pptr.dev/), the greatest invention since sliced bread, is an API for controlling a headless Chrome instance. This means we can have a browser physically visit the UberEats site, load the page, and then scrape the information ourselves from the elements on the page. I typically try to avoid using puppeteer since it sort of feels like cheating and uses a lot more resources compared to a few HTTP requests. First, install puppeteer with `npm i puppeteer`. After that, get it to visit our target URL. *Note: `headless: false` makes it so that we can see the browser in action. In production, one should set this to `true` (actually `'new'` to avoid deprecation warnings).*\n\n```js\nconst feedURL = 'https://www.ubereats.com/feed?diningMode=PICKUP&pl=...';\n\nconsole.log('launching puppeteer...');\nconst browser = await puppeteer.launch({ headless: false });\nconst page = (await browser.pages())[0];\n\nconsole.log('getting nearby restaurants..');\nawait page.goto(feedURL);\n```\n\nNow that we've visited the page, let's open the Chrome element inspector and find a path to our restaurant cards.\n\n![looking at page HTML](/rce_6.png)\n\nAs it turns out, these class names are minified, which means that if UberEats were to ever deploy a new version, it would likely break our scraper since the minified filenames are highly susceptible to change. Instead, let's use a selector which is more concrete and not based on classes. *Note: the way I'm using a query selector here is by pressing CMD/CTRL+F in the Chrome Element Inspector.*\n\n![the selector that works](/rce_7.png)\n\nOne of the anchor tags inside the card has an attribute called `data-testid` which is always `\"store-card\"`. This seems pretty good and when querying the page for `a[data-testid=\"store-card\"]`, we get 80 results, which is the number we want. The selector I went with is `div:has(> div > div > div > a[data-testid=\"store-card\"])`. Since we want to select the parent div of the anchor element, we may use the [:has()](https://developer.mozilla.org/en-US/docs/Web/CSS/:has) selector to help us. Now that we have the card, we want to check if it has a green ribbon, which means that it is likely to have a BOGO deal. If it does have a green ribbon and that green ribbon contains the text `Buy 1, Get 1 Free` or `n Offers Available`, we want to store the URL of the restaurant page to be scraped later. The code we end up with looks like this. *Note: we are using `page.waitForSelector(cards)` here to wait until the cards are present on the page before scraping them.*\n\n```js\nconst cards = 'div:has(> div > div > div > a[data-testid=\"store-card\"])';\nawait page.waitForSelector(cards);\n\nconst restaurants = [];\nfor (const el of await page.$$(cards)) {\n\tconst offer = await el.evaluate(e => e.querySelector('picture + div > div')?.textContent) || '';\n\tif (offer.includes('Get 1 Free') || offer.includes('Offers')) {\n\t\trestaurants.push(await el.evaluate(e => e.querySelector('a').href));\n\t}\n}\n\nconsole.log(`${restaurants.length} potential restaurants with offers found! closing puppeteer...`);\nawait browser.close();\n```\n\n### Back to Fetch\n\nAnyway, that's all we need from puppeteer. As it turns out, there is a straightforward way to parse the restaurant menu data from the page without making any special API requests. If we go to the URL of the restaurant (ex: [moonbowls](https://www.ubereats.com/store/moonbowls-healthy-korean-bowls-bridge-st/d8CWVYDzXySpFNvEAIzWtQ)). When we view source and search for a particular item on their menu (ex: BBQ Chicken Bowl), we can find that the data is contained within the server-sent HTML. It's all in this one script tag that looks like this:\n\n```html\n\u003Cscript type=\"application/json\" id=\"__REACT_QUERY_STATE__\">\n\t{\\u0022mutations\\u0022:[],\\u0022queries\\u0022:[{ and on and on and on...\n\u003C/script>\n```\n\nLet's go ahead and get this tag from a script using the following code. *Note: it turns out that we need a \"good\" User-Agent*\n\n```js\nconst body = await fetch(url, {\n\theaders: {\n\t\t'user-agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',\n\t},\n}).then(res => res.text());\nconst reactData = body.match(/__REACT_QUERY_STATE__\">(.*?)\u003C\\/script>/s)[1];\nconst rawData = JSON.parse(decodeURIComponent(JSON.parse(`\"${reactData.trim()}\"`)));\n```\n\nHere, I'm just fetching the page and parsing the context as text. Then, I run a regular expression on the text to find whatever is inside of the script tag. The data is a bit weird, but I first tried to unescape the string by wrapping it with quotes and using JSON.parse. After that, I realized it was still URI encoded so I use decodeURIComponent. Finally, we can JSON.parse that.\n\n### Cleaning and Saving the Data\n\nEverything from this point is mostly smooth sailing. Just apply this logic to every restaurant URL we have, get the fields from the JSON that are relevant to us, and save them all to a file. *Note: there is a ton of JSON fields and sifting through this is not fun.* The code we end up with looks like this.\n\n```js\nconst allCompiled = [];\nfor (let i = 0; i \u003C restaurants.length; i++) {\n\tconst url = restaurants[i];\n\tconsole.log(`(${i+1}/${restaurants.length}) fetching ${url}...`);\n\n\tconst body = await fetch(url, {\n\t\theaders: {\n\t\t\t'user-agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',\n\t\t},\n\t}).then(res => res.text());\n\tconst reactData = body.match(/__REACT_QUERY_STATE__\">(.*?)\u003C\\/script>/s)[1];\n\tconst rawData = JSON.parse(decodeURIComponent(JSON.parse(`\"${reactData.trim()}\"`)));\n\tconst { data } = rawData.queries[0].state;\n\tconst [section] = data.sections;\n\tif (section.isOnSale && data.catalogSectionsMap[section.uuid]) {\n\t\tconst items = new Map();\n\t\tfor (const { payload } of data.catalogSectionsMap[section.uuid]) {\n\t\t\tfor (const item of payload.standardItemsPayload.catalogItems) {\n\t\t\t\titems.set(item.uuid, item);\n\t\t\t}\n\t\t}\n\n\t\tconst deals = [];\n\t\tfor (const item of items.values()) {\n\t\t\tif (item.itemPromotion) deals.push(item);\n\t\t}\n\n\t\t// deals found\n\t\tif (deals.length) { \n\t\t\t// formatting the json to our liking\n\t\t\tconst compiled = JSON.parse(data.metaJson);\n\t\t\tcompiled.deals = deals;\n\t\t\tdelete compiled.hasMenu;\n\n\t\t\tallCompiled.push(compiled);\n\t\t\tconsole.log(`got data for ${compiled.name}: ${deals.length} deal(s) found`);\n\t\t}\n\t}\n\n\tawait new Promise(r => setTimeout(r, 3000)); // sleep for 3 secs to avoid ratelimiting\n}\n\nfs.writeFileSync('./scraped.json', JSON.stringify(allCompiled)); // output our deals to scraped.json\n```\n\n### GitHub Action\n\nAnd that's it! I did mention that we are using a GitHub Action to automatically scrape the data so here is the script for that. Every 10 minutes, it checks out the repository, runs our JS file, and commits the changed files back to the repository. *Note: `GH_TOKEN` is a repository secret that contains a GitHub personal access token with write content permission to the repository.*\n\n```yml\nname: Cron Scrape\n\non:\n  schedule:\n    - cron: \"*/10 * * * *\"\n\npermissions:\n  contents: write\n\njobs:\n  build:\n    runs-on: ubuntu-latest\n    name: Run scrape.mjs and commit changes\n    env:\n      GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}\n    steps:\n    - uses: actions/checkout@v3\n    - name: Setup Node\n      uses: actions/setup-node@v3\n      with:\n        node-version: 20.3.0\n    - run: npm i\n    - run: |\n        git config --global user.name \"gh-actions\"\n        git config --global user.email \"gh-actions@github.com\"\n        git remote set-url origin https://git:${GITHUB_TOKEN}@github.com/${{github.repository}}.git\n    - run: npm run main\n    - run: git commit --allow-empty -am \"update scraped.json\"\n    - run: git push\n```\n\n### Rendering the Data\n\nWith the data successfully scraped, we may now make a nice user interface. I did so using GitHub Pages and you can visit it [here](https://recurse-eats.dim.codes/). The source code for the page itself is [here](https://github.com/xDimGG/recurse-ubereats/blob/main/index.html).\n\n## Final Notes\n\nI hope you can go and start using puppeteer yourself. I barely scratched the surface of puppeteer's capabilities, but these are probably the most useful parts. During this small project, I learned that it's better to quit early and opt for the \"easier\" method sooner as sometimes all you need is a working product that can feed some hungry stomachs. Hope you've enjoyed. See you again!\n",html:"\u003Cp>How I was able to snag up UberEats buy-one-get-one-free (BOGO) deals from UberEats in my area. \u003Ca href=\"https://recurse-eats.dim.codes/\">TL\u003C/a>;\u003Ca href=\"https://github.com/xDimGG/recurse-ubereats/\">DR\u003C/a>.\u003C/p>\n\u003Ch2>Background\u003C/h2>\n\u003Cp>I recently started my batch at \u003Ca href=\"https://www.recurse.com/about\">Recurse Center\u003C/a>. Although I have been learning a lot and having a good time with all the people here, the food in this area is awfully expensive, and on some days I don&#39;t have time to prepare lunch at home. I looked at a couple of food delivery sites like DoorDash, GrubHub, etc. As it turns out, UberEats routinely offers BOGO deals at a good number of restaurants. It was very annoying to sift through all the nearby restaurants for what offers they have, so I wanted a way to quickly view all of the items that had an offer going on.\u003C/p>\n\u003Cp>\u003Cimg src=\"/rce_1.png\" alt=\"UberEats Search\">\u003C/p>\n\u003Ch2>Investigation\u003C/h2>\n\u003Cp>As it turns out, UberEats doesn&#39;t really want you scraping their site. Most API endpoints have obscure names, the URL is encoded in some strange way, and the React state is quite annoyingly obfuscated. It&#39;s okay, though. As with any sort of reverse engineering, anything is possible (unless you encounter CAPTCHA, then you go on a long walk and consider whether all this is even worth it). Let&#39;s start with something simple.\u003C/p>\n\u003Ch3>The URL\u003C/h3>\n\u003Cp>First off, we need to find restaurants in our area, so let&#39;s navigate to UberEats and search for the current address (for Recurse Center, that&#39;s 397 Bridge St). On this page, we can see restaurants in our area. Let&#39;s try and pick apart the URL.\u003C/p>\n\u003Cpre>\u003Ccode>https://www.ubereats.com/feed\n    ?diningMode=PICKUP\n    &amp;pl=JTdCJTIyYWRkcmVzcyUyMiUzQSUyMjM5NyUyMEJyaWRnZSUyMFN0JTIyJTJDJTIycmVmZXJlbmNlJTIyJTNBJTIyaGVyZSUzQWFmJTNBc3RyZWV0c2VjdGlvbiUzQWRrcFQwMXY0d3p1N1VEWHp3MFBvTUElM0FDZ2NJQkNEUHQtVWpFQUVhQXpNNU53JTIyJTJDJTIycmVmZXJlbmNlVHlwZSUyMiUzQSUyMmhlcmVfcGxhY2VzJTIyJTJDJTIybGF0aXR1ZGUlMjIlM0E0MC42OTEzNiUyQyUyMmxvbmdpdHVkZSUyMiUzQS03My45ODUyJTdE\n\u003C/code>\u003C/pre>\u003Cp>Of course, \u003Ccode>diningMode\u003C/code> is either \u003Ccode>PICKUP\u003C/code> or \u003Ccode>DELIVERY\u003C/code>. Since my goal here is to save money, not spend it, we are going to be using \u003Ccode>PICKUP\u003C/code> and not \u003Ccode>DELIVERY\u003C/code>. As for the second parameter, \u003Ccode>pl\u003C/code>, it definitely seems a bit trickier. Based on my years of professional hacking, I am going to take a guess and say that this is just Base64 encoded. You can try plugging this into an online Base64 decoder or do what I do and just use \u003Ca href=\"https://developer.mozilla.org/en-US/docs/Web/API/atob\">\u003Ccode>atob\u003C/code>\u003C/a> from the Chrome console.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-js\">&gt; \u003Cspan class=\"hljs-title function_\">atob\u003C/span>(\u003Cspan class=\"hljs-string\">&#x27;JTdCJTIyYWRkcmVzcyUyMiUzQSUyMjM5NyUyMEJyaWRnZSUyMFN0JTIyJTJDJTIycmVmZXJlbmNlJTIyJTNBJTIyaGVyZSUzQWFmJTNBc3RyZWV0c2VjdGlvbiUzQWRrcFQwMXY0d3p1N1VEWHp3MFBvTUElM0FDZ2NJQkNEUHQtVWpFQUVhQXpNNU53JTIyJTJDJTIycmVmZXJlbmNlVHlwZSUyMiUzQSUyMmhlcmVfcGxhY2VzJTIyJTJDJTIybGF0aXR1ZGUlMjIlM0E0MC42OTEzNiUyQyUyMmxvbmdpdHVkZSUyMiUzQS03My45ODUyJTdE&#x27;\u003C/span>)\n&lt; \u003Cspan class=\"hljs-string\">&#x27;%7B%22address%22%3A%22397%20Bridge%20St%22%2C%22reference%22%3A%22here%3Aaf%3Astreetsection%3AdkpT01v4wzu7UDXzw0PoMA%3ACgcIBCDPt-UjEAEaAzM5Nw%22%2C%22referenceType%22%3A%22here_places%22%2C%22latitude%22%3A40.69136%2C%22longitude%22%3A-73.9852%7D&#x27;\u003C/span>\n\u003C/code>\u003C/pre>\u003Cp>Well, the resulting string just looks like it&#39;s been URI encoded so let&#39;s see what happens if we call \u003Ca href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/decodeURIComponent\">\u003Ccode>decodeURIComponent\u003C/code>\u003C/a> on it.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-js\">&gt; \u003Cspan class=\"hljs-built_in\">decodeURIComponent\u003C/span>(\u003Cspan class=\"hljs-string\">&#x27;%7B%22address%22%3A%22397%20Bridge%20St%22%2C%22reference%22%3A%22here%3Aaf%3Astreetsection%3AdkpT01v4wzu7UDXzw0PoMA%3ACgcIBCDPt-UjEAEaAzM5Nw%22%2C%22referenceType%22%3A%22here_places%22%2C%22latitude%22%3A40.69136%2C%22longitude%22%3A-73.9852%7D&#x27;\u003C/span>)\n&lt; {\u003Cspan class=\"hljs-string\">&quot;address&quot;\u003C/span>:\u003Cspan class=\"hljs-string\">&quot;397 Bridge St&quot;\u003C/span>,\u003Cspan class=\"hljs-string\">&quot;reference&quot;\u003C/span>:\u003Cspan class=\"hljs-string\">&quot;here:af:streetsection:dkpT01v4wzu7UDXzw0PoMA:CgcIBCDPt-UjEAEaAzM5Nw&quot;\u003C/span>,\u003Cspan class=\"hljs-string\">&quot;referenceType&quot;\u003C/span>:\u003Cspan class=\"hljs-string\">&quot;here_places&quot;\u003C/span>,\u003Cspan class=\"hljs-string\">&quot;latitude&quot;\u003C/span>:\u003Cspan class=\"hljs-number\">40.69136\u003C/span>,\u003Cspan class=\"hljs-string\">&quot;longitude&quot;\u003C/span>:-\u003Cspan class=\"hljs-number\">73.9852\u003C/span>}\n\u003C/code>\u003C/pre>\u003Cp>How nice, it looks like some clean and readable JSON. Let&#39;s just restructure it so we can inspect it a bit.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-json\">\u003Cspan class=\"hljs-punctuation\">{\u003C/span>\n    \u003Cspan class=\"hljs-attr\">&quot;address&quot;\u003C/span>\u003Cspan class=\"hljs-punctuation\">:\u003C/span> \u003Cspan class=\"hljs-string\">&quot;397 Bridge St&quot;\u003C/span>\u003Cspan class=\"hljs-punctuation\">,\u003C/span>\n    \u003Cspan class=\"hljs-attr\">&quot;reference&quot;\u003C/span>\u003Cspan class=\"hljs-punctuation\">:\u003C/span> \u003Cspan class=\"hljs-string\">&quot;here:af:streetsection:dkpT01v4wzu7UDXzw0PoMA:CgcIBCDPt-UjEAEaAzM5Nw&quot;\u003C/span>\u003Cspan class=\"hljs-punctuation\">,\u003C/span>\n    \u003Cspan class=\"hljs-attr\">&quot;referenceType&quot;\u003C/span>\u003Cspan class=\"hljs-punctuation\">:\u003C/span> \u003Cspan class=\"hljs-string\">&quot;here_places&quot;\u003C/span>\u003Cspan class=\"hljs-punctuation\">,\u003C/span>\n    \u003Cspan class=\"hljs-attr\">&quot;latitude&quot;\u003C/span>\u003Cspan class=\"hljs-punctuation\">:\u003C/span> \u003Cspan class=\"hljs-number\">40.69136\u003C/span>\u003Cspan class=\"hljs-punctuation\">,\u003C/span>\n    \u003Cspan class=\"hljs-attr\">&quot;longitude&quot;\u003C/span>\u003Cspan class=\"hljs-punctuation\">:\u003C/span> \u003Cspan class=\"hljs-number\">-73.9852\u003C/span>\n\u003Cspan class=\"hljs-punctuation\">}\u003C/span>\n\u003C/code>\u003C/pre>\u003Cp>So now, we have our decoding function,\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-js\">\u003Cspan class=\"hljs-keyword\">const\u003C/span> \u003Cspan class=\"hljs-title function_\">decode\u003C/span> = pl =&gt; \u003Cspan class=\"hljs-title class_\">JSON\u003C/span>.\u003Cspan class=\"hljs-title function_\">parse\u003C/span>(\u003Cspan class=\"hljs-built_in\">decodeURIComponent\u003C/span>(\u003Cspan class=\"hljs-title function_\">atob\u003C/span>(pl)));\n\u003C/code>\u003C/pre>\u003Cp>and inversely, our encoding function,\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-js\">\u003Cspan class=\"hljs-keyword\">const\u003C/span> \u003Cspan class=\"hljs-title function_\">encode\u003C/span> = obj =&gt; \u003Cspan class=\"hljs-title function_\">btoa\u003C/span>(\u003Cspan class=\"hljs-built_in\">encodeURIComponent\u003C/span>(\u003Cspan class=\"hljs-title class_\">JSON\u003C/span>.\u003Cspan class=\"hljs-title function_\">stringify\u003C/span>(obj)));\n\u003C/code>\u003C/pre>\u003Cp>After some testing of swapping out the latitiude, longitude, etc., it turns out that \u003Ccode>/feed\u003C/code> bases its queries on the \u003Ccode>reference\u003C/code> parameter. This means we can omit all the other fields and pass an encoded object that only has a \u003Ccode>reference\u003C/code> field. For example:\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-js\">&gt; \u003Cspan class=\"hljs-title function_\">encode\u003C/span>({ \u003Cspan class=\"hljs-attr\">reference\u003C/span>: \u003Cspan class=\"hljs-string\">&#x27;here:af:streetsection:dkpT01v4wzu7UDXzw0PoMA:CgcIBCDPt-UjEAEaAzM5Nw&#x27;\u003C/span> })\n&lt; \u003Cspan class=\"hljs-string\">&#x27;JTdCJTIycmVmZXJlbmNlJTIyJTNBJTIyaGVyZSUzQWFmJTNBc3RyZWV0c2VjdGlvbiUzQWRrcFQwMXY0d3p1N1VEWHp3MFBvTUElM0FDZ2NJQkNEUHQtVWpFQUVhQXpNNU53JTIyJTdE&#x27;\u003C/span>\n\u003C/code>\u003C/pre>\u003Cp>When plugging this string into our \u003Ccode>pl\u003C/code> parameter, the results are identical. We now have a programmatic way of generating URLs for a given location. The only problem is that I don&#39;t actually know what \u003Ccode>here:af:streetsection:dkpT01v4wzu7UDXzw0PoMA:CgcIBCDPt-UjEAEaAzM5Nw\u003C/code> actually means. It&#39;s not a string I&#39;ve ever seen before. Taking \u003Ccode>here:af:streetsection:\u003C/code> to Google, I am led to the \u003Ca href=\"https://www.here.com/docs/category/geocoding-search-v7\">HERE developer docs\u003C/a>. It seems to be some kind of string representing our address. I&#39;m sure there&#39;s some way that by interacting with the HERE API, we can generate these strings for any given input. However, since I just want to use this scraper for only one location, I&#39;ll stick with the original URL that we had in our browser. Surprise! We did all this work just not to use any of it. It happens sometimes.\u003C/p>\n\u003Ch3>The Page\u003C/h3>\n\u003Cp>Let&#39;s see if we can do this the cool way without puppeteer. I start by viewing the source of the page and searching for &quot;moonbowls&quot;. The reason I&#39;m doing this is to check if the server prerenders the results and we can access them by just fetching the page&#39;s HTML.\u003C/p>\n\u003Cp>\u003Cimg src=\"/rce_2.png\" alt=\"moonbowls search\">\u003C/p>\n\u003Cp>No results. Darn. To the Chrome DevTools network tab we go. In the network tab, we may click on the search button and enter &quot;moonbowls&quot;. This will search for everything in all requests (the URL, the header, the body, etc.).\u003C/p>\n\u003Cp>\u003Cimg src=\"/rce_3.png\" alt=\"moonbowls search network tab\">\u003C/p>\n\u003Cp>One hit! The page seems to be sending a POST request to \u003Ccode>https://www.ubereats.com/_p/api/getFeedV1?localeCode=en-US\u003C/code>. Let&#39;s check out the payload it&#39;s sending.\u003C/p>\n\u003Cp>\u003Cimg src=\"/rce_4.png\" alt=\"getFeedV1 payload\">\u003C/p>\n\u003Cp>That&#39;s a lot of JSON fields, but most of them are empty. All but one. \u003Ccode>cacheKey\u003C/code> seems to have another Base64 encoded string. (Partially omitted for clarity.)\u003C/p>\n\u003Cpre>\u003Ccode>&quot;cacheKey&quot;: &quot;JTdCJTIyYWR...45ODUyJTdE/PICKUP///0/0//JTVCJTVE/undefined//////HOME///////&quot;\n\u003C/code>\u003C/pre>\u003Cp>The keen among you may have realized that the Base64 string is the same as the one in our URL. This means that the \u003Ccode>cacheKey\u003C/code> parameter is just our \u003Ccode>pl\u003C/code> parameter concatenated with \u003Ccode>/PICKUP///0/0//JTVCJTVE/undefined//////HOME///////\u003C/code>. After a quick test with another address, \u003Ccode>JTVCJTVE\u003C/code> remains the same. Some of the other values in between the forward slashes are filled out and some aren&#39;t. It doesn&#39;t seem to matter for our purposes, so let&#39;s just keep \u003Ccode>/PICKUP///0/0//JTVCJTVE/undefined//////HOME///////\u003C/code> as a constant.\u003C/p>\n\u003Ch3>The API Request\u003C/h3>\n\u003Cp>Well, we have enough information to start making queries using an HTTP library. Here, I&#39;ll be using \u003Ccode>node-fetch\u003C/code> since it&#39;s my personal favorite and Chrome DevTools lets you copy the request as a Node.js fetch call.\u003C/p>\n\u003Cp>\u003Cimg src=\"/rce_5.png\" alt=\"copy as node.js fetch\">\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-js\">\u003Cspan class=\"hljs-title function_\">fetch\u003C/span>(\u003Cspan class=\"hljs-string\">&quot;https://www.ubereats.com/_p/api/getFeedV1?localeCode=en-US&quot;\u003C/span>, {\n    \u003Cspan class=\"hljs-comment\">// copied straight from chrome\u003C/span>\n}).\u003Cspan class=\"hljs-title function_\">then\u003C/span>(\u003Cspan class=\"hljs-function\">\u003Cspan class=\"hljs-params\">res\u003C/span> =&gt;\u003C/span> res.\u003Cspan class=\"hljs-title function_\">json\u003C/span>()).\u003Cspan class=\"hljs-title function_\">then\u003C/span>(\u003Cspan class=\"hljs-variable language_\">console\u003C/span>.\u003Cspan class=\"hljs-property\">log\u003C/span>);\n\u003C/code>\u003C/pre>\u003Cp>Running this results in the following.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-js\">{ \u003Cspan class=\"hljs-attr\">status\u003C/span>: \u003Cspan class=\"hljs-string\">&#x27;failure&#x27;\u003C/span>, \u003Cspan class=\"hljs-attr\">data\u003C/span>: { \u003Cspan class=\"hljs-attr\">message\u003C/span>: \u003Cspan class=\"hljs-string\">&#x27;bd.error.too_many_requests&#x27;\u003C/span> } }\n\u003C/code>\u003C/pre>\u003Cp>Well, that sucks. It seems like UberEats might be doing some cookie stuff to make clients use a new cookie for each request. We can try and get around this by\u003C/p>\n\u003Col>\n\u003Cli>Maintaining the cookies using a cookie jar, which will update our cookie state based on set-cookie response headers.\u003C/li>\n\u003Cli>Tracking the requests and responses that the browser makes, and trying to mimic them so we can have a browser-like cookie state.\u003C/li>\n\u003C/ol>\n\u003Cp>I did try this route for a good while before coming to the conclusion that it was very difficult and the server always seemed to figure out I was not a real browser. Well, when the server wants you to be a browser, why not just be a browser?\u003C/p>\n\u003Ch3>Puppeteer\u003C/h3>\n\u003Cp>\u003Ca href=\"https://pptr.dev/\">Puppeteer\u003C/a>, the greatest invention since sliced bread, is an API for controlling a headless Chrome instance. This means we can have a browser physically visit the UberEats site, load the page, and then scrape the information ourselves from the elements on the page. I typically try to avoid using puppeteer since it sort of feels like cheating and uses a lot more resources compared to a few HTTP requests. First, install puppeteer with \u003Ccode>npm i puppeteer\u003C/code>. After that, get it to visit our target URL. \u003Cem>Note: \u003Ccode>headless: false\u003C/code> makes it so that we can see the browser in action. In production, one should set this to \u003Ccode>true\u003C/code> (actually \u003Ccode>&#39;new&#39;\u003C/code> to avoid deprecation warnings).\u003C/em>\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-js\">\u003Cspan class=\"hljs-keyword\">const\u003C/span> feedURL = \u003Cspan class=\"hljs-string\">&#x27;https://www.ubereats.com/feed?diningMode=PICKUP&amp;pl=...&#x27;\u003C/span>;\n\n\u003Cspan class=\"hljs-variable language_\">console\u003C/span>.\u003Cspan class=\"hljs-title function_\">log\u003C/span>(\u003Cspan class=\"hljs-string\">&#x27;launching puppeteer...&#x27;\u003C/span>);\n\u003Cspan class=\"hljs-keyword\">const\u003C/span> browser = \u003Cspan class=\"hljs-keyword\">await\u003C/span> puppeteer.\u003Cspan class=\"hljs-title function_\">launch\u003C/span>({ \u003Cspan class=\"hljs-attr\">headless\u003C/span>: \u003Cspan class=\"hljs-literal\">false\u003C/span> });\n\u003Cspan class=\"hljs-keyword\">const\u003C/span> page = (\u003Cspan class=\"hljs-keyword\">await\u003C/span> browser.\u003Cspan class=\"hljs-title function_\">pages\u003C/span>())[\u003Cspan class=\"hljs-number\">0\u003C/span>];\n\n\u003Cspan class=\"hljs-variable language_\">console\u003C/span>.\u003Cspan class=\"hljs-title function_\">log\u003C/span>(\u003Cspan class=\"hljs-string\">&#x27;getting nearby restaurants..&#x27;\u003C/span>);\n\u003Cspan class=\"hljs-keyword\">await\u003C/span> page.\u003Cspan class=\"hljs-title function_\">goto\u003C/span>(feedURL);\n\u003C/code>\u003C/pre>\u003Cp>Now that we&#39;ve visited the page, let&#39;s open the Chrome element inspector and find a path to our restaurant cards.\u003C/p>\n\u003Cp>\u003Cimg src=\"/rce_6.png\" alt=\"looking at page HTML\">\u003C/p>\n\u003Cp>As it turns out, these class names are minified, which means that if UberEats were to ever deploy a new version, it would likely break our scraper since the minified filenames are highly susceptible to change. Instead, let&#39;s use a selector which is more concrete and not based on classes. \u003Cem>Note: the way I&#39;m using a query selector here is by pressing CMD/CTRL+F in the Chrome Element Inspector.\u003C/em>\u003C/p>\n\u003Cp>\u003Cimg src=\"/rce_7.png\" alt=\"the selector that works\">\u003C/p>\n\u003Cp>One of the anchor tags inside the card has an attribute called \u003Ccode>data-testid\u003C/code> which is always \u003Ccode>&quot;store-card&quot;\u003C/code>. This seems pretty good and when querying the page for \u003Ccode>a[data-testid=&quot;store-card&quot;]\u003C/code>, we get 80 results, which is the number we want. The selector I went with is \u003Ccode>div:has(&gt; div &gt; div &gt; div &gt; a[data-testid=&quot;store-card&quot;])\u003C/code>. Since we want to select the parent div of the anchor element, we may use the \u003Ca href=\"https://developer.mozilla.org/en-US/docs/Web/CSS/:has\">:has()\u003C/a> selector to help us. Now that we have the card, we want to check if it has a green ribbon, which means that it is likely to have a BOGO deal. If it does have a green ribbon and that green ribbon contains the text \u003Ccode>Buy 1, Get 1 Free\u003C/code> or \u003Ccode>n Offers Available\u003C/code>, we want to store the URL of the restaurant page to be scraped later. The code we end up with looks like this. \u003Cem>Note: we are using \u003Ccode>page.waitForSelector(cards)\u003C/code> here to wait until the cards are present on the page before scraping them.\u003C/em>\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-js\">\u003Cspan class=\"hljs-keyword\">const\u003C/span> cards = \u003Cspan class=\"hljs-string\">&#x27;div:has(&gt; div &gt; div &gt; div &gt; a[data-testid=&quot;store-card&quot;])&#x27;\u003C/span>;\n\u003Cspan class=\"hljs-keyword\">await\u003C/span> page.\u003Cspan class=\"hljs-title function_\">waitForSelector\u003C/span>(cards);\n\n\u003Cspan class=\"hljs-keyword\">const\u003C/span> restaurants = [];\n\u003Cspan class=\"hljs-keyword\">for\u003C/span> (\u003Cspan class=\"hljs-keyword\">const\u003C/span> el \u003Cspan class=\"hljs-keyword\">of\u003C/span> \u003Cspan class=\"hljs-keyword\">await\u003C/span> page.$$(cards)) {\n    \u003Cspan class=\"hljs-keyword\">const\u003C/span> offer = \u003Cspan class=\"hljs-keyword\">await\u003C/span> el.evaluate(\u003Cspan class=\"hljs-function\">\u003Cspan class=\"hljs-params\">e\u003C/span> =&gt;\u003C/span> e.\u003Cspan class=\"hljs-title function_\">querySelector\u003C/span>(\u003Cspan class=\"hljs-string\">&#x27;picture + div &gt; div&#x27;\u003C/span>)?.\u003Cspan class=\"hljs-property\">textContent\u003C/span>) || \u003Cspan class=\"hljs-string\">&#x27;&#x27;\u003C/span>;\n    \u003Cspan class=\"hljs-keyword\">if\u003C/span> (offer.\u003Cspan class=\"hljs-title function_\">includes\u003C/span>(\u003Cspan class=\"hljs-string\">&#x27;Get 1 Free&#x27;\u003C/span>) || offer.\u003Cspan class=\"hljs-title function_\">includes\u003C/span>(\u003Cspan class=\"hljs-string\">&#x27;Offers&#x27;\u003C/span>)) {\n        restaurants.\u003Cspan class=\"hljs-title function_\">push\u003C/span>(\u003Cspan class=\"hljs-keyword\">await\u003C/span> el.evaluate(\u003Cspan class=\"hljs-function\">\u003Cspan class=\"hljs-params\">e\u003C/span> =&gt;\u003C/span> e.\u003Cspan class=\"hljs-title function_\">querySelector\u003C/span>(\u003Cspan class=\"hljs-string\">&#x27;a&#x27;\u003C/span>).\u003Cspan class=\"hljs-property\">href\u003C/span>));\n    }\n}\n\n\u003Cspan class=\"hljs-variable language_\">console\u003C/span>.\u003Cspan class=\"hljs-title function_\">log\u003C/span>(\u003Cspan class=\"hljs-string\">`\u003Cspan class=\"hljs-subst\">${restaurants.length}\u003C/span> potential restaurants with offers found! closing puppeteer...`\u003C/span>);\n\u003Cspan class=\"hljs-keyword\">await\u003C/span> browser.\u003Cspan class=\"hljs-title function_\">close\u003C/span>();\n\u003C/code>\u003C/pre>\u003Ch3>Back to Fetch\u003C/h3>\n\u003Cp>Anyway, that&#39;s all we need from puppeteer. As it turns out, there is a straightforward way to parse the restaurant menu data from the page without making any special API requests. If we go to the URL of the restaurant (ex: \u003Ca href=\"https://www.ubereats.com/store/moonbowls-healthy-korean-bowls-bridge-st/d8CWVYDzXySpFNvEAIzWtQ\">moonbowls\u003C/a>). When we view source and search for a particular item on their menu (ex: BBQ Chicken Bowl), we can find that the data is contained within the server-sent HTML. It&#39;s all in this one script tag that looks like this:\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-html\">\u003Cspan class=\"hljs-tag\">&lt;\u003Cspan class=\"hljs-name\">script\u003C/span> \u003Cspan class=\"hljs-attr\">type\u003C/span>=\u003Cspan class=\"hljs-string\">&quot;application/json&quot;\u003C/span> \u003Cspan class=\"hljs-attr\">id\u003C/span>=\u003Cspan class=\"hljs-string\">&quot;__REACT_QUERY_STATE__&quot;\u003C/span>&gt;\u003C/span>\n    {\\u0022mutations\\u0022:[],\\u0022queries\\u0022:[{ and on and on and on...\n\u003Cspan class=\"hljs-tag\">&lt;/\u003Cspan class=\"hljs-name\">script\u003C/span>&gt;\u003C/span>\n\u003C/code>\u003C/pre>\u003Cp>Let&#39;s go ahead and get this tag from a script using the following code. \u003Cem>Note: it turns out that we need a &quot;good&quot; User-Agent\u003C/em>\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-js\">\u003Cspan class=\"hljs-keyword\">const\u003C/span> body = \u003Cspan class=\"hljs-keyword\">await\u003C/span> \u003Cspan class=\"hljs-title function_\">fetch\u003C/span>(url, {\n    \u003Cspan class=\"hljs-attr\">headers\u003C/span>: {\n        \u003Cspan class=\"hljs-string\">&#x27;user-agent&#x27;\u003C/span>: \u003Cspan class=\"hljs-string\">&#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36&#x27;\u003C/span>,\n    },\n}).\u003Cspan class=\"hljs-title function_\">then\u003C/span>(\u003Cspan class=\"hljs-function\">\u003Cspan class=\"hljs-params\">res\u003C/span> =&gt;\u003C/span> res.\u003Cspan class=\"hljs-title function_\">text\u003C/span>());\n\u003Cspan class=\"hljs-keyword\">const\u003C/span> reactData = body.\u003Cspan class=\"hljs-title function_\">match\u003C/span>(\u003Cspan class=\"hljs-regexp\">/__REACT_QUERY_STATE__&quot;&gt;(.*?)&lt;\\/script&gt;/\u003C/span>s)[\u003Cspan class=\"hljs-number\">1\u003C/span>];\n\u003Cspan class=\"hljs-keyword\">const\u003C/span> rawData = \u003Cspan class=\"hljs-title class_\">JSON\u003C/span>.\u003Cspan class=\"hljs-title function_\">parse\u003C/span>(\u003Cspan class=\"hljs-built_in\">decodeURIComponent\u003C/span>(\u003Cspan class=\"hljs-title class_\">JSON\u003C/span>.\u003Cspan class=\"hljs-title function_\">parse\u003C/span>(\u003Cspan class=\"hljs-string\">`&quot;\u003Cspan class=\"hljs-subst\">${reactData.trim()}\u003C/span>&quot;`\u003C/span>)));\n\u003C/code>\u003C/pre>\u003Cp>Here, I&#39;m just fetching the page and parsing the context as text. Then, I run a regular expression on the text to find whatever is inside of the script tag. The data is a bit weird, but I first tried to unescape the string by wrapping it with quotes and using JSON.parse. After that, I realized it was still URI encoded so I use decodeURIComponent. Finally, we can JSON.parse that.\u003C/p>\n\u003Ch3>Cleaning and Saving the Data\u003C/h3>\n\u003Cp>Everything from this point is mostly smooth sailing. Just apply this logic to every restaurant URL we have, get the fields from the JSON that are relevant to us, and save them all to a file. \u003Cem>Note: there is a ton of JSON fields and sifting through this is not fun.\u003C/em> The code we end up with looks like this.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-js\">\u003Cspan class=\"hljs-keyword\">const\u003C/span> allCompiled = [];\n\u003Cspan class=\"hljs-keyword\">for\u003C/span> (\u003Cspan class=\"hljs-keyword\">let\u003C/span> i = \u003Cspan class=\"hljs-number\">0\u003C/span>; i &lt; restaurants.\u003Cspan class=\"hljs-property\">length\u003C/span>; i++) {\n    \u003Cspan class=\"hljs-keyword\">const\u003C/span> url = restaurants[i];\n    \u003Cspan class=\"hljs-variable language_\">console\u003C/span>.\u003Cspan class=\"hljs-title function_\">log\u003C/span>(\u003Cspan class=\"hljs-string\">`(\u003Cspan class=\"hljs-subst\">${i+\u003Cspan class=\"hljs-number\">1\u003C/span>}\u003C/span>/\u003Cspan class=\"hljs-subst\">${restaurants.length}\u003C/span>) fetching \u003Cspan class=\"hljs-subst\">${url}\u003C/span>...`\u003C/span>);\n\n    \u003Cspan class=\"hljs-keyword\">const\u003C/span> body = \u003Cspan class=\"hljs-keyword\">await\u003C/span> \u003Cspan class=\"hljs-title function_\">fetch\u003C/span>(url, {\n        \u003Cspan class=\"hljs-attr\">headers\u003C/span>: {\n            \u003Cspan class=\"hljs-string\">&#x27;user-agent&#x27;\u003C/span>: \u003Cspan class=\"hljs-string\">&#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36&#x27;\u003C/span>,\n        },\n    }).\u003Cspan class=\"hljs-title function_\">then\u003C/span>(\u003Cspan class=\"hljs-function\">\u003Cspan class=\"hljs-params\">res\u003C/span> =&gt;\u003C/span> res.\u003Cspan class=\"hljs-title function_\">text\u003C/span>());\n    \u003Cspan class=\"hljs-keyword\">const\u003C/span> reactData = body.\u003Cspan class=\"hljs-title function_\">match\u003C/span>(\u003Cspan class=\"hljs-regexp\">/__REACT_QUERY_STATE__&quot;&gt;(.*?)&lt;\\/script&gt;/\u003C/span>s)[\u003Cspan class=\"hljs-number\">1\u003C/span>];\n    \u003Cspan class=\"hljs-keyword\">const\u003C/span> rawData = \u003Cspan class=\"hljs-title class_\">JSON\u003C/span>.\u003Cspan class=\"hljs-title function_\">parse\u003C/span>(\u003Cspan class=\"hljs-built_in\">decodeURIComponent\u003C/span>(\u003Cspan class=\"hljs-title class_\">JSON\u003C/span>.\u003Cspan class=\"hljs-title function_\">parse\u003C/span>(\u003Cspan class=\"hljs-string\">`&quot;\u003Cspan class=\"hljs-subst\">${reactData.trim()}\u003C/span>&quot;`\u003C/span>)));\n    \u003Cspan class=\"hljs-keyword\">const\u003C/span> { data } = rawData.\u003Cspan class=\"hljs-property\">queries\u003C/span>[\u003Cspan class=\"hljs-number\">0\u003C/span>].\u003Cspan class=\"hljs-property\">state\u003C/span>;\n    \u003Cspan class=\"hljs-keyword\">const\u003C/span> [section] = data.\u003Cspan class=\"hljs-property\">sections\u003C/span>;\n    \u003Cspan class=\"hljs-keyword\">if\u003C/span> (section.\u003Cspan class=\"hljs-property\">isOnSale\u003C/span> &amp;&amp; data.\u003Cspan class=\"hljs-property\">catalogSectionsMap\u003C/span>[section.\u003Cspan class=\"hljs-property\">uuid\u003C/span>]) {\n        \u003Cspan class=\"hljs-keyword\">const\u003C/span> items = \u003Cspan class=\"hljs-keyword\">new\u003C/span> \u003Cspan class=\"hljs-title class_\">Map\u003C/span>();\n        \u003Cspan class=\"hljs-keyword\">for\u003C/span> (\u003Cspan class=\"hljs-keyword\">const\u003C/span> { payload } \u003Cspan class=\"hljs-keyword\">of\u003C/span> data.\u003Cspan class=\"hljs-property\">catalogSectionsMap\u003C/span>[section.\u003Cspan class=\"hljs-property\">uuid\u003C/span>]) {\n            \u003Cspan class=\"hljs-keyword\">for\u003C/span> (\u003Cspan class=\"hljs-keyword\">const\u003C/span> item \u003Cspan class=\"hljs-keyword\">of\u003C/span> payload.\u003Cspan class=\"hljs-property\">standardItemsPayload\u003C/span>.\u003Cspan class=\"hljs-property\">catalogItems\u003C/span>) {\n                items.\u003Cspan class=\"hljs-title function_\">set\u003C/span>(item.\u003Cspan class=\"hljs-property\">uuid\u003C/span>, item);\n            }\n        }\n\n        \u003Cspan class=\"hljs-keyword\">const\u003C/span> deals = [];\n        \u003Cspan class=\"hljs-keyword\">for\u003C/span> (\u003Cspan class=\"hljs-keyword\">const\u003C/span> item \u003Cspan class=\"hljs-keyword\">of\u003C/span> items.\u003Cspan class=\"hljs-title function_\">values\u003C/span>()) {\n            \u003Cspan class=\"hljs-keyword\">if\u003C/span> (item.\u003Cspan class=\"hljs-property\">itemPromotion\u003C/span>) deals.\u003Cspan class=\"hljs-title function_\">push\u003C/span>(item);\n        }\n\n        \u003Cspan class=\"hljs-comment\">// deals found\u003C/span>\n        \u003Cspan class=\"hljs-keyword\">if\u003C/span> (deals.\u003Cspan class=\"hljs-property\">length\u003C/span>) { \n            \u003Cspan class=\"hljs-comment\">// formatting the json to our liking\u003C/span>\n            \u003Cspan class=\"hljs-keyword\">const\u003C/span> compiled = \u003Cspan class=\"hljs-title class_\">JSON\u003C/span>.\u003Cspan class=\"hljs-title function_\">parse\u003C/span>(data.\u003Cspan class=\"hljs-property\">metaJson\u003C/span>);\n            compiled.\u003Cspan class=\"hljs-property\">deals\u003C/span> = deals;\n            \u003Cspan class=\"hljs-keyword\">delete\u003C/span> compiled.\u003Cspan class=\"hljs-property\">hasMenu\u003C/span>;\n\n            allCompiled.\u003Cspan class=\"hljs-title function_\">push\u003C/span>(compiled);\n            \u003Cspan class=\"hljs-variable language_\">console\u003C/span>.\u003Cspan class=\"hljs-title function_\">log\u003C/span>(\u003Cspan class=\"hljs-string\">`got data for \u003Cspan class=\"hljs-subst\">${compiled.name}\u003C/span>: \u003Cspan class=\"hljs-subst\">${deals.length}\u003C/span> deal(s) found`\u003C/span>);\n        }\n    }\n\n    \u003Cspan class=\"hljs-keyword\">await\u003C/span> \u003Cspan class=\"hljs-keyword\">new\u003C/span> \u003Cspan class=\"hljs-title class_\">Promise\u003C/span>(\u003Cspan class=\"hljs-function\">\u003Cspan class=\"hljs-params\">r\u003C/span> =&gt;\u003C/span> \u003Cspan class=\"hljs-built_in\">setTimeout\u003C/span>(r, \u003Cspan class=\"hljs-number\">3000\u003C/span>)); \u003Cspan class=\"hljs-comment\">// sleep for 3 secs to avoid ratelimiting\u003C/span>\n}\n\nfs.\u003Cspan class=\"hljs-title function_\">writeFileSync\u003C/span>(\u003Cspan class=\"hljs-string\">&#x27;./scraped.json&#x27;\u003C/span>, \u003Cspan class=\"hljs-title class_\">JSON\u003C/span>.\u003Cspan class=\"hljs-title function_\">stringify\u003C/span>(allCompiled)); \u003Cspan class=\"hljs-comment\">// output our deals to scraped.json\u003C/span>\n\u003C/code>\u003C/pre>\u003Ch3>GitHub Action\u003C/h3>\n\u003Cp>And that&#39;s it! I did mention that we are using a GitHub Action to automatically scrape the data so here is the script for that. Every 10 minutes, it checks out the repository, runs our JS file, and commits the changed files back to the repository. \u003Cem>Note: \u003Ccode>GH_TOKEN\u003C/code> is a repository secret that contains a GitHub personal access token with write content permission to the repository.\u003C/em>\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-yml\">\u003Cspan class=\"hljs-attr\">name:\u003C/span> \u003Cspan class=\"hljs-string\">Cron\u003C/span> \u003Cspan class=\"hljs-string\">Scrape\u003C/span>\n\n\u003Cspan class=\"hljs-attr\">on:\u003C/span>\n  \u003Cspan class=\"hljs-attr\">schedule:\u003C/span>\n    \u003Cspan class=\"hljs-bullet\">-\u003C/span> \u003Cspan class=\"hljs-attr\">cron:\u003C/span> \u003Cspan class=\"hljs-string\">&quot;*/10 * * * *&quot;\u003C/span>\n\n\u003Cspan class=\"hljs-attr\">permissions:\u003C/span>\n  \u003Cspan class=\"hljs-attr\">contents:\u003C/span> \u003Cspan class=\"hljs-string\">write\u003C/span>\n\n\u003Cspan class=\"hljs-attr\">jobs:\u003C/span>\n  \u003Cspan class=\"hljs-attr\">build:\u003C/span>\n    \u003Cspan class=\"hljs-attr\">runs-on:\u003C/span> \u003Cspan class=\"hljs-string\">ubuntu-latest\u003C/span>\n    \u003Cspan class=\"hljs-attr\">name:\u003C/span> \u003Cspan class=\"hljs-string\">Run\u003C/span> \u003Cspan class=\"hljs-string\">scrape.mjs\u003C/span> \u003Cspan class=\"hljs-string\">and\u003C/span> \u003Cspan class=\"hljs-string\">commit\u003C/span> \u003Cspan class=\"hljs-string\">changes\u003C/span>\n    \u003Cspan class=\"hljs-attr\">env:\u003C/span>\n      \u003Cspan class=\"hljs-attr\">GITHUB_TOKEN:\u003C/span> \u003Cspan class=\"hljs-string\">${{\u003C/span> \u003Cspan class=\"hljs-string\">secrets.GH_TOKEN\u003C/span> \u003Cspan class=\"hljs-string\">}}\u003C/span>\n    \u003Cspan class=\"hljs-attr\">steps:\u003C/span>\n    \u003Cspan class=\"hljs-bullet\">-\u003C/span> \u003Cspan class=\"hljs-attr\">uses:\u003C/span> \u003Cspan class=\"hljs-string\">actions/checkout@v3\u003C/span>\n    \u003Cspan class=\"hljs-bullet\">-\u003C/span> \u003Cspan class=\"hljs-attr\">name:\u003C/span> \u003Cspan class=\"hljs-string\">Setup\u003C/span> \u003Cspan class=\"hljs-string\">Node\u003C/span>\n      \u003Cspan class=\"hljs-attr\">uses:\u003C/span> \u003Cspan class=\"hljs-string\">actions/setup-node@v3\u003C/span>\n      \u003Cspan class=\"hljs-attr\">with:\u003C/span>\n        \u003Cspan class=\"hljs-attr\">node-version:\u003C/span> \u003Cspan class=\"hljs-number\">20.3\u003C/span>\u003Cspan class=\"hljs-number\">.0\u003C/span>\n    \u003Cspan class=\"hljs-bullet\">-\u003C/span> \u003Cspan class=\"hljs-attr\">run:\u003C/span> \u003Cspan class=\"hljs-string\">npm\u003C/span> \u003Cspan class=\"hljs-string\">i\u003C/span>\n    \u003Cspan class=\"hljs-bullet\">-\u003C/span> \u003Cspan class=\"hljs-attr\">run:\u003C/span> \u003Cspan class=\"hljs-string\">|\n        git config --global user.name &quot;gh-actions&quot;\n        git config --global user.email &quot;gh-actions@github.com&quot;\n        git remote set-url origin https://git:${GITHUB_TOKEN}@github.com/${{github.repository}}.git\n\u003C/span>    \u003Cspan class=\"hljs-bullet\">-\u003C/span> \u003Cspan class=\"hljs-attr\">run:\u003C/span> \u003Cspan class=\"hljs-string\">npm\u003C/span> \u003Cspan class=\"hljs-string\">run\u003C/span> \u003Cspan class=\"hljs-string\">main\u003C/span>\n    \u003Cspan class=\"hljs-bullet\">-\u003C/span> \u003Cspan class=\"hljs-attr\">run:\u003C/span> \u003Cspan class=\"hljs-string\">git\u003C/span> \u003Cspan class=\"hljs-string\">commit\u003C/span> \u003Cspan class=\"hljs-string\">--allow-empty\u003C/span> \u003Cspan class=\"hljs-string\">-am\u003C/span> \u003Cspan class=\"hljs-string\">&quot;update scraped.json&quot;\u003C/span>\n    \u003Cspan class=\"hljs-bullet\">-\u003C/span> \u003Cspan class=\"hljs-attr\">run:\u003C/span> \u003Cspan class=\"hljs-string\">git\u003C/span> \u003Cspan class=\"hljs-string\">push\u003C/span>\n\u003C/code>\u003C/pre>\u003Ch3>Rendering the Data\u003C/h3>\n\u003Cp>With the data successfully scraped, we may now make a nice user interface. I did so using GitHub Pages and you can visit it \u003Ca href=\"https://recurse-eats.dim.codes/\">here\u003C/a>. The source code for the page itself is \u003Ca href=\"https://github.com/xDimGG/recurse-ubereats/blob/main/index.html\">here\u003C/a>.\u003C/p>\n\u003Ch2>Final Notes\u003C/h2>\n\u003Cp>I hope you can go and start using puppeteer yourself. I barely scratched the surface of puppeteer&#39;s capabilities, but these are probably the most useful parts. During this small project, I learned that it&#39;s better to quit early and opt for the &quot;easier&quot; method sooner as sometimes all you need is a working product that can feed some hungry stomachs. Hope you&#39;ve enjoyed. See you again!\u003C/p>\n",title:"Finding Deals on UberEats with Node.js and GitHub Actions",date:1707239672851,tags:["github-actions","javascript","puppeteer","scraping"]},{id:"premia",content:"{\n\t\"title\": \"Finding Cheap Flight Tickets With Python\",\n\t\"date\": 1706727822114,\n\t\"tags\": [\"data\", \"scraping\", \"python\"]\n}\n---\n\nA story on how I beat every travel site to the punch to book the best round-trip flights to South Korea. [TL;DR](https://gist.github.com/xDimGG/eaf80e2dfac2e920ca023306b9e72437).\n\n### Some Background\n\nThere is this relatively new airline called Air Premia that provides non-stop flights from four American airports to Incheon Airport in South Korea. As someone who lives near one of the four airports and is interested in visiting Korea, I wanted to capitalize on Air Premia's relatively cheap flight tickets.\n\n### The Problem\n\nBecause of how new Air Premia was, it still wasn't on the radar of many travel sites like Kayak and Expedia. It is now, but it wasn't then.\n\n### The Solution\n\nWrite a Python script to scrape data from Air Premia's site and go through that data to determine when the best time of year is to buy tickets and what tickets were cheapest.\n\n## Getting Started\n\nFor starters, let me show you what searching for tickets on [Air Premia](https://www.airpremia.com/) looks like. First, you decide between Roundtrip and One-way. Next, you choose the airport you're departing form. Next, you choose the airport you're arriving at. Next, you click on the date. When clicking on the date, you get a brief loading screen followed by some calendar dates and a price for each applicable date.\n\n![Air Premia calendar UI](/premia_1.png)\n\nWowie, that's a lot of prices at once! After a bit of exploration, I found that you can only book flights up to 9 months in advance. After that, no more prices are shown.\n\n### What is Happening?\n\nWell, when we click on the date selector or click on the arrows to load the next month, our browser is probably making an API request to get the prices given our parameters (departing from terminal, arriving at terminal, etc.). We can confirm that this is the case by opening up our Chrome developer tools and going to the network tab. With this tool, we can see every request that the current tab makes. Refreshing the page and choosing the same options as before, we are able to capture the following request.\n\n![Air Premia API request](/premia_2.png)\n\nOkay, so our browser is making an HTTP GET request to `https://www.airpremia.com/pssapi/lowfare` with some query parameters. Let's format that URL so that we can actually read the parameters. *Note: you can see the same thing by going to the `Payload` tab of the request in Chrome.*\n\n```\nhttps://www.airpremia.com/pssapi/lowfare\n\t?origin=EWR\n\t&destination=ICN\n\t&tripType=RT\n\t&beginDate=2024-01-31\n\t&endDate=2024-02-29\n\t&loyalty=MonetaryOnly\n\t&fareTypes=FI\n\t&currency=USD\n\t&useCache=true\n```\n\nLet's also take a look at the `Response` tab to see what data we're getting back.\n\n![Air Premia API response](/premia_3.png)\n\nAs far as reverse engineering APIs goes, Air Premia is definitely on the easier side of things. All the parameters are clearly written out and the response is in neatly structured JSON data. There are still some guesses we have to make regarding the data that we can confirm by making more requests.\n\nSo, in our request we have the obvious parameters `origin=EWR` and `destination=ICN`, both of which use [IATA Location Identifiers](https://en.wikipedia.org/wiki/IATA_airport_code) (EWR for Newark Liberty International Airport and ICN for Incheon International Airport).\n\nThen we have `tripType=RT`. We can guess that this means round-trip and verify this by selecting `One-way` from the UI and seeing that the request the browser sends contains `tripType=OW` instead.\n\nNext is `beginDate=2024-01-31` and `endDate=2024-02-29`. These are also pretty obvious, but it's worth making a note that the format of these dates is `YYYY-MM-DD`.\n\nWe have `currency=USD`, which should be very obvious. Since Air Premia travels to Korea, Thailand, Tokyo, and the U.S., the possible currencies are most likely `KWN`, `THB`, `JPY`, and `USD`. This was confirmed by selecting one-way tickets and changing the departure terminals to different countries.\n\nFinally, we also have `loyalty`, `fareTypes`, and `useCache`. These don't seem very useful so I'll just leave them as they are.\n\n### Now What?\n\nWell, we figured out how the API works. Now, we need to write some code to make requests to these endpoints and store their data in some kind of data structure. I like working with [Jupyter Notebook](https://jupyter.org/) since it lets you hold onto variables while writing your code. Anyway, let's import `requests` and try making a GET request to the endpoint with the same parameters as before, but just written out in a dictionary. `raise_for_status()` raises an error if our response has a bad status code. `json()` will just parse the response data in the JSON format.\n\n```py\nimport requests\n\nres = requests.get(\n\t'https://www.airpremia.com/pssapi/lowfare?loyalty=MonetaryOnly&fareTypes=FI&useCache=true',\n\tparams={\n\t\t'tripType': 'RT',\n\t\t'origin': 'EWR',\n\t\t'destination': 'ICN',\n\t\t'beginDate': '2024-01-31',\n\t\t'endDate': '2024-02-29',\n\t\t'currency': 'USD',\n\t},\n)\nres.raise_for_status()\nres.json()\n```\n\nRunning this code, we get back `HTTPError: 400 Client Error`. Annoying but not unexpected. Client requests often require additional headers/cookies in order to work. In this case, after some guess and check of removing and adding headers, it turns out all we need is the `X-Content-ID` header. It doesn't even have to be set to anything... it just has to exist.\n\n```diff\n...\n\t\t'currency': 'USD',\n\t},\n+\theaders={'X-Context-ID': ''},\n)\nres.raise_for_status()\n...\n```\n\nRunning that code again, we now get a JSON response that looks something like this (after being parsed).\n\n```py\n{'data': {'EWR-ICN': [{'date': '2024-01-31',\n    'soldOut': False,\n    'noFights': True,\n\t\t# ...\n  'ICN-EWR': [{'date': '2024-01-31',\n    'soldOut': False,\n    'noFights': True,\n\t\t# ...\n    'PE': None}]}}\n```\n\nSince we are using `tripType=RT`, the response includes the costs for EWR to ICN and ICN to EWR. Let's create a list of dates that we're interested in iterating over. To do this, I'm taking advantage of [python-dateutil](https://pypi.org/project/python-dateutil/), which provides some nice convenience methods for generating ranges of dates and mutating date objects.\n\n```py\nfrom datetime import date\nfrom dateutil.rrule import rrule, MONTHLY\nfrom dateutil.relativedelta import relativedelta\n\n# Get today's date and replace the day with 1 to be at the beginning of the month\nTODAY = date.today().replace(day=1)\n# Starting from the current month, generate a range with 10 elements at a monthly frequency\ndates = list(rrule(freq=MONTHLY, dtstart=TODAY, count=10))\n# Set every other month's date to the last day of the month\nfor i in range(1, len(dates), 2):\n\tdates[i] += relativedelta(day=31)\n\n# Format the dates in the format YYYY-MM-DD\ndates = [m.strftime('%Y-%m-%d') for m in dates]\n```\n\nAfter running this code, our `dates` variable now contains this.\n\n```py\n['2024-01-01',\n '2024-02-29',\n '2024-03-01',\n '2024-04-30',\n '2024-05-01',\n '2024-06-30',\n '2024-07-01',\n '2024-08-31',\n '2024-09-01',\n '2024-10-31']\n```\n\nWould it have been faster to type these out by hand? Yes, but it would not have been as fun.\n\nWith this done, let's start iterating over all the date ranges and getting flight data for all the possible dates. Mind you, we want to query two months at a time. This means that we will have `2024-01-01 through 2024-02-29`, `2024-03-01 through 2024-04-30`, and so on. We are matching every even indexed element with every odd indexed element. To do this, we may use Python's [zip](https://docs.python.org/3/library/functions.html#zip) function and [array slicing](https://www.w3schools.com/python/numpy/numpy_array_slicing.asp).\n\n`dates[::2]` gives us every other element starting from 0 and `dates[1::2]` gives use every other element starting from 1. *Note: `dates[::2]` is implicitly `dates[0:len(dates):2]` and `dates[1::2]` is implicitly `dates[1:len(dates):2]`.* Now that we have these two iterators, we may merge them using `zip`. Let's just do `zip(dates[::2], dates[1::2])` and iterate over it to make sure everything works.\n\n![testing our use of zip](/premia_4.png)\n\nPay attention to the `start, end` in our loop. Each value of `zip()` is returned as a tuple and we can use comma-separated variables to extract the tuple's individual parts. With this done, we may begin making our GET requests. Let's just move our GET request to a function that takes some variables. If `trip_type` is RT, our method returns a tuple containg the flights to our destination and the return flights. If `trip_type` isn't RT, we return only flights going to our destination.\n\n```py\nimport requests\n\ndef fetch(trip_type, origin, destination, start_date, end_date, currency='USD'):\n\tres = requests.get(\n\t\t'https://www.airpremia.com/pssapi/lowfare?loyalty=MonetaryOnly&fareTypes=FI&useCache=true',\n\t\tparams={\n\t\t\t'tripType': trip_type,\n\t\t\t'origin': origin,\n\t\t\t'destination': destination,\n\t\t\t'beginDate': start_date,\n\t\t\t'endDate': end_date,\n\t\t\t'currency': currency,\n\t\t},\n\t\theaders={'X-Context-ID': ''},\n\t)\n\tres.raise_for_status()\n\tdata = res.json()['data']\n\tgoing = data[f'{origin}-{destination}']\n\n\treturn (going, data[f'{destination}-{origin}']) if trip_type == 'RT' else going\n```\n\nNow, let's write a function like `fetch` called `fetch_all` that takes `trip_type`, `origin`, `destination`, and `currency`, and returns every single available flight. Here, we take advantage of [concurrent.futures.ThreadPoolExecutor](https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.ThreadPoolExecutor) to concurrently request all date ranges and compile them all into one or two arrays (depending on if `trip_type` is `RT` or `OW`). *Note: this whole OW/RT and value/2-tuple business and is very annoying to write code for. If you know a better way of doing this in Python, please advise.*\n\n```py\nfrom concurrent.futures import ThreadPoolExecutor\n\ndef fetch_all(trip_type, origin, destination, currency='USD'):\n\tgoing = []\n\tcoming = []\n\n\twith ThreadPoolExecutor() as executor:\n\t\tfor res in executor.map(\n\t\t\t\tlambda args: fetch(trip_type, origin, destination, *args, currency),\n\t\t\t\tzip(dates[::2], dates[1::2])):\n\t\t\tif trip_type == 'RT':\n\t\t\t\tgoing += res[0]\n\t\t\t\tcoming += res[1]\n\t\t\telse:\n\t\t\t\tgoing += res\n\n\treturn (going, coming) if trip_type == 'RT' else going\n```\n\nThis blog post is already getting pretty long. Let me just briefly cover what the rest of the code does. Here, we are taking our arrays, filtering out days which don't have prices, flattening the data, and converting the data to `pandas.DataFrame` objects. The benefit of using pandas is that we get access to a lot of methods to assess our data. *Note: we are using 'E' to represent economy. I mean, who'd go to this extent saving money but also fly premium.*\n\n```py\nimport pandas as pd\nfrom dateutil.parser import parse\n\n# c = 'E' or 'PE' (premium) economy\ndef to_clean_df(data, c='E'):\n\tclean = [{\n\t\t'date': parse(d['date']),\n\t\t'available': d[c]['availableCount'],\n\t\t'fare': d[c]['fareAmount'],\n\t\t'fees': d[c]['taxesAndFeesAmount'],\n\t\t'total': d[c]['fareAmount'] + d[c]['taxesAndFeesAmount'],\n\t} for d in data if d[c] is not None]\n\t\n\treturn pd.DataFrame(clean).sort_values('date')\n\nicn_ow = to_clean_df(ewr_icn_ow) # one-way ewr-icn\newr_ow = to_clean_df(icn_ewr_ow) # one-way icn-ewr\nicn_rt = to_clean_df(ewr_icn_rt) # round-trip price ewr-icn\newr_rt = to_clean_df(icn_ewr_rt) # round-trip price icn-ewr\n\nassert icn_ow.size == icn_rt.size\nassert ewr_ow.size == ewr_rt.size\n```\n\nLet's write a bit of code to find the `n` cheapest trips given a date range we want the trip to be during, the minimum number of days the trip should be, and the maximum number of days the trip should be. This code could be optimized by avoiding a lot of unnecessary iteration and using a heap queue. *Note: `leaving` and `returning` are `pandas.DataFrame` objects, not lists.*\n\n```py\ndef n_cheapest_trips(leaving, returning, after, before, min_days=1, max_days=270, n=10):\n\tafter = parse(after)\n\tbefore = parse(before)\n\t# a quick lookup map of dates to total costs for returning flights\n\tr_map = {str(d): t for d, t in zip(returning['date'], returning['total'])}\n\tn_best = []\n\n\t# iterate over each leaving day\n\tfor day in leaving.itertuples():\n\t\t# if the day is not within our date range, skip it\n\t\tif after > day.date or before \u003C day.date:\n\t\t\tcontinue\n\n\t\t# iterate over each number of days in the min, max range (inclusive)\n\t\tfor days in range(min_days, max_days + 1):\n\t\t\t# check if there is a returning flight available on current day + trip length\n\t\t\td = day.date + relativedelta(days=days)\n\t\t\tif after > d or before \u003C d or str(d) not in r_map:\n\t\t\t\tcontinue\n\n\t\t\t# sum of leaving and returning cost\n\t\t\ttotal_cost = day.total + r_map[str(d)]\n\t\t\t# update n best items, maintaining length \u003C= n\n\t\t\tn_best += [(total_cost, day.date.strftime('%Y-%m-%d'), d.strftime('%Y-%m-%d'), days)]\n\t\t\tn_best = sorted(n_best, key=lambda x: x[0])\n\t\t\tn_best = n_best[:n]\n\n\treturn n_best\n```\n\nWith this function, we can finally do what our original goal was, which is to find the best priced tickets. Let's suppose I want a 10 to 20 day trip between March 1, 2024 and May 31, 2024. Here is the result of that, using our round-trip data as input.\n\n![Air Premia best possible tickets given parameters](/premia_7.png)\n\nIt seems like we have quite a few options that are all $1,078. Let's see if we get a better price using our one-way data as input. Rather than buying both tickets together, you would have to purchase them separately.\n\n![Air Premia best possible tickets given parameters with one-way data](/premia_8.png)\n\nAs it turns out, we can actually get tickets for $57 cheaper by just buying two one-way tickets instead of round-trip tickets. I had always assumed that round-trip tickets would be cheaper than two one-way tickets, but I guess that's not always the case.\n\nMission complete. I still would like to plot some data so that we can get a sense for when tickets are cheaper and maybe uncover some other interesting patterns.\n\nLet's import [matplotlib](https://matplotlib.org/) so that we can do some data visualization. I'm changing the default pyplot size and DPI to make the output wider and higher resolution.\n\n```py\nfrom matplotlib import pyplot as plt\nplt.rcParams['figure.figsize'] = (17, 4)\nplt.rcParams['figure.dpi'] = 200\n```\n\nLet's start by showing the prices for different days. I'll split this into two charts. One for one-way trips and another for round-trips. Some of the bars will overlap one another but you can still see the general pattern, which is what we're after. *Note: the code for round-trip tickets is almost identical.*\n\n```py\nplt.title('USD Cost of One-way Economy Tickets')\nplt.bar(icn_ow['date'], icn_ow['total'], color='C0', label='EWR -> ICN')\nplt.bar(ewr_ow['date'], ewr_ow['total'], color='C6', label='ICN -> EWR')\nplt.legend()\nplt.show()\n```\n\n![Air Premia USD Cost of One-way Economy Tickets](/premia_5.png)\n![Air Premia USD Cost of Round-trip Economy Tickets](/premia_6.png)\n\nLet's check out what the price difference between one-way and round-trip tickets for the same flight is. We will use the following code which computes `one way cost - round trip cost`. If this number is positive, that means one-way costs more. If it's negative, round-trip costs more. *Note: the code for tickets to Newark is almost identical.*\n\n```py\nplt.title('USD Price Difference Between One-way and Round-trip Tickets to Incheon')\nplt.bar(icn_ow['date'], icn_ow['total'] - icn_rt['total'], color='C0')\nplt.show()\n```\n\n![Air Premia USD Price Difference Between One-way and Round-trip Tickets to Incheon](/premia_9.png)\n![Air Premia USD Price Difference Between One-way and Round-trip Tickets to Newark](/premia_10.png)\n\nWell now that we have a graphical understanding of the price difference, let's get a numerical sense for it by taking the mean of the differences.\n\n```py\n(icn_ow['total'] - icn_rt['total']).mean(), (ewr_ow['total'] - ewr_rt['total']).mean()\n```\n\nThe result of this is about `(104.19, -137.54)`. This means that on average, you are saving $104.19 on the tickets to your location by buying round-trip, but you are losing $138.54 on the return tickets. A pair of round-trip tickets is about $33.35 more expensive than two one-way tickets.\n\n## Conclusion\n\nCongratulations if you've made it this far. You must really like data scraping. I hope you've enjoyed and that you can take the data and create your own visualizations. As an aside, I did check if there was any price difference between currencies, but they all came out to about the same when converted to USD. Good luck and happy coding.\n",html:"\u003Cp>A story on how I beat every travel site to the punch to book the best round-trip flights to South Korea. \u003Ca href=\"https://gist.github.com/xDimGG/eaf80e2dfac2e920ca023306b9e72437\">TL;DR\u003C/a>.\u003C/p>\n\u003Ch3>Some Background\u003C/h3>\n\u003Cp>There is this relatively new airline called Air Premia that provides non-stop flights from four American airports to Incheon Airport in South Korea. As someone who lives near one of the four airports and is interested in visiting Korea, I wanted to capitalize on Air Premia&#39;s relatively cheap flight tickets.\u003C/p>\n\u003Ch3>The Problem\u003C/h3>\n\u003Cp>Because of how new Air Premia was, it still wasn&#39;t on the radar of many travel sites like Kayak and Expedia. It is now, but it wasn&#39;t then.\u003C/p>\n\u003Ch3>The Solution\u003C/h3>\n\u003Cp>Write a Python script to scrape data from Air Premia&#39;s site and go through that data to determine when the best time of year is to buy tickets and what tickets were cheapest.\u003C/p>\n\u003Ch2>Getting Started\u003C/h2>\n\u003Cp>For starters, let me show you what searching for tickets on \u003Ca href=\"https://www.airpremia.com/\">Air Premia\u003C/a> looks like. First, you decide between Roundtrip and One-way. Next, you choose the airport you&#39;re departing form. Next, you choose the airport you&#39;re arriving at. Next, you click on the date. When clicking on the date, you get a brief loading screen followed by some calendar dates and a price for each applicable date.\u003C/p>\n\u003Cp>\u003Cimg src=\"/premia_1.png\" alt=\"Air Premia calendar UI\">\u003C/p>\n\u003Cp>Wowie, that&#39;s a lot of prices at once! After a bit of exploration, I found that you can only book flights up to 9 months in advance. After that, no more prices are shown.\u003C/p>\n\u003Ch3>What is Happening?\u003C/h3>\n\u003Cp>Well, when we click on the date selector or click on the arrows to load the next month, our browser is probably making an API request to get the prices given our parameters (departing from terminal, arriving at terminal, etc.). We can confirm that this is the case by opening up our Chrome developer tools and going to the network tab. With this tool, we can see every request that the current tab makes. Refreshing the page and choosing the same options as before, we are able to capture the following request.\u003C/p>\n\u003Cp>\u003Cimg src=\"/premia_2.png\" alt=\"Air Premia API request\">\u003C/p>\n\u003Cp>Okay, so our browser is making an HTTP GET request to \u003Ccode>https://www.airpremia.com/pssapi/lowfare\u003C/code> with some query parameters. Let&#39;s format that URL so that we can actually read the parameters. \u003Cem>Note: you can see the same thing by going to the \u003Ccode>Payload\u003C/code> tab of the request in Chrome.\u003C/em>\u003C/p>\n\u003Cpre>\u003Ccode>https://www.airpremia.com/pssapi/lowfare\n    ?origin=EWR\n    &amp;destination=ICN\n    &amp;tripType=RT\n    &amp;beginDate=2024-01-31\n    &amp;endDate=2024-02-29\n    &amp;loyalty=MonetaryOnly\n    &amp;fareTypes=FI\n    &amp;currency=USD\n    &amp;useCache=true\n\u003C/code>\u003C/pre>\u003Cp>Let&#39;s also take a look at the \u003Ccode>Response\u003C/code> tab to see what data we&#39;re getting back.\u003C/p>\n\u003Cp>\u003Cimg src=\"/premia_3.png\" alt=\"Air Premia API response\">\u003C/p>\n\u003Cp>As far as reverse engineering APIs goes, Air Premia is definitely on the easier side of things. All the parameters are clearly written out and the response is in neatly structured JSON data. There are still some guesses we have to make regarding the data that we can confirm by making more requests.\u003C/p>\n\u003Cp>So, in our request we have the obvious parameters \u003Ccode>origin=EWR\u003C/code> and \u003Ccode>destination=ICN\u003C/code>, both of which use \u003Ca href=\"https://en.wikipedia.org/wiki/IATA_airport_code\">IATA Location Identifiers\u003C/a> (EWR for Newark Liberty International Airport and ICN for Incheon International Airport).\u003C/p>\n\u003Cp>Then we have \u003Ccode>tripType=RT\u003C/code>. We can guess that this means round-trip and verify this by selecting \u003Ccode>One-way\u003C/code> from the UI and seeing that the request the browser sends contains \u003Ccode>tripType=OW\u003C/code> instead.\u003C/p>\n\u003Cp>Next is \u003Ccode>beginDate=2024-01-31\u003C/code> and \u003Ccode>endDate=2024-02-29\u003C/code>. These are also pretty obvious, but it&#39;s worth making a note that the format of these dates is \u003Ccode>YYYY-MM-DD\u003C/code>.\u003C/p>\n\u003Cp>We have \u003Ccode>currency=USD\u003C/code>, which should be very obvious. Since Air Premia travels to Korea, Thailand, Tokyo, and the U.S., the possible currencies are most likely \u003Ccode>KWN\u003C/code>, \u003Ccode>THB\u003C/code>, \u003Ccode>JPY\u003C/code>, and \u003Ccode>USD\u003C/code>. This was confirmed by selecting one-way tickets and changing the departure terminals to different countries.\u003C/p>\n\u003Cp>Finally, we also have \u003Ccode>loyalty\u003C/code>, \u003Ccode>fareTypes\u003C/code>, and \u003Ccode>useCache\u003C/code>. These don&#39;t seem very useful so I&#39;ll just leave them as they are.\u003C/p>\n\u003Ch3>Now What?\u003C/h3>\n\u003Cp>Well, we figured out how the API works. Now, we need to write some code to make requests to these endpoints and store their data in some kind of data structure. I like working with \u003Ca href=\"https://jupyter.org/\">Jupyter Notebook\u003C/a> since it lets you hold onto variables while writing your code. Anyway, let&#39;s import \u003Ccode>requests\u003C/code> and try making a GET request to the endpoint with the same parameters as before, but just written out in a dictionary. \u003Ccode>raise_for_status()\u003C/code> raises an error if our response has a bad status code. \u003Ccode>json()\u003C/code> will just parse the response data in the JSON format.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-py\">\u003Cspan class=\"hljs-keyword\">import\u003C/span> requests\n\nres = requests.get(\n    \u003Cspan class=\"hljs-string\">&#x27;https://www.airpremia.com/pssapi/lowfare?loyalty=MonetaryOnly&amp;fareTypes=FI&amp;useCache=true&#x27;\u003C/span>,\n    params={\n        \u003Cspan class=\"hljs-string\">&#x27;tripType&#x27;\u003C/span>: \u003Cspan class=\"hljs-string\">&#x27;RT&#x27;\u003C/span>,\n        \u003Cspan class=\"hljs-string\">&#x27;origin&#x27;\u003C/span>: \u003Cspan class=\"hljs-string\">&#x27;EWR&#x27;\u003C/span>,\n        \u003Cspan class=\"hljs-string\">&#x27;destination&#x27;\u003C/span>: \u003Cspan class=\"hljs-string\">&#x27;ICN&#x27;\u003C/span>,\n        \u003Cspan class=\"hljs-string\">&#x27;beginDate&#x27;\u003C/span>: \u003Cspan class=\"hljs-string\">&#x27;2024-01-31&#x27;\u003C/span>,\n        \u003Cspan class=\"hljs-string\">&#x27;endDate&#x27;\u003C/span>: \u003Cspan class=\"hljs-string\">&#x27;2024-02-29&#x27;\u003C/span>,\n        \u003Cspan class=\"hljs-string\">&#x27;currency&#x27;\u003C/span>: \u003Cspan class=\"hljs-string\">&#x27;USD&#x27;\u003C/span>,\n    },\n)\nres.raise_for_status()\nres.json()\n\u003C/code>\u003C/pre>\u003Cp>Running this code, we get back \u003Ccode>HTTPError: 400 Client Error\u003C/code>. Annoying but not unexpected. Client requests often require additional headers/cookies in order to work. In this case, after some guess and check of removing and adding headers, it turns out all we need is the \u003Ccode>X-Content-ID\u003C/code> header. It doesn&#39;t even have to be set to anything... it just has to exist.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-diff\">...\n        &#x27;currency&#x27;: &#x27;USD&#x27;,\n    },\n\u003Cspan class=\"hljs-addition\">+\theaders={&#x27;X-Context-ID&#x27;: &#x27;&#x27;},\u003C/span>\n)\nres.raise_for_status()\n...\n\u003C/code>\u003C/pre>\u003Cp>Running that code again, we now get a JSON response that looks something like this (after being parsed).\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-py\">{\u003Cspan class=\"hljs-string\">&#x27;data&#x27;\u003C/span>: {\u003Cspan class=\"hljs-string\">&#x27;EWR-ICN&#x27;\u003C/span>: [{\u003Cspan class=\"hljs-string\">&#x27;date&#x27;\u003C/span>: \u003Cspan class=\"hljs-string\">&#x27;2024-01-31&#x27;\u003C/span>,\n    \u003Cspan class=\"hljs-string\">&#x27;soldOut&#x27;\u003C/span>: \u003Cspan class=\"hljs-literal\">False\u003C/span>,\n    \u003Cspan class=\"hljs-string\">&#x27;noFights&#x27;\u003C/span>: \u003Cspan class=\"hljs-literal\">True\u003C/span>,\n        \u003Cspan class=\"hljs-comment\"># ...\u003C/span>\n  \u003Cspan class=\"hljs-string\">&#x27;ICN-EWR&#x27;\u003C/span>: [{\u003Cspan class=\"hljs-string\">&#x27;date&#x27;\u003C/span>: \u003Cspan class=\"hljs-string\">&#x27;2024-01-31&#x27;\u003C/span>,\n    \u003Cspan class=\"hljs-string\">&#x27;soldOut&#x27;\u003C/span>: \u003Cspan class=\"hljs-literal\">False\u003C/span>,\n    \u003Cspan class=\"hljs-string\">&#x27;noFights&#x27;\u003C/span>: \u003Cspan class=\"hljs-literal\">True\u003C/span>,\n        \u003Cspan class=\"hljs-comment\"># ...\u003C/span>\n    \u003Cspan class=\"hljs-string\">&#x27;PE&#x27;\u003C/span>: \u003Cspan class=\"hljs-literal\">None\u003C/span>}]}}\n\u003C/code>\u003C/pre>\u003Cp>Since we are using \u003Ccode>tripType=RT\u003C/code>, the response includes the costs for EWR to ICN and ICN to EWR. Let&#39;s create a list of dates that we&#39;re interested in iterating over. To do this, I&#39;m taking advantage of \u003Ca href=\"https://pypi.org/project/python-dateutil/\">python-dateutil\u003C/a>, which provides some nice convenience methods for generating ranges of dates and mutating date objects.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-py\">\u003Cspan class=\"hljs-keyword\">from\u003C/span> datetime \u003Cspan class=\"hljs-keyword\">import\u003C/span> date\n\u003Cspan class=\"hljs-keyword\">from\u003C/span> dateutil.rrule \u003Cspan class=\"hljs-keyword\">import\u003C/span> rrule, MONTHLY\n\u003Cspan class=\"hljs-keyword\">from\u003C/span> dateutil.relativedelta \u003Cspan class=\"hljs-keyword\">import\u003C/span> relativedelta\n\n\u003Cspan class=\"hljs-comment\"># Get today&#x27;s date and replace the day with 1 to be at the beginning of the month\u003C/span>\nTODAY = date.today().replace(day=\u003Cspan class=\"hljs-number\">1\u003C/span>)\n\u003Cspan class=\"hljs-comment\"># Starting from the current month, generate a range with 10 elements at a monthly frequency\u003C/span>\ndates = \u003Cspan class=\"hljs-built_in\">list\u003C/span>(rrule(freq=MONTHLY, dtstart=TODAY, count=\u003Cspan class=\"hljs-number\">10\u003C/span>))\n\u003Cspan class=\"hljs-comment\"># Set every other month&#x27;s date to the last day of the month\u003C/span>\n\u003Cspan class=\"hljs-keyword\">for\u003C/span> i \u003Cspan class=\"hljs-keyword\">in\u003C/span> \u003Cspan class=\"hljs-built_in\">range\u003C/span>(\u003Cspan class=\"hljs-number\">1\u003C/span>, \u003Cspan class=\"hljs-built_in\">len\u003C/span>(dates), \u003Cspan class=\"hljs-number\">2\u003C/span>):\n    dates[i] += relativedelta(day=\u003Cspan class=\"hljs-number\">31\u003C/span>)\n\n\u003Cspan class=\"hljs-comment\"># Format the dates in the format YYYY-MM-DD\u003C/span>\ndates = [m.strftime(\u003Cspan class=\"hljs-string\">&#x27;%Y-%m-%d&#x27;\u003C/span>) \u003Cspan class=\"hljs-keyword\">for\u003C/span> m \u003Cspan class=\"hljs-keyword\">in\u003C/span> dates]\n\u003C/code>\u003C/pre>\u003Cp>After running this code, our \u003Ccode>dates\u003C/code> variable now contains this.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-py\">[\u003Cspan class=\"hljs-string\">&#x27;2024-01-01&#x27;\u003C/span>,\n \u003Cspan class=\"hljs-string\">&#x27;2024-02-29&#x27;\u003C/span>,\n \u003Cspan class=\"hljs-string\">&#x27;2024-03-01&#x27;\u003C/span>,\n \u003Cspan class=\"hljs-string\">&#x27;2024-04-30&#x27;\u003C/span>,\n \u003Cspan class=\"hljs-string\">&#x27;2024-05-01&#x27;\u003C/span>,\n \u003Cspan class=\"hljs-string\">&#x27;2024-06-30&#x27;\u003C/span>,\n \u003Cspan class=\"hljs-string\">&#x27;2024-07-01&#x27;\u003C/span>,\n \u003Cspan class=\"hljs-string\">&#x27;2024-08-31&#x27;\u003C/span>,\n \u003Cspan class=\"hljs-string\">&#x27;2024-09-01&#x27;\u003C/span>,\n \u003Cspan class=\"hljs-string\">&#x27;2024-10-31&#x27;\u003C/span>]\n\u003C/code>\u003C/pre>\u003Cp>Would it have been faster to type these out by hand? Yes, but it would not have been as fun.\u003C/p>\n\u003Cp>With this done, let&#39;s start iterating over all the date ranges and getting flight data for all the possible dates. Mind you, we want to query two months at a time. This means that we will have \u003Ccode>2024-01-01 through 2024-02-29\u003C/code>, \u003Ccode>2024-03-01 through 2024-04-30\u003C/code>, and so on. We are matching every even indexed element with every odd indexed element. To do this, we may use Python&#39;s \u003Ca href=\"https://docs.python.org/3/library/functions.html#zip\">zip\u003C/a> function and \u003Ca href=\"https://www.w3schools.com/python/numpy/numpy_array_slicing.asp\">array slicing\u003C/a>.\u003C/p>\n\u003Cp>\u003Ccode>dates[::2]\u003C/code> gives us every other element starting from 0 and \u003Ccode>dates[1::2]\u003C/code> gives use every other element starting from 1. \u003Cem>Note: \u003Ccode>dates[::2]\u003C/code> is implicitly \u003Ccode>dates[0:len(dates):2]\u003C/code> and \u003Ccode>dates[1::2]\u003C/code> is implicitly \u003Ccode>dates[1:len(dates):2]\u003C/code>.\u003C/em> Now that we have these two iterators, we may merge them using \u003Ccode>zip\u003C/code>. Let&#39;s just do \u003Ccode>zip(dates[::2], dates[1::2])\u003C/code> and iterate over it to make sure everything works.\u003C/p>\n\u003Cp>\u003Cimg src=\"/premia_4.png\" alt=\"testing our use of zip\">\u003C/p>\n\u003Cp>Pay attention to the \u003Ccode>start, end\u003C/code> in our loop. Each value of \u003Ccode>zip()\u003C/code> is returned as a tuple and we can use comma-separated variables to extract the tuple&#39;s individual parts. With this done, we may begin making our GET requests. Let&#39;s just move our GET request to a function that takes some variables. If \u003Ccode>trip_type\u003C/code> is RT, our method returns a tuple containg the flights to our destination and the return flights. If \u003Ccode>trip_type\u003C/code> isn&#39;t RT, we return only flights going to our destination.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-py\">\u003Cspan class=\"hljs-keyword\">import\u003C/span> requests\n\n\u003Cspan class=\"hljs-keyword\">def\u003C/span> \u003Cspan class=\"hljs-title function_\">fetch\u003C/span>(\u003Cspan class=\"hljs-params\">trip_type, origin, destination, start_date, end_date, currency=\u003Cspan class=\"hljs-string\">&#x27;USD&#x27;\u003C/span>\u003C/span>):\n    res = requests.get(\n        \u003Cspan class=\"hljs-string\">&#x27;https://www.airpremia.com/pssapi/lowfare?loyalty=MonetaryOnly&amp;fareTypes=FI&amp;useCache=true&#x27;\u003C/span>,\n        params={\n            \u003Cspan class=\"hljs-string\">&#x27;tripType&#x27;\u003C/span>: trip_type,\n            \u003Cspan class=\"hljs-string\">&#x27;origin&#x27;\u003C/span>: origin,\n            \u003Cspan class=\"hljs-string\">&#x27;destination&#x27;\u003C/span>: destination,\n            \u003Cspan class=\"hljs-string\">&#x27;beginDate&#x27;\u003C/span>: start_date,\n            \u003Cspan class=\"hljs-string\">&#x27;endDate&#x27;\u003C/span>: end_date,\n            \u003Cspan class=\"hljs-string\">&#x27;currency&#x27;\u003C/span>: currency,\n        },\n        headers={\u003Cspan class=\"hljs-string\">&#x27;X-Context-ID&#x27;\u003C/span>: \u003Cspan class=\"hljs-string\">&#x27;&#x27;\u003C/span>},\n    )\n    res.raise_for_status()\n    data = res.json()[\u003Cspan class=\"hljs-string\">&#x27;data&#x27;\u003C/span>]\n    going = data[\u003Cspan class=\"hljs-string\">f&#x27;\u003Cspan class=\"hljs-subst\">{origin}\u003C/span>-\u003Cspan class=\"hljs-subst\">{destination}\u003C/span>&#x27;\u003C/span>]\n\n    \u003Cspan class=\"hljs-keyword\">return\u003C/span> (going, data[\u003Cspan class=\"hljs-string\">f&#x27;\u003Cspan class=\"hljs-subst\">{destination}\u003C/span>-\u003Cspan class=\"hljs-subst\">{origin}\u003C/span>&#x27;\u003C/span>]) \u003Cspan class=\"hljs-keyword\">if\u003C/span> trip_type == \u003Cspan class=\"hljs-string\">&#x27;RT&#x27;\u003C/span> \u003Cspan class=\"hljs-keyword\">else\u003C/span> going\n\u003C/code>\u003C/pre>\u003Cp>Now, let&#39;s write a function like \u003Ccode>fetch\u003C/code> called \u003Ccode>fetch_all\u003C/code> that takes \u003Ccode>trip_type\u003C/code>, \u003Ccode>origin\u003C/code>, \u003Ccode>destination\u003C/code>, and \u003Ccode>currency\u003C/code>, and returns every single available flight. Here, we take advantage of \u003Ca href=\"https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.ThreadPoolExecutor\">concurrent.futures.ThreadPoolExecutor\u003C/a> to concurrently request all date ranges and compile them all into one or two arrays (depending on if \u003Ccode>trip_type\u003C/code> is \u003Ccode>RT\u003C/code> or \u003Ccode>OW\u003C/code>). \u003Cem>Note: this whole OW/RT and value/2-tuple business and is very annoying to write code for. If you know a better way of doing this in Python, please advise.\u003C/em>\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-py\">\u003Cspan class=\"hljs-keyword\">from\u003C/span> concurrent.futures \u003Cspan class=\"hljs-keyword\">import\u003C/span> ThreadPoolExecutor\n\n\u003Cspan class=\"hljs-keyword\">def\u003C/span> \u003Cspan class=\"hljs-title function_\">fetch_all\u003C/span>(\u003Cspan class=\"hljs-params\">trip_type, origin, destination, currency=\u003Cspan class=\"hljs-string\">&#x27;USD&#x27;\u003C/span>\u003C/span>):\n    going = []\n    coming = []\n\n    \u003Cspan class=\"hljs-keyword\">with\u003C/span> ThreadPoolExecutor() \u003Cspan class=\"hljs-keyword\">as\u003C/span> executor:\n        \u003Cspan class=\"hljs-keyword\">for\u003C/span> res \u003Cspan class=\"hljs-keyword\">in\u003C/span> executor.\u003Cspan class=\"hljs-built_in\">map\u003C/span>(\n                \u003Cspan class=\"hljs-keyword\">lambda\u003C/span> args: fetch(trip_type, origin, destination, *args, currency),\n                \u003Cspan class=\"hljs-built_in\">zip\u003C/span>(dates[::\u003Cspan class=\"hljs-number\">2\u003C/span>], dates[\u003Cspan class=\"hljs-number\">1\u003C/span>::\u003Cspan class=\"hljs-number\">2\u003C/span>])):\n            \u003Cspan class=\"hljs-keyword\">if\u003C/span> trip_type == \u003Cspan class=\"hljs-string\">&#x27;RT&#x27;\u003C/span>:\n                going += res[\u003Cspan class=\"hljs-number\">0\u003C/span>]\n                coming += res[\u003Cspan class=\"hljs-number\">1\u003C/span>]\n            \u003Cspan class=\"hljs-keyword\">else\u003C/span>:\n                going += res\n\n    \u003Cspan class=\"hljs-keyword\">return\u003C/span> (going, coming) \u003Cspan class=\"hljs-keyword\">if\u003C/span> trip_type == \u003Cspan class=\"hljs-string\">&#x27;RT&#x27;\u003C/span> \u003Cspan class=\"hljs-keyword\">else\u003C/span> going\n\u003C/code>\u003C/pre>\u003Cp>This blog post is already getting pretty long. Let me just briefly cover what the rest of the code does. Here, we are taking our arrays, filtering out days which don&#39;t have prices, flattening the data, and converting the data to \u003Ccode>pandas.DataFrame\u003C/code> objects. The benefit of using pandas is that we get access to a lot of methods to assess our data. \u003Cem>Note: we are using &#39;E&#39; to represent economy. I mean, who&#39;d go to this extent saving money but also fly premium.\u003C/em>\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-py\">\u003Cspan class=\"hljs-keyword\">import\u003C/span> pandas \u003Cspan class=\"hljs-keyword\">as\u003C/span> pd\n\u003Cspan class=\"hljs-keyword\">from\u003C/span> dateutil.parser \u003Cspan class=\"hljs-keyword\">import\u003C/span> parse\n\n\u003Cspan class=\"hljs-comment\"># c = &#x27;E&#x27; or &#x27;PE&#x27; (premium) economy\u003C/span>\n\u003Cspan class=\"hljs-keyword\">def\u003C/span> \u003Cspan class=\"hljs-title function_\">to_clean_df\u003C/span>(\u003Cspan class=\"hljs-params\">data, c=\u003Cspan class=\"hljs-string\">&#x27;E&#x27;\u003C/span>\u003C/span>):\n    clean = [{\n        \u003Cspan class=\"hljs-string\">&#x27;date&#x27;\u003C/span>: parse(d[\u003Cspan class=\"hljs-string\">&#x27;date&#x27;\u003C/span>]),\n        \u003Cspan class=\"hljs-string\">&#x27;available&#x27;\u003C/span>: d[c][\u003Cspan class=\"hljs-string\">&#x27;availableCount&#x27;\u003C/span>],\n        \u003Cspan class=\"hljs-string\">&#x27;fare&#x27;\u003C/span>: d[c][\u003Cspan class=\"hljs-string\">&#x27;fareAmount&#x27;\u003C/span>],\n        \u003Cspan class=\"hljs-string\">&#x27;fees&#x27;\u003C/span>: d[c][\u003Cspan class=\"hljs-string\">&#x27;taxesAndFeesAmount&#x27;\u003C/span>],\n        \u003Cspan class=\"hljs-string\">&#x27;total&#x27;\u003C/span>: d[c][\u003Cspan class=\"hljs-string\">&#x27;fareAmount&#x27;\u003C/span>] + d[c][\u003Cspan class=\"hljs-string\">&#x27;taxesAndFeesAmount&#x27;\u003C/span>],\n    } \u003Cspan class=\"hljs-keyword\">for\u003C/span> d \u003Cspan class=\"hljs-keyword\">in\u003C/span> data \u003Cspan class=\"hljs-keyword\">if\u003C/span> d[c] \u003Cspan class=\"hljs-keyword\">is\u003C/span> \u003Cspan class=\"hljs-keyword\">not\u003C/span> \u003Cspan class=\"hljs-literal\">None\u003C/span>]\n    \n    \u003Cspan class=\"hljs-keyword\">return\u003C/span> pd.DataFrame(clean).sort_values(\u003Cspan class=\"hljs-string\">&#x27;date&#x27;\u003C/span>)\n\nicn_ow = to_clean_df(ewr_icn_ow) \u003Cspan class=\"hljs-comment\"># one-way ewr-icn\u003C/span>\newr_ow = to_clean_df(icn_ewr_ow) \u003Cspan class=\"hljs-comment\"># one-way icn-ewr\u003C/span>\nicn_rt = to_clean_df(ewr_icn_rt) \u003Cspan class=\"hljs-comment\"># round-trip price ewr-icn\u003C/span>\newr_rt = to_clean_df(icn_ewr_rt) \u003Cspan class=\"hljs-comment\"># round-trip price icn-ewr\u003C/span>\n\n\u003Cspan class=\"hljs-keyword\">assert\u003C/span> icn_ow.size == icn_rt.size\n\u003Cspan class=\"hljs-keyword\">assert\u003C/span> ewr_ow.size == ewr_rt.size\n\u003C/code>\u003C/pre>\u003Cp>Let&#39;s write a bit of code to find the \u003Ccode>n\u003C/code> cheapest trips given a date range we want the trip to be during, the minimum number of days the trip should be, and the maximum number of days the trip should be. This code could be optimized by avoiding a lot of unnecessary iteration and using a heap queue. \u003Cem>Note: \u003Ccode>leaving\u003C/code> and \u003Ccode>returning\u003C/code> are \u003Ccode>pandas.DataFrame\u003C/code> objects, not lists.\u003C/em>\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-py\">\u003Cspan class=\"hljs-keyword\">def\u003C/span> \u003Cspan class=\"hljs-title function_\">n_cheapest_trips\u003C/span>(\u003Cspan class=\"hljs-params\">leaving, returning, after, before, min_days=\u003Cspan class=\"hljs-number\">1\u003C/span>, max_days=\u003Cspan class=\"hljs-number\">270\u003C/span>, n=\u003Cspan class=\"hljs-number\">10\u003C/span>\u003C/span>):\n    after = parse(after)\n    before = parse(before)\n    \u003Cspan class=\"hljs-comment\"># a quick lookup map of dates to total costs for returning flights\u003C/span>\n    r_map = {\u003Cspan class=\"hljs-built_in\">str\u003C/span>(d): t \u003Cspan class=\"hljs-keyword\">for\u003C/span> d, t \u003Cspan class=\"hljs-keyword\">in\u003C/span> \u003Cspan class=\"hljs-built_in\">zip\u003C/span>(returning[\u003Cspan class=\"hljs-string\">&#x27;date&#x27;\u003C/span>], returning[\u003Cspan class=\"hljs-string\">&#x27;total&#x27;\u003C/span>])}\n    n_best = []\n\n    \u003Cspan class=\"hljs-comment\"># iterate over each leaving day\u003C/span>\n    \u003Cspan class=\"hljs-keyword\">for\u003C/span> day \u003Cspan class=\"hljs-keyword\">in\u003C/span> leaving.itertuples():\n        \u003Cspan class=\"hljs-comment\"># if the day is not within our date range, skip it\u003C/span>\n        \u003Cspan class=\"hljs-keyword\">if\u003C/span> after &gt; day.date \u003Cspan class=\"hljs-keyword\">or\u003C/span> before &lt; day.date:\n            \u003Cspan class=\"hljs-keyword\">continue\u003C/span>\n\n        \u003Cspan class=\"hljs-comment\"># iterate over each number of days in the min, max range (inclusive)\u003C/span>\n        \u003Cspan class=\"hljs-keyword\">for\u003C/span> days \u003Cspan class=\"hljs-keyword\">in\u003C/span> \u003Cspan class=\"hljs-built_in\">range\u003C/span>(min_days, max_days + \u003Cspan class=\"hljs-number\">1\u003C/span>):\n            \u003Cspan class=\"hljs-comment\"># check if there is a returning flight available on current day + trip length\u003C/span>\n            d = day.date + relativedelta(days=days)\n            \u003Cspan class=\"hljs-keyword\">if\u003C/span> after &gt; d \u003Cspan class=\"hljs-keyword\">or\u003C/span> before &lt; d \u003Cspan class=\"hljs-keyword\">or\u003C/span> \u003Cspan class=\"hljs-built_in\">str\u003C/span>(d) \u003Cspan class=\"hljs-keyword\">not\u003C/span> \u003Cspan class=\"hljs-keyword\">in\u003C/span> r_map:\n                \u003Cspan class=\"hljs-keyword\">continue\u003C/span>\n\n            \u003Cspan class=\"hljs-comment\"># sum of leaving and returning cost\u003C/span>\n            total_cost = day.total + r_map[\u003Cspan class=\"hljs-built_in\">str\u003C/span>(d)]\n            \u003Cspan class=\"hljs-comment\"># update n best items, maintaining length &lt;= n\u003C/span>\n            n_best += [(total_cost, day.date.strftime(\u003Cspan class=\"hljs-string\">&#x27;%Y-%m-%d&#x27;\u003C/span>), d.strftime(\u003Cspan class=\"hljs-string\">&#x27;%Y-%m-%d&#x27;\u003C/span>), days)]\n            n_best = \u003Cspan class=\"hljs-built_in\">sorted\u003C/span>(n_best, key=\u003Cspan class=\"hljs-keyword\">lambda\u003C/span> x: x[\u003Cspan class=\"hljs-number\">0\u003C/span>])\n            n_best = n_best[:n]\n\n    \u003Cspan class=\"hljs-keyword\">return\u003C/span> n_best\n\u003C/code>\u003C/pre>\u003Cp>With this function, we can finally do what our original goal was, which is to find the best priced tickets. Let&#39;s suppose I want a 10 to 20 day trip between March 1, 2024 and May 31, 2024. Here is the result of that, using our round-trip data as input.\u003C/p>\n\u003Cp>\u003Cimg src=\"/premia_7.png\" alt=\"Air Premia best possible tickets given parameters\">\u003C/p>\n\u003Cp>It seems like we have quite a few options that are all $1,078. Let&#39;s see if we get a better price using our one-way data as input. Rather than buying both tickets together, you would have to purchase them separately.\u003C/p>\n\u003Cp>\u003Cimg src=\"/premia_8.png\" alt=\"Air Premia best possible tickets given parameters with one-way data\">\u003C/p>\n\u003Cp>As it turns out, we can actually get tickets for $57 cheaper by just buying two one-way tickets instead of round-trip tickets. I had always assumed that round-trip tickets would be cheaper than two one-way tickets, but I guess that&#39;s not always the case.\u003C/p>\n\u003Cp>Mission complete. I still would like to plot some data so that we can get a sense for when tickets are cheaper and maybe uncover some other interesting patterns.\u003C/p>\n\u003Cp>Let&#39;s import \u003Ca href=\"https://matplotlib.org/\">matplotlib\u003C/a> so that we can do some data visualization. I&#39;m changing the default pyplot size and DPI to make the output wider and higher resolution.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-py\">\u003Cspan class=\"hljs-keyword\">from\u003C/span> matplotlib \u003Cspan class=\"hljs-keyword\">import\u003C/span> pyplot \u003Cspan class=\"hljs-keyword\">as\u003C/span> plt\nplt.rcParams[\u003Cspan class=\"hljs-string\">&#x27;figure.figsize&#x27;\u003C/span>] = (\u003Cspan class=\"hljs-number\">17\u003C/span>, \u003Cspan class=\"hljs-number\">4\u003C/span>)\nplt.rcParams[\u003Cspan class=\"hljs-string\">&#x27;figure.dpi&#x27;\u003C/span>] = \u003Cspan class=\"hljs-number\">200\u003C/span>\n\u003C/code>\u003C/pre>\u003Cp>Let&#39;s start by showing the prices for different days. I&#39;ll split this into two charts. One for one-way trips and another for round-trips. Some of the bars will overlap one another but you can still see the general pattern, which is what we&#39;re after. \u003Cem>Note: the code for round-trip tickets is almost identical.\u003C/em>\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-py\">plt.title(\u003Cspan class=\"hljs-string\">&#x27;USD Cost of One-way Economy Tickets&#x27;\u003C/span>)\nplt.bar(icn_ow[\u003Cspan class=\"hljs-string\">&#x27;date&#x27;\u003C/span>], icn_ow[\u003Cspan class=\"hljs-string\">&#x27;total&#x27;\u003C/span>], color=\u003Cspan class=\"hljs-string\">&#x27;C0&#x27;\u003C/span>, label=\u003Cspan class=\"hljs-string\">&#x27;EWR -&gt; ICN&#x27;\u003C/span>)\nplt.bar(ewr_ow[\u003Cspan class=\"hljs-string\">&#x27;date&#x27;\u003C/span>], ewr_ow[\u003Cspan class=\"hljs-string\">&#x27;total&#x27;\u003C/span>], color=\u003Cspan class=\"hljs-string\">&#x27;C6&#x27;\u003C/span>, label=\u003Cspan class=\"hljs-string\">&#x27;ICN -&gt; EWR&#x27;\u003C/span>)\nplt.legend()\nplt.show()\n\u003C/code>\u003C/pre>\u003Cp>\u003Cimg src=\"/premia_5.png\" alt=\"Air Premia USD Cost of One-way Economy Tickets\">\n\u003Cimg src=\"/premia_6.png\" alt=\"Air Premia USD Cost of Round-trip Economy Tickets\">\u003C/p>\n\u003Cp>Let&#39;s check out what the price difference between one-way and round-trip tickets for the same flight is. We will use the following code which computes \u003Ccode>one way cost - round trip cost\u003C/code>. If this number is positive, that means one-way costs more. If it&#39;s negative, round-trip costs more. \u003Cem>Note: the code for tickets to Newark is almost identical.\u003C/em>\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-py\">plt.title(\u003Cspan class=\"hljs-string\">&#x27;USD Price Difference Between One-way and Round-trip Tickets to Incheon&#x27;\u003C/span>)\nplt.bar(icn_ow[\u003Cspan class=\"hljs-string\">&#x27;date&#x27;\u003C/span>], icn_ow[\u003Cspan class=\"hljs-string\">&#x27;total&#x27;\u003C/span>] - icn_rt[\u003Cspan class=\"hljs-string\">&#x27;total&#x27;\u003C/span>], color=\u003Cspan class=\"hljs-string\">&#x27;C0&#x27;\u003C/span>)\nplt.show()\n\u003C/code>\u003C/pre>\u003Cp>\u003Cimg src=\"/premia_9.png\" alt=\"Air Premia USD Price Difference Between One-way and Round-trip Tickets to Incheon\">\n\u003Cimg src=\"/premia_10.png\" alt=\"Air Premia USD Price Difference Between One-way and Round-trip Tickets to Newark\">\u003C/p>\n\u003Cp>Well now that we have a graphical understanding of the price difference, let&#39;s get a numerical sense for it by taking the mean of the differences.\u003C/p>\n\u003Cpre>\u003Ccode class=\"hljs language-py\">(icn_ow[\u003Cspan class=\"hljs-string\">&#x27;total&#x27;\u003C/span>] - icn_rt[\u003Cspan class=\"hljs-string\">&#x27;total&#x27;\u003C/span>]).mean(), (ewr_ow[\u003Cspan class=\"hljs-string\">&#x27;total&#x27;\u003C/span>] - ewr_rt[\u003Cspan class=\"hljs-string\">&#x27;total&#x27;\u003C/span>]).mean()\n\u003C/code>\u003C/pre>\u003Cp>The result of this is about \u003Ccode>(104.19, -137.54)\u003C/code>. This means that on average, you are saving $104.19 on the tickets to your location by buying round-trip, but you are losing $138.54 on the return tickets. A pair of round-trip tickets is about $33.35 more expensive than two one-way tickets.\u003C/p>\n\u003Ch2>Conclusion\u003C/h2>\n\u003Cp>Congratulations if you&#39;ve made it this far. You must really like data scraping. I hope you&#39;ve enjoyed and that you can take the data and create your own visualizations. As an aside, I did check if there was any price difference between currencies, but they all came out to about the same when converted to USD. Good luck and happy coding.\u003C/p>\n",title:"Finding Cheap Flight Tickets With Python",date:1706727822114,tags:["data","python","scraping"]},{id:"bdtp",content:"{\n\t\"title\": \"Better Done Than Perfect\",\n\t\"date\": 1706634774106,\n\t\"tags\": [\"life\"]\n}\n---\n\nHave you ever thought about making some project, app, post, video, etc. and eventually convinced yourself it's not worth it because it's already been done before and probably better than you ever could? If not, you can stop reading here. If you're like me and you have, then boy, do I have a lot to say about this. Here are three pretty common proverbs that you should always have in mind.\n\n- Perfection is the enemy of good\n- Every expert was once a beginner\n- Comparison is the thief of joy\n\n## Perfection is the enemy of good\nI wish I could give an idea that would guarantee you success/happiness/whatever metric of good. Literally no one can. Some people have better ideas than others, but no matter who you are, most of your ideas will fall flat on their face. As long as you think your idea is good enough and you would enjoy doing it, you gotta see it through.\n\nDon't base your success on the utility or popularity of your implementation. There is a plethora of variables at play for the function that is success, and the idea itself is only a tiny part of it. In general, focus on an idea that actually intrigues you and gives you something to play around with.\n\nDon't be afraid to take on an idea because it's \"too big\". Most of the time, it's really not. You might just be missing one or two pieces of the puzzle. Tackle those challenges first. Suppose you have the idea to build a YouTube clone but you're worried that you won't be able to make a good recommendation algorithm. You're also not sure how you would handle storing files and video processing. You are already a skilled Web Developer who can definitely make most of the frontend and backend but are not sure how to go about those things. What should you do? If you're like me, then these seemingly impossible tasks will constantly linger in your head. All you'll be thinking about is how you should do those two things and keep reading articles on the topic. You look at how other people have tackled the problem before you and find out that there are entire areas of research dedicated to this topic. The complexity is overwhelming. All the while you still haven't written a single line of code. \"Eh, fuck it\", you say, before forgetting about the idea and moving onto your next idea, only to repeat the cycle.\n\nListen. If it's your first time dealing with a recommendation system and video processing, you are not going to do a perfect job. You're probably not even going to do a decent job. And that's OK. Just get it working. Write some basic code to do this so that you can integrate it into the rest of the project later. Focus on the \"impossible\" tasks before moving onto the stuff you're more familiar with. Get a working solution, regardless of how bad it is. Perhaps during your process of making a shitty solution you come up with a slightly better one. You never know until you try.\n\n## Every expert was once a beginner\nIt's very easy to see someone who's particularly good at something and think about how far from them you are. I am a firm believer of the 10,000-hour rule — the basic idea being that it takes about 10,000 hours to become an expert in any field. Think about how much free time you have per week. Based on that, this is how long it would take you to become an expert.\n\n| hrs/week | yrs to reach 10,000 hrs |\n| ---      | ---                     |\n| 10       | 19.2                    |\n| 20       | 9.6                     |\n| 30       | 6.4                     |\n| 40       | 4.8                     |\n| 50       | 3.8                     |\n| 60       | 3.2                     |\n\nThat person who's really good at something probably wouldn't even consider themselves an expert. This is about how long it would take you to be at least as good as them. Don't let their expertise intimidate you. You should strive to learn and improve your own skills. All you have in life is time, so you'd better use it wisely.\n\n## Comparison is the thief of joy\nI'm starting to realise there's a ton of overlap in all these quotes. Look, you need to stop comparing your idea to others' implementations. It's easy to look at other people's implementation of your idea and convince yourself that your version will never be as good. If you want to make a project, just make that project. In the end, you will learn something from it and that's 50x more valuable than whatever you've created. Time on Earth is short, so make the most of it. Whatever project it is you wanted to start on, go start on it. It'll probably suck, but you can always iterate, and you'll always learn something from each iteration.\n\n## Conclusion\n[Take it away, Bobby.](https://www.youtube.com/watch?v=d-diB65scQU)\n",html:"\u003Cp>Have you ever thought about making some project, app, post, video, etc. and eventually convinced yourself it&#39;s not worth it because it&#39;s already been done before and probably better than you ever could? If not, you can stop reading here. If you&#39;re like me and you have, then boy, do I have a lot to say about this. Here are three pretty common proverbs that you should always have in mind.\u003C/p>\n\u003Cul>\n\u003Cli>Perfection is the enemy of good\u003C/li>\n\u003Cli>Every expert was once a beginner\u003C/li>\n\u003Cli>Comparison is the thief of joy\u003C/li>\n\u003C/ul>\n\u003Ch2>Perfection is the enemy of good\u003C/h2>\n\u003Cp>I wish I could give an idea that would guarantee you success/happiness/whatever metric of good. Literally no one can. Some people have better ideas than others, but no matter who you are, most of your ideas will fall flat on their face. As long as you think your idea is good enough and you would enjoy doing it, you gotta see it through.\u003C/p>\n\u003Cp>Don&#39;t base your success on the utility or popularity of your implementation. There is a plethora of variables at play for the function that is success, and the idea itself is only a tiny part of it. In general, focus on an idea that actually intrigues you and gives you something to play around with.\u003C/p>\n\u003Cp>Don&#39;t be afraid to take on an idea because it&#39;s &quot;too big&quot;. Most of the time, it&#39;s really not. You might just be missing one or two pieces of the puzzle. Tackle those challenges first. Suppose you have the idea to build a YouTube clone but you&#39;re worried that you won&#39;t be able to make a good recommendation algorithm. You&#39;re also not sure how you would handle storing files and video processing. You are already a skilled Web Developer who can definitely make most of the frontend and backend but are not sure how to go about those things. What should you do? If you&#39;re like me, then these seemingly impossible tasks will constantly linger in your head. All you&#39;ll be thinking about is how you should do those two things and keep reading articles on the topic. You look at how other people have tackled the problem before you and find out that there are entire areas of research dedicated to this topic. The complexity is overwhelming. All the while you still haven&#39;t written a single line of code. &quot;Eh, fuck it&quot;, you say, before forgetting about the idea and moving onto your next idea, only to repeat the cycle.\u003C/p>\n\u003Cp>Listen. If it&#39;s your first time dealing with a recommendation system and video processing, you are not going to do a perfect job. You&#39;re probably not even going to do a decent job. And that&#39;s OK. Just get it working. Write some basic code to do this so that you can integrate it into the rest of the project later. Focus on the &quot;impossible&quot; tasks before moving onto the stuff you&#39;re more familiar with. Get a working solution, regardless of how bad it is. Perhaps during your process of making a shitty solution you come up with a slightly better one. You never know until you try.\u003C/p>\n\u003Ch2>Every expert was once a beginner\u003C/h2>\n\u003Cp>It&#39;s very easy to see someone who&#39;s particularly good at something and think about how far from them you are. I am a firm believer of the 10,000-hour rule — the basic idea being that it takes about 10,000 hours to become an expert in any field. Think about how much free time you have per week. Based on that, this is how long it would take you to become an expert.\u003C/p>\n\u003Ctable>\n\u003Cthead>\n\u003Ctr>\n\u003Cth>hrs/week\u003C/th>\n\u003Cth>yrs to reach 10,000 hrs\u003C/th>\n\u003C/tr>\n\u003C/thead>\n\u003Ctbody>\u003Ctr>\n\u003Ctd>10\u003C/td>\n\u003Ctd>19.2\u003C/td>\n\u003C/tr>\n\u003Ctr>\n\u003Ctd>20\u003C/td>\n\u003Ctd>9.6\u003C/td>\n\u003C/tr>\n\u003Ctr>\n\u003Ctd>30\u003C/td>\n\u003Ctd>6.4\u003C/td>\n\u003C/tr>\n\u003Ctr>\n\u003Ctd>40\u003C/td>\n\u003Ctd>4.8\u003C/td>\n\u003C/tr>\n\u003Ctr>\n\u003Ctd>50\u003C/td>\n\u003Ctd>3.8\u003C/td>\n\u003C/tr>\n\u003Ctr>\n\u003Ctd>60\u003C/td>\n\u003Ctd>3.2\u003C/td>\n\u003C/tr>\n\u003C/tbody>\u003C/table>\n\u003Cp>That person who&#39;s really good at something probably wouldn&#39;t even consider themselves an expert. This is about how long it would take you to be at least as good as them. Don&#39;t let their expertise intimidate you. You should strive to learn and improve your own skills. All you have in life is time, so you&#39;d better use it wisely.\u003C/p>\n\u003Ch2>Comparison is the thief of joy\u003C/h2>\n\u003Cp>I&#39;m starting to realise there&#39;s a ton of overlap in all these quotes. Look, you need to stop comparing your idea to others&#39; implementations. It&#39;s easy to look at other people&#39;s implementation of your idea and convince yourself that your version will never be as good. If you want to make a project, just make that project. In the end, you will learn something from it and that&#39;s 50x more valuable than whatever you&#39;ve created. Time on Earth is short, so make the most of it. Whatever project it is you wanted to start on, go start on it. It&#39;ll probably suck, but you can always iterate, and you&#39;ll always learn something from each iteration.\u003C/p>\n\u003Ch2>Conclusion\u003C/h2>\n\u003Cp>\u003Ca href=\"https://www.youtube.com/watch?v=d-diB65scQU\">Take it away, Bobby.\u003C/a>\u003C/p>\n",title:"Better Done Than Perfect",date:1706634774106,tags:["life"]},{id:"me",content:"{\n\t\"title\": \"Who is Angelo Lloti?\",\n\t\"date\": 1706565915390,\n\t\"tags\": [\"life\", \"self\"]\n}\n---\n\nThanks for asking. My name's Angelo. My favorite color is purple. My birthday is December 1st. I like the following things.\n\n- Bicycles (repairing and riding)\n- Caffeine\n- Computers (building, fixing, and using)\n- Mathematics (mostly number theory)\n- Solving Pointless Problems \\(Advent of Code, Codeforces, Leetcode, Project Euler\\)\n- Teaching (mainly through YouTube videos)\n- Web Scraping\n\nI like other things too; these are just the main ones.\n\n## Games\nI used to play video games a lot. I don't really play them any more. In case you play/have played games, here is a list of my top 5.\n\n#### #5: Bloons TD 1 through 6 (151 hours on Steam, many more on mobile)\nI have played this game on Cool Math Games in elementary school all the way through college. Isn't it just great watching monkeys throw darts at ballons?\n\n#### #4: Grand Theft Auto V (968 hours on Steam, ~200 hours on Xbox 360)\nSuper fun story mode. Super fun online mode. It's hard not to love this game.\n\n#### #3: Minecraft (countless hours)\nMy childhood was basically just Minecraft and my time spent with friends on this game. It's a great game that encouraged me to be more creative. It also introduced me to hosting my own game server and using a command line.\n\n#### #2: Counter-Strike: Global Offensive (2,088 hours on Steam)\nI have way too many hours on this game. It would be strange if it wasn't in my top 5. There are so many areas to improve upon in this game (aiming, movement, communication, utility usage, economy) and so many community servers and game modes that you can spend hundreds or maye even thousands of hours on (like I have done).\n\n#### #1: Terraria (628 hours on Steam)\nTerraria is a sick fucking game. You can ride a unicorn, shoot a rainbow gun, invert your screen, and fight Cthulu all at the same time. The amount of bosses in this game is great and if you ever by the slightest chance get bored of the game's base content, the mods are even more incredible. Such a fun game with so many good memories.\n\n## What I Mostly Do\nI write code. The result of that code is usually in the form of a webpage like the one you see right now. Sometimes it's a [chat bot](https://github.com/xDimGG/starboard) which you can interact with through Discord. Sometimes it's a [Tampermonkey script](https://github.com/xDimGG/xdimgg.github.io/blob/master/remove-youtube-end-cards/endcard.user.js) that modifies your webpage. Sometimes it's an [NPM package](https://www.npmjs.com/package/steamapi) that conveniently wraps an API for you. Sometimes it's code that [solves a problem](https://github.com/xDimGG/aoc-solutions). Sometimes it's [code](https://gist.github.com/xDimGG/cc5d80bb2512f2525dd9f52fe4749a32) that scrapes an airline site and gets the best prices for a round flight in a range of dates. Sometimes it's a [GitHub Action](https://recurse-eats.dim.codes/) with a cron task that scrapes Uber eats for BOGO deals in some particular area.\n\n## Bikes\nI like taking things apart and putting them back together. Sometimes I break that thing in the process. I had a fairly rusty 6-year-old mountain bike that was left out in the rain for many college semesters. Here it is after I took it apart, removed a bunch of rust, spray painted some bits, and gave it some new grease, handlebars, pedals, and a chain.\n\n![my mountain bike after repairing it](/me_1.jpeg)\n\nI managed to strip all the threads in both crank arms, lose a cable routing plastic bit, and lose a spring in the process. Patched it up with duct tape and the bike rides well. If you need a mechanic, hit me up.\n\n## Computers\nI got into building computers because I wanted to play computer games but I was only 11 so I didn't have much money. I explicitly asked my family not to buy me presents and instead to only give me money. Having 6 aunts meant that I was sure to be rich. Thanks to Linus Tech Tips, after collecting a healthy $600, I ordered all the parts that fit my budget. I got myself a brand spanking new R9 380 GPU, an i5-6500 CPU, and [some other parts](https://pcpartpicker.com/user/DimMagician00/saved/#view=PPmMnQ). That's right, a whole 4GB of VRAM. Certainly enough to run Minecraft and CS:GO. With Linus Sebastian by my side, I was able to put together a beast of a computer that would serve me for years to come. In fact, I still use that same graphics card in my PC 9 years later.\n\n## Teaching\nI've always liked teaching. I don't really have much public content to show for it; mostly just one-on-ones. I have a [YouTube channel](https://www.youtube.com/channel/UCshYVJHJid6Eniih46Ov5QQ) where I sometimes upload coding tutorials.\n\n## Mathematics\nI've always had good grades in math class. This led me to pay attention since I felt like it was the only subject I could understand. Or maybe I understood it because it was the only subject I paid attention in. Who knows. Chicken and egg. I like doing math problems from time to time and have recently done a lot of [Project Euler](https://projecteuler.net/) problems.\n\n## Conclusion\nI hope you've enjoyed my ramblings and now know a bit more about me. To summarize, I like solving problems, be it mechanical, mathematical, or computational ones. If I don't understand something, I strive to understand it eventually. I have my vices like caffeine and YouTube. I want to know why we exist and how we got here. I want to learn everything but am aware that humans don't live long enough to do that. Anyways, thanks for reading. Bye for now 👋\n",html:"\u003Cp>Thanks for asking. My name&#39;s Angelo. My favorite color is purple. My birthday is December 1st. I like the following things.\u003C/p>\n\u003Cul>\n\u003Cli>Bicycles (repairing and riding)\u003C/li>\n\u003Cli>Caffeine\u003C/li>\n\u003Cli>Computers (building, fixing, and using)\u003C/li>\n\u003Cli>Mathematics (mostly number theory)\u003C/li>\n\u003Cli>Solving Pointless Problems (Advent of Code, Codeforces, Leetcode, Project Euler)\u003C/li>\n\u003Cli>Teaching (mainly through YouTube videos)\u003C/li>\n\u003Cli>Web Scraping\u003C/li>\n\u003C/ul>\n\u003Cp>I like other things too; these are just the main ones.\u003C/p>\n\u003Ch2>Games\u003C/h2>\n\u003Cp>I used to play video games a lot. I don&#39;t really play them any more. In case you play/have played games, here is a list of my top 5.\u003C/p>\n\u003Ch4>#5: Bloons TD 1 through 6 (151 hours on Steam, many more on mobile)\u003C/h4>\n\u003Cp>I have played this game on Cool Math Games in elementary school all the way through college. Isn&#39;t it just great watching monkeys throw darts at ballons?\u003C/p>\n\u003Ch4>#4: Grand Theft Auto V (968 hours on Steam, ~200 hours on Xbox 360)\u003C/h4>\n\u003Cp>Super fun story mode. Super fun online mode. It&#39;s hard not to love this game.\u003C/p>\n\u003Ch4>#3: Minecraft (countless hours)\u003C/h4>\n\u003Cp>My childhood was basically just Minecraft and my time spent with friends on this game. It&#39;s a great game that encouraged me to be more creative. It also introduced me to hosting my own game server and using a command line.\u003C/p>\n\u003Ch4>#2: Counter-Strike: Global Offensive (2,088 hours on Steam)\u003C/h4>\n\u003Cp>I have way too many hours on this game. It would be strange if it wasn&#39;t in my top 5. There are so many areas to improve upon in this game (aiming, movement, communication, utility usage, economy) and so many community servers and game modes that you can spend hundreds or maye even thousands of hours on (like I have done).\u003C/p>\n\u003Ch4>#1: Terraria (628 hours on Steam)\u003C/h4>\n\u003Cp>Terraria is a sick fucking game. You can ride a unicorn, shoot a rainbow gun, invert your screen, and fight Cthulu all at the same time. The amount of bosses in this game is great and if you ever by the slightest chance get bored of the game&#39;s base content, the mods are even more incredible. Such a fun game with so many good memories.\u003C/p>\n\u003Ch2>What I Mostly Do\u003C/h2>\n\u003Cp>I write code. The result of that code is usually in the form of a webpage like the one you see right now. Sometimes it&#39;s a \u003Ca href=\"https://github.com/xDimGG/starboard\">chat bot\u003C/a> which you can interact with through Discord. Sometimes it&#39;s a \u003Ca href=\"https://github.com/xDimGG/xdimgg.github.io/blob/master/remove-youtube-end-cards/endcard.user.js\">Tampermonkey script\u003C/a> that modifies your webpage. Sometimes it&#39;s an \u003Ca href=\"https://www.npmjs.com/package/steamapi\">NPM package\u003C/a> that conveniently wraps an API for you. Sometimes it&#39;s code that \u003Ca href=\"https://github.com/xDimGG/aoc-solutions\">solves a problem\u003C/a>. Sometimes it&#39;s \u003Ca href=\"https://gist.github.com/xDimGG/cc5d80bb2512f2525dd9f52fe4749a32\">code\u003C/a> that scrapes an airline site and gets the best prices for a round flight in a range of dates. Sometimes it&#39;s a \u003Ca href=\"https://recurse-eats.dim.codes/\">GitHub Action\u003C/a> with a cron task that scrapes Uber eats for BOGO deals in some particular area.\u003C/p>\n\u003Ch2>Bikes\u003C/h2>\n\u003Cp>I like taking things apart and putting them back together. Sometimes I break that thing in the process. I had a fairly rusty 6-year-old mountain bike that was left out in the rain for many college semesters. Here it is after I took it apart, removed a bunch of rust, spray painted some bits, and gave it some new grease, handlebars, pedals, and a chain.\u003C/p>\n\u003Cp>\u003Cimg src=\"/me_1.jpeg\" alt=\"my mountain bike after repairing it\">\u003C/p>\n\u003Cp>I managed to strip all the threads in both crank arms, lose a cable routing plastic bit, and lose a spring in the process. Patched it up with duct tape and the bike rides well. If you need a mechanic, hit me up.\u003C/p>\n\u003Ch2>Computers\u003C/h2>\n\u003Cp>I got into building computers because I wanted to play computer games but I was only 11 so I didn&#39;t have much money. I explicitly asked my family not to buy me presents and instead to only give me money. Having 6 aunts meant that I was sure to be rich. Thanks to Linus Tech Tips, after collecting a healthy $600, I ordered all the parts that fit my budget. I got myself a brand spanking new R9 380 GPU, an i5-6500 CPU, and \u003Ca href=\"https://pcpartpicker.com/user/DimMagician00/saved/#view=PPmMnQ\">some other parts\u003C/a>. That&#39;s right, a whole 4GB of VRAM. Certainly enough to run Minecraft and CS:GO. With Linus Sebastian by my side, I was able to put together a beast of a computer that would serve me for years to come. In fact, I still use that same graphics card in my PC 9 years later.\u003C/p>\n\u003Ch2>Teaching\u003C/h2>\n\u003Cp>I&#39;ve always liked teaching. I don&#39;t really have much public content to show for it; mostly just one-on-ones. I have a \u003Ca href=\"https://www.youtube.com/channel/UCshYVJHJid6Eniih46Ov5QQ\">YouTube channel\u003C/a> where I sometimes upload coding tutorials.\u003C/p>\n\u003Ch2>Mathematics\u003C/h2>\n\u003Cp>I&#39;ve always had good grades in math class. This led me to pay attention since I felt like it was the only subject I could understand. Or maybe I understood it because it was the only subject I paid attention in. Who knows. Chicken and egg. I like doing math problems from time to time and have recently done a lot of \u003Ca href=\"https://projecteuler.net/\">Project Euler\u003C/a> problems.\u003C/p>\n\u003Ch2>Conclusion\u003C/h2>\n\u003Cp>I hope you&#39;ve enjoyed my ramblings and now know a bit more about me. To summarize, I like solving problems, be it mechanical, mathematical, or computational ones. If I don&#39;t understand something, I strive to understand it eventually. I have my vices like caffeine and YouTube. I want to know why we exist and how we got here. I want to learn everything but am aware that humans don&#39;t live long enough to do that. Anyways, thanks for reading. Bye for now 👋\u003C/p>\n",title:"Who is Angelo Lloti?",date:1706565915390,tags:["life","self"]}]},"uses":{}}];

					Promise.all([
						import("../_app/immutable/entry/start.08ee98e4.js"),
						import("../_app/immutable/entry/app.515171e9.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 3],
							data,
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
